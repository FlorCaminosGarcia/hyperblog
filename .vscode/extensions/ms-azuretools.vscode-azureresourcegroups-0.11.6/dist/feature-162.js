/*! For license information please see feature-162.js.LICENSE.txt */
exports.id=162,exports.ids=[162],exports.modules={3162:(e,t,r)=>{"use strict";r.d(t,{ClientAssertionCredential:()=>ClientAssertionCredential});const n={LIBRARY_NAME:"MSAL.JS",SKU:"msal.js.common",CACHE_PREFIX:"msal",DEFAULT_AUTHORITY:"https://login.microsoftonline.com/common/",DEFAULT_AUTHORITY_HOST:"login.microsoftonline.com",DEFAULT_COMMON_TENANT:"common",ADFS:"adfs",DSTS:"dstsv2",AAD_INSTANCE_DISCOVERY_ENDPT:"https://login.microsoftonline.com/common/discovery/instance?api-version=1.1&authorization_endpoint=",CIAM_AUTH_URL:".ciamlogin.com",AAD_TENANT_DOMAIN_SUFFIX:".onmicrosoft.com",RESOURCE_DELIM:"|",NO_ACCOUNT:"NO_ACCOUNT",CLAIMS:"claims",CONSUMER_UTID:"9188040d-6c67-4c5b-b112-36a304b66dad",OPENID_SCOPE:"openid",PROFILE_SCOPE:"profile",OFFLINE_ACCESS_SCOPE:"offline_access",EMAIL_SCOPE:"email",CODE_RESPONSE_TYPE:"code",CODE_GRANT_TYPE:"authorization_code",RT_GRANT_TYPE:"refresh_token",FRAGMENT_RESPONSE_MODE:"fragment",S256_CODE_CHALLENGE_METHOD:"S256",URL_FORM_CONTENT_TYPE:"application/x-www-form-urlencoded;charset=utf-8",AUTHORIZATION_PENDING:"authorization_pending",NOT_DEFINED:"not_defined",EMPTY_STRING:"",NOT_APPLICABLE:"N/A",FORWARD_SLASH:"/",IMDS_ENDPOINT:"http://169.254.169.254/metadata/instance/compute/location",IMDS_VERSION:"2020-06-01",IMDS_TIMEOUT:2e3,AZURE_REGION_AUTO_DISCOVER_FLAG:"TryAutoDetect",REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX:"login.microsoft.com",KNOWN_PUBLIC_CLOUDS:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"],TOKEN_RESPONSE_TYPE:"token",ID_TOKEN_RESPONSE_TYPE:"id_token",SHR_NONCE_VALIDITY:240,INVALID_INSTANCE:"invalid_instance"},o=200,i=200,a=299,s=400,c=499,l=500,u=500,d=599,h=[n.OPENID_SCOPE,n.PROFILE_SCOPE,n.OFFLINE_ACCESS_SCOPE],p=[...h,n.EMAIL_SCOPE],g="Content-Type",f="Retry-After",m="X-AnchorMailbox",y="x-ms-request-id",C="x-ms-httpver",A={COMMON:"common",ORGANIZATIONS:"organizations",CONSUMERS:"consumers"},T="access_token",S="xms_cc",I={LOGIN:"login",SELECT_ACCOUNT:"select_account",CONSENT:"consent",NONE:"none",CREATE:"create",NO_SESSION:"no_session"},E={PLAIN:"plain",S256:"S256"},w={QUERY:"query",FRAGMENT:"fragment",FORM_POST:"form_post"},v="authorization_code",k="client_credentials",b="password",_="refresh_token",R="urn:ietf:params:oauth:grant-type:jwt-bearer",O="MSSTS",P="ADFS",M="Generic",N="-",U=".",x={ID_TOKEN:"IdToken",ACCESS_TOKEN:"AccessToken",ACCESS_TOKEN_WITH_AUTH_SCHEME:"AccessToken_With_AuthScheme",REFRESH_TOKEN:"RefreshToken"},q="appmetadata",H="1",D="authority-metadata",L=86400,j="config",F="cache",K="network",B="hardcoded_values",$={SCHEMA_VERSION:5,MAX_CUR_HEADER_BYTES:80,MAX_LAST_HEADER_BYTES:330,MAX_CACHED_ERRORS:50,CACHE_KEY:"server-telemetry",CATEGORY_SEPARATOR:"|",VALUE_SEPARATOR:",",OVERFLOW_TRUE:"1",OVERFLOW_FALSE:"0",UNKNOWN_ERROR:"unknown_error"},z={BEARER:"Bearer",POP:"pop",SSH:"ssh-cert"},G=60,V=3600,Y="throttling",W="retry-after, h429",Q="invalid_grant",J="client_mismatch",Z="username",X="password",ee=200,te=400,re="1",ne="3",oe="4",ie="2",ae="4",se="5",ce="0",le="1",ue="2",de="3",he="4",pe="AZURE_POD_IDENTITY_AUTHORITY_HOST",ge="IDENTITY_ENDPOINT",fe="IMDS_ENDPOINT",me="MSI_ENDPOINT",ye="user-assigned-client-id",Ce="user-assigned-resource-id",Ae="user-assigned-object-id",Te="get",Se="post",Ie={SUCCESS:o,SUCCESS_RANGE_START:i,SUCCESS_RANGE_END:a,SERVER_ERROR:l},Ee="sha256",we="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",ve="msal.js.node",ke="urn:ietf:params:oauth:client-assertion-type:jwt-bearer",be="authorization_pending",_e=62,Re=371,Oe=771,Pe=871,Me=872,Ne="RS256",Ue="aud",xe="exp",qe="iss",He="sub",De="nbf",Le="jti";class AuthError extends Error{constructor(e,t,r){super(t?`${e}: ${t}`:e),Object.setPrototypeOf(this,AuthError.prototype),this.errorCode=e||n.EMPTY_STRING,this.errorMessage=t||n.EMPTY_STRING,this.subError=r||n.EMPTY_STRING,this.name="AuthError"}setCorrelationId(e){this.correlationId=e}}class ServerError extends AuthError{constructor(e,t,r,n){super(e,t,r),this.name="ServerError",this.errorNo=n,Object.setPrototypeOf(this,ServerError.prototype)}}var je;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Trace=4]="Trace"}(je||(je={}));class Logger_Logger{constructor(e,t,r){this.level=je.Info;const o=e||Logger_Logger.createDefaultLoggerOptions();this.localCallback=o.loggerCallback||(()=>{}),this.piiLoggingEnabled=o.piiLoggingEnabled||!1,this.level="number"==typeof o.logLevel?o.logLevel:je.Info,this.correlationId=o.correlationId||n.EMPTY_STRING,this.packageName=t||n.EMPTY_STRING,this.packageVersion=r||n.EMPTY_STRING}static createDefaultLoggerOptions(){return{loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:je.Info}}clone(e,t,r){return new Logger_Logger({loggerCallback:this.localCallback,piiLoggingEnabled:this.piiLoggingEnabled,logLevel:this.level,correlationId:r||this.correlationId},e,t)}logMessage(e,t){if(t.logLevel>this.level||!this.piiLoggingEnabled&&t.containsPii)return;const r=`${`[${(new Date).toUTCString()}] : [${t.correlationId||this.correlationId||""}]`} : ${this.packageName}@${this.packageVersion} : ${je[t.logLevel]} - ${e}`;this.executeCallback(t.logLevel,r,t.containsPii||!1)}executeCallback(e,t,r){this.localCallback&&this.localCallback(e,t,r)}error(e,t){this.logMessage(e,{logLevel:je.Error,containsPii:!1,correlationId:t||n.EMPTY_STRING})}errorPii(e,t){this.logMessage(e,{logLevel:je.Error,containsPii:!0,correlationId:t||n.EMPTY_STRING})}warning(e,t){this.logMessage(e,{logLevel:je.Warning,containsPii:!1,correlationId:t||n.EMPTY_STRING})}warningPii(e,t){this.logMessage(e,{logLevel:je.Warning,containsPii:!0,correlationId:t||n.EMPTY_STRING})}info(e,t){this.logMessage(e,{logLevel:je.Info,containsPii:!1,correlationId:t||n.EMPTY_STRING})}infoPii(e,t){this.logMessage(e,{logLevel:je.Info,containsPii:!0,correlationId:t||n.EMPTY_STRING})}verbose(e,t){this.logMessage(e,{logLevel:je.Verbose,containsPii:!1,correlationId:t||n.EMPTY_STRING})}verbosePii(e,t){this.logMessage(e,{logLevel:je.Verbose,containsPii:!0,correlationId:t||n.EMPTY_STRING})}trace(e,t){this.logMessage(e,{logLevel:je.Trace,containsPii:!1,correlationId:t||n.EMPTY_STRING})}tracePii(e,t){this.logMessage(e,{logLevel:je.Trace,containsPii:!0,correlationId:t||n.EMPTY_STRING})}isPiiLoggingEnabled(){return this.piiLoggingEnabled||!1}}const Fe=0,Ke=1,Be=2,$e=3;const ze="redirect_uri_empty",Ge="claims_request_parsing_error",Ve="authority_uri_insecure",Ye="url_parse_error",We="empty_url_error",Qe="empty_input_scopes_error",Je="invalid_prompt_value",Ze="invalid_claims",Xe="token_request_empty",et="logout_request_empty",tt="invalid_code_challenge_method",rt="pkce_params_missing",nt="invalid_cloud_discovery_metadata",ot="invalid_authority_metadata",it="untrusted_authority",at="missing_ssh_jwk",st="missing_ssh_kid",ct="missing_nonce_authentication_header",lt="invalid_authentication_header",ut="cannot_set_OIDCOptions",dt="cannot_allow_native_broker",ht="authority_mismatch",pt={[ze]:"A redirect URI is required for all calls, and none has been set.",[Ge]:"Could not parse the given claims request object.",[Ve]:"Authority URIs must use https.  Please see here for valid authority configuration options: https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications#configuration-options",[Ye]:"URL could not be parsed into appropriate segments.",[We]:"URL was empty or null.",[Qe]:"Scopes cannot be passed as null, undefined or empty array because they are required to obtain an access token.",[Je]:"Please see here for valid configuration options: https://azuread.github.io/microsoft-authentication-library-for-js/ref/modules/_azure_msal_common.html#commonauthorizationurlrequest",[Ze]:"Given claims parameter must be a stringified JSON object.",[Xe]:"Token request was empty and not found in cache.",[et]:"The logout request was null or undefined.",[tt]:'code_challenge_method passed is invalid. Valid values are "plain" and "S256".',[rt]:"Both params: code_challenge and code_challenge_method are to be passed if to be sent in the request",[nt]:"Invalid cloudDiscoveryMetadata provided. Must be a stringified JSON object containing tenant_discovery_endpoint and metadata fields",[ot]:"Invalid authorityMetadata provided. Must by a stringified JSON object containing authorization_endpoint, token_endpoint, issuer fields.",[it]:"The provided authority is not a trusted authority. Please include this authority in the knownAuthorities config parameter.",[at]:"Missing sshJwk in SSH certificate request. A stringified JSON Web Key is required when using the SSH authentication scheme.",[st]:"Missing sshKid in SSH certificate request. A string that uniquely identifies the public SSH key is required when using the SSH authentication scheme.",[ct]:"Unable to find an authentication header containing server nonce. Either the Authentication-Info or WWW-Authenticate headers must be present in order to obtain a server nonce.",[lt]:"Invalid authentication header provided",[ut]:"Cannot set OIDCOptions parameter. Please change the protocol mode to OIDC or use a non-Microsoft authority.",[dt]:"Cannot set allowNativeBroker parameter to true when not in AAD protocol mode.",[ht]:"Authority mismatch error. Authority provided in login request or PublicClientApplication config does not match the environment of the provided account. Please use a matching account or make an interactive request to login to this authority."};class ClientConfigurationError extends AuthError{constructor(e){super(e,pt[e]),this.name="ClientConfigurationError",Object.setPrototypeOf(this,ClientConfigurationError.prototype)}}function ClientConfigurationError_createClientConfigurationError(e){return new ClientConfigurationError(e)}class StringUtils{static isEmptyObj(e){if(e)try{const t=JSON.parse(e);return 0===Object.keys(t).length}catch(e){}return!0}static startsWith(e,t){return 0===e.indexOf(t)}static endsWith(e,t){return e.length>=t.length&&e.lastIndexOf(t)===e.length-t.length}static queryStringToObject(e){const t={},r=e.split("&"),decode=e=>decodeURIComponent(e.replace(/\+/g," "));return r.forEach((e=>{if(e.trim()){const[r,n]=e.split(/=(.+)/g,2);r&&n&&(t[decode(r)]=decode(n))}})),t}static trimArrayEntries(e){return e.map((e=>e.trim()))}static removeEmptyStringsFromArray(e){return e.filter((e=>!!e))}static jsonParseHelper(e){try{return JSON.parse(e)}catch(e){return null}}static matchPattern(e,t){return new RegExp(e.replace(/\\/g,"\\\\").replace(/\*/g,"[^ ]*").replace(/\?/g,"\\?")).test(t)}}const gt="client_info_decoding_error",ft="client_info_empty_error",mt="token_parsing_error",yt="null_or_empty_token",Ct="endpoints_resolution_error",At="network_error",Tt="openid_config_error",St="hash_not_deserialized",It="invalid_state",Et="state_mismatch",wt="state_not_found",vt="nonce_mismatch",kt="auth_time_not_found",bt="max_age_transpired",_t="multiple_matching_tokens",Rt="multiple_matching_accounts",Ot="multiple_matching_appMetadata",Pt="request_cannot_be_made",Mt="cannot_remove_empty_scope",Nt="cannot_append_scopeset",Ut="empty_input_scopeset",xt="device_code_polling_cancelled",qt="device_code_expired",Ht="device_code_unknown_error",Dt="no_account_in_silent_request",Lt="invalid_cache_record",jt="invalid_cache_environment",Ft="no_account_found",Kt="no_crypto_object",Bt="unexpected_credential_type",$t="invalid_assertion",zt="invalid_client_credential",Gt="token_refresh_required",Vt="user_timeout_reached",Yt="token_claims_cnf_required_for_signedjwt",Wt="authorization_code_missing_from_server_response",Qt="binding_key_not_removed",Jt="end_session_endpoint_not_supported",Zt="key_id_missing",Xt="no_network_connectivity",er="user_canceled",tr="missing_tenant_id_error",rr="method_not_implemented",nr="nested_app_auth_bridge_disabled",or={[gt]:"The client info could not be parsed/decoded correctly",[ft]:"The client info was empty",[mt]:"Token cannot be parsed",[yt]:"The token is null or empty",[Ct]:"Endpoints cannot be resolved",[At]:"Network request failed",[Tt]:"Could not retrieve endpoints. Check your authority and verify the .well-known/openid-configuration endpoint returns the required endpoints.",[St]:"The hash parameters could not be deserialized",[It]:"State was not the expected format",[Et]:"State mismatch error",[wt]:"State not found",[vt]:"Nonce mismatch error",[kt]:"Max Age was requested and the ID token is missing the auth_time variable. auth_time is an optional claim and is not enabled by default - it must be enabled. See https://aka.ms/msaljs/optional-claims for more information.",[bt]:"Max Age is set to 0, or too much time has elapsed since the last end-user authentication.",[_t]:"The cache contains multiple tokens satisfying the requirements. Call AcquireToken again providing more requirements such as authority or account.",[Rt]:"The cache contains multiple accounts satisfying the given parameters. Please pass more info to obtain the correct account",[Ot]:"The cache contains multiple appMetadata satisfying the given parameters. Please pass more info to obtain the correct appMetadata",[Pt]:"Token request cannot be made without authorization code or refresh token.",[Mt]:"Cannot remove null or empty scope from ScopeSet",[Nt]:"Cannot append ScopeSet",[Ut]:"Empty input ScopeSet cannot be processed",[xt]:"Caller has cancelled token endpoint polling during device code flow by setting DeviceCodeRequest.cancel = true.",[qt]:"Device code is expired.",[Ht]:"Device code stopped polling for unknown reasons.",[Dt]:"Please pass an account object, silent flow is not supported without account information",[Lt]:"Cache record object was null or undefined.",[jt]:"Invalid environment when attempting to create cache entry",[Ft]:"No account found in cache for given key.",[Kt]:"No crypto object detected.",[Bt]:"Unexpected credential type.",[$t]:"Client assertion must meet requirements described in https://tools.ietf.org/html/rfc7515",[zt]:"Client credential (secret, certificate, or assertion) must not be empty when creating a confidential client. An application should at most have one credential",[Gt]:"Cannot return token from cache because it must be refreshed. This may be due to one of the following reasons: forceRefresh parameter is set to true, claims have been requested, there is no cached access token or it is expired.",[Vt]:"User defined timeout for device code polling reached",[Yt]:"Cannot generate a POP jwt if the token_claims are not populated",[Wt]:"Server response does not contain an authorization code to proceed",[Qt]:"Could not remove the credential's binding key from storage.",[Jt]:"The provided authority does not support logout",[Zt]:"A keyId value is missing from the requested bound token's cache record and is required to match the token to it's stored binding key.",[Xt]:"No network connectivity. Check your internet connection.",[er]:"User cancelled the flow.",[tr]:"A tenant id - not common, organizations, or consumers - must be specified when using the client_credentials flow.",[rr]:"This method has not been implemented",[nr]:"The nested app auth bridge is disabled"};class ClientAuthError extends AuthError{constructor(e,t){super(e,t?`${or[e]}: ${t}`:or[e]),this.name="ClientAuthError",Object.setPrototypeOf(this,ClientAuthError.prototype)}}function createClientAuthError(e,t){return new ClientAuthError(e,t)}function getDeserializedResponse(e){if(!e||e.indexOf("=")<0)return null;try{const t=function stripLeadingHashOrQuery(e){return e.startsWith("#/")?e.substring(2):e.startsWith("#")||e.startsWith("?")?e.substring(1):e}(e),r=Object.fromEntries(new URLSearchParams(t));if(r.code||r.error||r.error_description||r.state)return r}catch(e){throw createClientAuthError(St)}return null}class UrlString{get urlString(){return this._urlString}constructor(e){if(this._urlString=e,!this._urlString)throw ClientConfigurationError_createClientConfigurationError(We);e.includes("#")||(this._urlString=UrlString.canonicalizeUri(e))}static canonicalizeUri(e){if(e){let t=e.toLowerCase();return StringUtils.endsWith(t,"?")?t=t.slice(0,-1):StringUtils.endsWith(t,"?/")&&(t=t.slice(0,-2)),StringUtils.endsWith(t,"/")||(t+="/"),t}return e}validateAsUri(){let e;try{e=this.getUrlComponents()}catch(e){throw ClientConfigurationError_createClientConfigurationError(Ye)}if(!e.HostNameAndPort||!e.PathSegments)throw ClientConfigurationError_createClientConfigurationError(Ye);if(!e.Protocol||"https:"!==e.Protocol.toLowerCase())throw ClientConfigurationError_createClientConfigurationError(Ve)}static appendQueryString(e,t){return t?e.indexOf("?")<0?`${e}?${t}`:`${e}&${t}`:e}static removeHashFromUrl(e){return UrlString.canonicalizeUri(e.split("#")[0])}replaceTenantPath(e){const t=this.getUrlComponents(),r=t.PathSegments;return!e||0===r.length||r[0]!==A.COMMON&&r[0]!==A.ORGANIZATIONS||(r[0]=e),UrlString.constructAuthorityUriFromObject(t)}getUrlComponents(){const e=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),t=this.urlString.match(e);if(!t)throw ClientConfigurationError_createClientConfigurationError(Ye);const r={Protocol:t[1],HostNameAndPort:t[4],AbsolutePath:t[5],QueryString:t[7]};let n=r.AbsolutePath.split("/");return n=n.filter((e=>e&&e.length>0)),r.PathSegments=n,r.QueryString&&r.QueryString.endsWith("/")&&(r.QueryString=r.QueryString.substring(0,r.QueryString.length-1)),r}static getDomainFromUrl(e){const t=RegExp("^([^:/?#]+://)?([^/?#]*)"),r=e.match(t);if(!r)throw ClientConfigurationError_createClientConfigurationError(Ye);return r[2]}static getAbsoluteUrl(e,t){if(e[0]===n.FORWARD_SLASH){const r=new UrlString(t).getUrlComponents();return r.Protocol+"//"+r.HostNameAndPort+e}return e}static constructAuthorityUriFromObject(e){return new UrlString(e.Protocol+"//"+e.HostNameAndPort+"/"+e.PathSegments.join("/"))}static hashContainsKnownProperties(e){return!!getDeserializedResponse(e)}}const ir={"login.microsoftonline.com":{token_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.com/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.com/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/logout"},"login.chinacloudapi.cn":{token_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.chinacloudapi.cn/{tenantid}/discovery/v2.0/keys",issuer:"https://login.partner.microsoftonline.cn/{tenantid}/v2.0",authorization_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/logout"},"login.microsoftonline.us":{token_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.us/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.us/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/logout"}},ar={tenant_discovery_endpoint:"https://{canonicalAuthority}/v2.0/.well-known/openid-configuration",metadata:[{preferred_network:"login.microsoftonline.com",preferred_cache:"login.windows.net",aliases:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"]},{preferred_network:"login.partner.microsoftonline.cn",preferred_cache:"login.partner.microsoftonline.cn",aliases:["login.partner.microsoftonline.cn","login.chinacloudapi.cn"]},{preferred_network:"login.microsoftonline.de",preferred_cache:"login.microsoftonline.de",aliases:["login.microsoftonline.de"]},{preferred_network:"login.microsoftonline.us",preferred_cache:"login.microsoftonline.us",aliases:["login.microsoftonline.us","login.usgovcloudapi.net"]},{preferred_network:"login-us.microsoftonline.com",preferred_cache:"login-us.microsoftonline.com",aliases:["login-us.microsoftonline.com"]}]},sr=new Set;function getAliasesFromMetadata(e,t,r,n){if(n?.trace(`getAliasesFromMetadata called with source: ${r}`),e&&t){const o=getCloudDiscoveryMetadataFromNetworkResponse(t,e);if(o)return n?.trace(`getAliasesFromMetadata: found cloud discovery metadata in ${r}, returning aliases`),o.aliases;n?.trace(`getAliasesFromMetadata: did not find cloud discovery metadata in ${r}`)}return null}function getCloudDiscoveryMetadataFromNetworkResponse(e,t){for(let r=0;r<e.length;r++){const n=e[r];if(n.aliases.includes(t))return n}return null}ar.metadata.forEach((e=>{e.aliases.forEach((e=>{sr.add(e)}))}));const cr="AAD",lr="OIDC",ur="none";const dr="refreshTokenClientExecutePostToTokenEndpoint",hr="authorizationCodeClientExecutePostToTokenEndpoint",pr="refreshTokenClientExecuteTokenRequest",gr="refreshTokenClientAcquireToken",fr="refreshTokenClientAcquireTokenWithCachedRefreshToken",mr="refreshTokenClientAcquireTokenByRefreshToken",yr="refreshTokenClientCreateTokenRequestBody",Cr="silentFlowClientAcquireCachedToken",Ar="silentFlowClientGenerateResultFromCacheRecord",Tr="getAuthCodeUrl",Sr="updateTokenEndpointAuthority",Ir="authClientAcquireToken",Er="authClientExecuteTokenRequest",wr="authClientCreateTokenRequestBody",vr="authClientCreateQueryString",kr="popTokenGenerateCnf",br="popTokenGenerateKid",_r="handleServerTokenResponse",Rr="authorityFactoryCreateDiscoveredInstance",Or="authorityResolveEndpointsAsync",Pr="authorityGetCloudDiscoveryMetadataFromNetwork",Mr="authorityUpdateCloudDiscoveryMetadata",Nr="authorityGetEndpointMetadataFromNetwork",Ur="authorityUpdateEndpointMetadata",xr="authorityUpdateMetadataWithRegionalInformation",qr="regionDiscoveryDetectRegion",Hr="regionDiscoveryGetRegionFromIMDS",Dr="regionDiscoveryGetCurrentVersion",Lr="cacheManagerGetRefreshToken",jr=(new Map([["acquireTokenByCode","ATByCode"],["acquireTokenByRefreshToken","ATByRT"],["acquireTokenSilent","ATS"],["acquireTokenSilentAsync","ATSAsync"],["acquireTokenPopup","ATPopup"],["acquireTokenRedirect","ATRedirect"],["cryptoOptsGetPublicKeyThumbprint","CryptoGetPKThumb"],["cryptoOptsSignJwt","CryptoSignJwt"],["silentCacheClientAcquireToken","SltCacheClientAT"],["silentIframeClientAcquireToken","SltIframeClientAT"],["silentRefreshClientAcquireToken","SltRClientAT"],["ssoSilent","SsoSlt"],["standardInteractionClientGetDiscoveredAuthority","StdIntClientGetDiscAuth"],["fetchAccountIdWithNativeBroker","FetchAccIdWithNtvBroker"],["nativeInteractionClientAcquireToken","NtvIntClientAT"],["baseClientCreateTokenRequestHeaders","BaseClientCreateTReqHead"],[dr,"RTClientExecPost"],[hr,"AuthCodeClientExecPost"],["brokerHandshake","BrokerHandshake"],["acquireTokenByRefreshTokenInBroker","ATByRTInBroker"],["acquireTokenByBroker","ATByBroker"],[pr,"RTClientExecTReq"],[gr,"RTClientAT"],[fr,"RTClientATWithCachedRT"],[mr,"RTClientATByRT"],[yr,"RTClientCreateTReqBody"],["acquireTokenFromCache","ATFromCache"],[Cr,"SltFlowClientATCached"],[Ar,"SltFlowClientGenResFromCache"],["acquireTokenBySilentIframe","ATBySltIframe"],["initializeBaseRequest","InitBaseReq"],["initializeSilentRequest","InitSltReq"],["initializeClientApplication","InitClientApplication"],["silentIframeClientTokenHelper","SIClientTHelper"],["silentHandlerInitiateAuthRequest","SHandlerInitAuthReq"],["silentHandlerMonitorIframeForHash","SltHandlerMonitorIframeForHash"],["silentHandlerLoadFrame","SHandlerLoadFrame"],["silentHandlerLoadFrameSync","SHandlerLoadFrameSync"],["standardInteractionClientCreateAuthCodeClient","StdIntClientCreateAuthCodeClient"],["standardInteractionClientGetClientConfiguration","StdIntClientGetClientConf"],["standardInteractionClientInitializeAuthorizationRequest","StdIntClientInitAuthReq"],["standardInteractionClientInitializeAuthorizationCodeRequest","StdIntClientInitAuthCodeReq"],[Tr,"GetAuthCodeUrl"],["handleCodeResponseFromServer","HandleCodeResFromServer"],["handleCodeResponse","HandleCodeResp"],[Sr,"UpdTEndpointAuth"],[Ir,"AuthClientAT"],[Er,"AuthClientExecTReq"],[wr,"AuthClientCreateTReqBody"],[vr,"AuthClientCreateQueryStr"],[kr,"PopTGenCnf"],[br,"PopTGenKid"],[_r,"HandleServerTRes"],["deserializeResponse","DeserializeRes"],[Rr,"AuthFactCreateDiscInst"],[Or,"AuthResolveEndpointsAsync"],["authorityResolveEndpointsFromLocalSources","AuthResolveEndpointsFromLocal"],[Pr,"AuthGetCDMetaFromNet"],[Mr,"AuthUpdCDMeta"],[Nr,"AuthUpdCDMetaFromNet"],[Ur,"AuthUpdEndpointMeta"],[xr,"AuthUpdMetaWithRegInfo"],[qr,"RegDiscDetectReg"],[Hr,"RegDiscGetRegFromIMDS"],[Dr,"RegDiscGetCurrentVer"],["acquireTokenByCodeAsync","ATByCodeAsync"],["getEndpointMetadataFromNetwork","GetEndpointMetaFromNet"],["getCloudDiscoveryMetadataFromNetworkMeasurement","GetCDMetaFromNet"],["handleRedirectPromise","HandleRedirectPromise"],["handleNativeRedirectPromise","HandleNtvRedirectPromise"],["updateCloudDiscoveryMetadataMeasurement","UpdateCDMeta"],["usernamePasswordClientAcquireToken","UserPassClientAT"],["nativeMessageHandlerHandshake","NtvMsgHandlerHandshake"],["nativeGenerateAuthResult","NtvGenAuthRes"],["removeHiddenIframe","RemoveHiddenIframe"],["clearTokensAndKeysWithClaims","ClearTAndKeysWithClaims"],[Lr,"CacheManagerGetRT"],["generatePkceCodes","GenPkceCodes"],["generateCodeVerifier","GenCodeVerifier"],["generateCodeChallengeFromVerifier","GenCodeChallengeFromVerifier"],["sha256Digest","Sha256Digest"],["getRandomValues","GetRandomValues"]]),new Set(["accessTokenSize","durationMs","idTokenSize","matsSilentStatus","matsHttpStatus","refreshTokenSize","queuedTimeMs","startTimeMs","status","multiMatchedAT","multiMatchedID","multiMatchedRT"]),(e,t,r,n,o)=>(...i)=>{r.trace(`Executing function ${t}`);const a=n?.startMeasurement(t,o);if(o){const e=t+"CallCount";n?.incrementFields({[e]:1},o)}return n?.setPreQueueTime(t,o),e(...i).then((e=>(r.trace(`Returning result from ${t}`),a?.end({success:!0}),e))).catch((e=>{r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e}))});class RegionDiscovery{constructor(e,t,r,n){this.networkInterface=e,this.logger=t,this.performanceClient=r,this.correlationId=n}async detectRegion(e,t){this.performanceClient?.addQueueMeasurement(qr,this.correlationId);let r=e;if(r)t.region_source=ne;else{const e=RegionDiscovery.IMDS_OPTIONS;try{const o=await jr(this.getRegionFromIMDS.bind(this),Hr,this.logger,this.performanceClient,this.correlationId)(n.IMDS_VERSION,e);if(o.status===ee&&(r=o.body,t.region_source=oe),o.status===te){const n=await jr(this.getCurrentVersion.bind(this),Dr,this.logger,this.performanceClient,this.correlationId)(e);if(!n)return t.region_source=re,null;const o=await jr(this.getRegionFromIMDS.bind(this),Hr,this.logger,this.performanceClient,this.correlationId)(n,e);o.status===ee&&(r=o.body,t.region_source=oe)}}catch(e){return t.region_source=re,null}}return r||(t.region_source=re),r||null}async getRegionFromIMDS(e,t){return this.performanceClient?.addQueueMeasurement(Hr,this.correlationId),this.networkInterface.sendGetRequestAsync(`${n.IMDS_ENDPOINT}?api-version=${e}&format=text`,t,n.IMDS_TIMEOUT)}async getCurrentVersion(e){this.performanceClient?.addQueueMeasurement(Dr,this.correlationId);try{const t=await this.networkInterface.sendGetRequestAsync(`${n.IMDS_ENDPOINT}?format=json`,e);return t.status===te&&t.body&&t.body["newest-versions"]&&t.body["newest-versions"].length>0?t.body["newest-versions"][0]:null}catch(e){return null}}}function extractTokenClaims(e,t){const r=function getJWSPayload(e){if(!e)throw createClientAuthError(yt);const t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)throw createClientAuthError(mt);return t[2]}(e);try{const e=t(r);return JSON.parse(e)}catch(e){throw createClientAuthError(mt)}}function checkMaxAge(e,t){if(0===t||Date.now()-3e5>e+t)throw createClientAuthError(bt)}function nowSeconds(){return Math.round((new Date).getTime()/1e3)}function isTokenExpired(e,t){const r=Number(e)||0;return nowSeconds()+t>r}function generateCredentialKey(e){return[generateAccountId(e),generateCredentialId(e),generateTarget(e),generateClaimsHash(e),generateScheme(e)].join(N).toLowerCase()}function isCredentialEntity(e){return e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("credentialType")&&e.hasOwnProperty("clientId")&&e.hasOwnProperty("secret")}function isAccessTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.hasOwnProperty("realm")&&e.hasOwnProperty("target")&&(e.credentialType===x.ACCESS_TOKEN||e.credentialType===x.ACCESS_TOKEN_WITH_AUTH_SCHEME))}function isIdTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.hasOwnProperty("realm")&&e.credentialType===x.ID_TOKEN)}function isRefreshTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.credentialType===x.REFRESH_TOKEN)}function generateAccountId(e){return[e.homeAccountId,e.environment].join(N).toLowerCase()}function generateCredentialId(e){const t=e.credentialType===x.REFRESH_TOKEN&&e.familyId||e.clientId;return[e.credentialType,t,e.realm||""].join(N).toLowerCase()}function generateTarget(e){return(e.target||"").toLowerCase()}function generateClaimsHash(e){return(e.requestedClaimsHash||"").toLowerCase()}function generateScheme(e){return e.tokenType&&e.tokenType.toLowerCase()!==z.BEARER.toLowerCase()?e.tokenType.toLowerCase():""}function isAppMetadataEntity(e,t){return!!t&&(0===e.indexOf(q)&&t.hasOwnProperty("clientId")&&t.hasOwnProperty("environment"))}function generateAuthorityMetadataExpiresAt(){return nowSeconds()+L}function updateAuthorityEndpointMetadata(e,t,r){e.authorization_endpoint=t.authorization_endpoint,e.token_endpoint=t.token_endpoint,e.end_session_endpoint=t.end_session_endpoint,e.issuer=t.issuer,e.endpointsFromNetwork=r,e.jwks_uri=t.jwks_uri}function updateCloudDiscoveryMetadata(e,t,r){e.aliases=t.aliases,e.preferred_cache=t.preferred_cache,e.preferred_network=t.preferred_network,e.aliasesFromNetwork=r}function isAuthorityMetadataExpired(e){return e.expiresAt<=nowSeconds()}RegionDiscovery.IMDS_OPTIONS={headers:{Metadata:"true"}};class Authority_Authority{constructor(e,t,r,n,o,i,a,s){this.canonicalAuthority=e,this._canonicalAuthority.validateAsUri(),this.networkInterface=t,this.cacheManager=r,this.authorityOptions=n,this.regionDiscoveryMetadata={region_used:void 0,region_source:void 0,region_outcome:void 0},this.logger=o,this.performanceClient=a,this.correlationId=i,this.managedIdentity=s||!1,this.regionDiscovery=new RegionDiscovery(t,this.logger,this.performanceClient,this.correlationId)}getAuthorityType(e){if(e.HostNameAndPort.endsWith(n.CIAM_AUTH_URL))return $e;const t=e.PathSegments;if(t.length)switch(t[0].toLowerCase()){case n.ADFS:return Ke;case n.DSTS:return Be}return Fe}get authorityType(){return this.getAuthorityType(this.canonicalAuthorityUrlComponents)}get protocolMode(){return this.authorityOptions.protocolMode}get options(){return this.authorityOptions}get canonicalAuthority(){return this._canonicalAuthority.urlString}set canonicalAuthority(e){this._canonicalAuthority=new UrlString(e),this._canonicalAuthority.validateAsUri(),this._canonicalAuthorityUrlComponents=null}get canonicalAuthorityUrlComponents(){return this._canonicalAuthorityUrlComponents||(this._canonicalAuthorityUrlComponents=this._canonicalAuthority.getUrlComponents()),this._canonicalAuthorityUrlComponents}get hostnameAndPort(){return this.canonicalAuthorityUrlComponents.HostNameAndPort.toLowerCase()}get tenant(){return this.canonicalAuthorityUrlComponents.PathSegments[0]}get authorizationEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.authorization_endpoint);throw createClientAuthError(Ct)}get tokenEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint);throw createClientAuthError(Ct)}get deviceCodeEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint.replace("/token","/devicecode"));throw createClientAuthError(Ct)}get endSessionEndpoint(){if(this.discoveryComplete()){if(!this.metadata.end_session_endpoint)throw createClientAuthError(Jt);return this.replacePath(this.metadata.end_session_endpoint)}throw createClientAuthError(Ct)}get selfSignedJwtAudience(){if(this.discoveryComplete())return this.replacePath(this.metadata.issuer);throw createClientAuthError(Ct)}get jwksUri(){if(this.discoveryComplete())return this.replacePath(this.metadata.jwks_uri);throw createClientAuthError(Ct)}canReplaceTenant(e){return 1===e.PathSegments.length&&!Authority_Authority.reservedTenantDomains.has(e.PathSegments[0])&&this.getAuthorityType(e)===Fe&&this.protocolMode===cr}replaceTenant(e){return e.replace(/{tenant}|{tenantid}/g,this.tenant)}replacePath(e){let t=e;const r=new UrlString(this.metadata.canonical_authority).getUrlComponents(),n=r.PathSegments;return this.canonicalAuthorityUrlComponents.PathSegments.forEach(((e,o)=>{let i=n[o];if(0===o&&this.canReplaceTenant(r)){const e=new UrlString(this.metadata.authorization_endpoint).getUrlComponents().PathSegments[0];i!==e&&(this.logger.verbose(`Replacing tenant domain name ${i} with id ${e}`),i=e)}e!==i&&(t=t.replace(`/${i}/`,`/${e}/`))})),this.replaceTenant(t)}get defaultOpenIdConfigurationEndpoint(){const e=this.hostnameAndPort;return this.canonicalAuthority.endsWith("v2.0/")||this.authorityType===Ke||this.protocolMode!==cr&&!this.isAliasOfKnownMicrosoftAuthority(e)?`${this.canonicalAuthority}.well-known/openid-configuration`:`${this.canonicalAuthority}v2.0/.well-known/openid-configuration`}discoveryComplete(){return!!this.metadata}async resolveEndpointsAsync(){this.performanceClient?.addQueueMeasurement(Or,this.correlationId);const e=this.getCurrentMetadataEntity(),t=await jr(this.updateCloudDiscoveryMetadata.bind(this),Mr,this.logger,this.performanceClient,this.correlationId)(e);this.canonicalAuthority=this.canonicalAuthority.replace(this.hostnameAndPort,e.preferred_network);const r=await jr(this.updateEndpointMetadata.bind(this),Ur,this.logger,this.performanceClient,this.correlationId)(e);this.updateCachedMetadata(e,t,{source:r}),this.performanceClient?.addFields({cloudDiscoverySource:t,authorityEndpointSource:r},this.correlationId)}getCurrentMetadataEntity(){let e=this.cacheManager.getAuthorityMetadataByAlias(this.hostnameAndPort);return e||(e={aliases:[],preferred_cache:this.hostnameAndPort,preferred_network:this.hostnameAndPort,canonical_authority:this.canonicalAuthority,authorization_endpoint:"",token_endpoint:"",end_session_endpoint:"",issuer:"",aliasesFromNetwork:!1,endpointsFromNetwork:!1,expiresAt:generateAuthorityMetadataExpiresAt(),jwks_uri:""}),e}updateCachedMetadata(e,t,r){t!==F&&r?.source!==F&&(e.expiresAt=generateAuthorityMetadataExpiresAt(),e.canonical_authority=this.canonicalAuthority);const n=this.cacheManager.generateAuthorityMetadataCacheKey(e.preferred_cache);this.cacheManager.setAuthorityMetadata(n,e),this.metadata=e}async updateEndpointMetadata(e){this.performanceClient?.addQueueMeasurement(Ur,this.correlationId);const t=this.updateEndpointMetadataFromLocalSources(e);if(t){if(t.source===B&&this.authorityOptions.azureRegionConfiguration?.azureRegion&&t.metadata){updateAuthorityEndpointMetadata(e,await jr(this.updateMetadataWithRegionalInformation.bind(this),xr,this.logger,this.performanceClient,this.correlationId)(t.metadata),!1),e.canonical_authority=this.canonicalAuthority}return t.source}let r=await jr(this.getEndpointMetadataFromNetwork.bind(this),Nr,this.logger,this.performanceClient,this.correlationId)();if(r)return this.authorityOptions.azureRegionConfiguration?.azureRegion&&(r=await jr(this.updateMetadataWithRegionalInformation.bind(this),xr,this.logger,this.performanceClient,this.correlationId)(r)),updateAuthorityEndpointMetadata(e,r,!0),K;throw createClientAuthError(Tt,this.defaultOpenIdConfigurationEndpoint)}updateEndpointMetadataFromLocalSources(e){this.logger.verbose("Attempting to get endpoint metadata from authority configuration");const t=this.getEndpointMetadataFromConfig();if(t)return this.logger.verbose("Found endpoint metadata in authority configuration"),updateAuthorityEndpointMetadata(e,t,!1),{source:j};if(this.logger.verbose("Did not find endpoint metadata in the config... Attempting to get endpoint metadata from the hardcoded values."),this.authorityOptions.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get endpoint metadata from the network metadata cache.");else{const t=this.getEndpointMetadataFromHardcodedValues();if(t)return updateAuthorityEndpointMetadata(e,t,!1),{source:B,metadata:t};this.logger.verbose("Did not find endpoint metadata in hardcoded values... Attempting to get endpoint metadata from the network metadata cache.")}const r=isAuthorityMetadataExpired(e);return this.isAuthoritySameType(e)&&e.endpointsFromNetwork&&!r?(this.logger.verbose("Found endpoint metadata in the cache."),{source:F}):(r&&this.logger.verbose("The metadata entity is expired."),null)}isAuthoritySameType(e){return new UrlString(e.canonical_authority).getUrlComponents().PathSegments.length===this.canonicalAuthorityUrlComponents.PathSegments.length}getEndpointMetadataFromConfig(){if(this.authorityOptions.authorityMetadata)try{return JSON.parse(this.authorityOptions.authorityMetadata)}catch(e){throw ClientConfigurationError_createClientConfigurationError(ot)}return null}async getEndpointMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(Nr,this.correlationId);const e={},t=this.defaultOpenIdConfigurationEndpoint;this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: attempting to retrieve OAuth endpoints from ${t}`);try{const r=await this.networkInterface.sendGetRequestAsync(t,e),n=function isOpenIdConfigResponse(e){return e.hasOwnProperty("authorization_endpoint")&&e.hasOwnProperty("token_endpoint")&&e.hasOwnProperty("issuer")&&e.hasOwnProperty("jwks_uri")}(r.body);return n?r.body:(this.logger.verbose("Authority.getEndpointMetadataFromNetwork: could not parse response as OpenID configuration"),null)}catch(e){return this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: ${e}`),null}}getEndpointMetadataFromHardcodedValues(){return this.hostnameAndPort in ir?ir[this.hostnameAndPort]:null}async updateMetadataWithRegionalInformation(e){this.performanceClient?.addQueueMeasurement(xr,this.correlationId);const t=this.authorityOptions.azureRegionConfiguration?.azureRegion;if(t){if(t!==n.AZURE_REGION_AUTO_DISCOVER_FLAG)return this.regionDiscoveryMetadata.region_outcome=ie,this.regionDiscoveryMetadata.region_used=t,Authority_Authority.replaceWithRegionalInformation(e,t);const r=await jr(this.regionDiscovery.detectRegion.bind(this.regionDiscovery),qr,this.logger,this.performanceClient,this.correlationId)(this.authorityOptions.azureRegionConfiguration?.environmentRegion,this.regionDiscoveryMetadata);if(r)return this.regionDiscoveryMetadata.region_outcome=ae,this.regionDiscoveryMetadata.region_used=r,Authority_Authority.replaceWithRegionalInformation(e,r);this.regionDiscoveryMetadata.region_outcome=se}return e}async updateCloudDiscoveryMetadata(e){this.performanceClient?.addQueueMeasurement(Mr,this.correlationId);const t=this.updateCloudDiscoveryMetadataFromLocalSources(e);if(t)return t;const r=await jr(this.getCloudDiscoveryMetadataFromNetwork.bind(this),Pr,this.logger,this.performanceClient,this.correlationId)();if(r)return updateCloudDiscoveryMetadata(e,r,!0),K;throw ClientConfigurationError_createClientConfigurationError(it)}updateCloudDiscoveryMetadataFromLocalSources(e){this.logger.verbose("Attempting to get cloud discovery metadata  from authority configuration"),this.logger.verbosePii(`Known Authorities: ${this.authorityOptions.knownAuthorities||n.NOT_APPLICABLE}`),this.logger.verbosePii(`Authority Metadata: ${this.authorityOptions.authorityMetadata||n.NOT_APPLICABLE}`),this.logger.verbosePii(`Canonical Authority: ${e.canonical_authority||n.NOT_APPLICABLE}`);const t=this.getCloudDiscoveryMetadataFromConfig();if(t)return this.logger.verbose("Found cloud discovery metadata in authority configuration"),updateCloudDiscoveryMetadata(e,t,!1),j;if(this.logger.verbose("Did not find cloud discovery metadata in the config... Attempting to get cloud discovery metadata from the hardcoded values."),this.options.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded cloud discovery metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get cloud discovery metadata from the network metadata cache.");else{const t=function getCloudDiscoveryMetadataFromHardcodedValues(e){return getCloudDiscoveryMetadataFromNetworkResponse(ar.metadata,e)}(this.hostnameAndPort);if(t)return this.logger.verbose("Found cloud discovery metadata from hardcoded values."),updateCloudDiscoveryMetadata(e,t,!1),B;this.logger.verbose("Did not find cloud discovery metadata in hardcoded values... Attempting to get cloud discovery metadata from the network metadata cache.")}const r=isAuthorityMetadataExpired(e);return this.isAuthoritySameType(e)&&e.aliasesFromNetwork&&!r?(this.logger.verbose("Found cloud discovery metadata in the cache."),F):(r&&this.logger.verbose("The metadata entity is expired."),null)}getCloudDiscoveryMetadataFromConfig(){if(this.authorityType===$e)return this.logger.verbose("CIAM authorities do not support cloud discovery metadata, generate the aliases from authority host."),Authority_Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort);if(this.authorityOptions.cloudDiscoveryMetadata){this.logger.verbose("The cloud discovery metadata has been provided as a network response, in the config.");try{this.logger.verbose("Attempting to parse the cloud discovery metadata.");const e=getCloudDiscoveryMetadataFromNetworkResponse(JSON.parse(this.authorityOptions.cloudDiscoveryMetadata).metadata,this.hostnameAndPort);if(this.logger.verbose("Parsed the cloud discovery metadata."),e)return this.logger.verbose("There is returnable metadata attached to the parsed cloud discovery metadata."),e;this.logger.verbose("There is no metadata attached to the parsed cloud discovery metadata.")}catch(e){throw this.logger.verbose("Unable to parse the cloud discovery metadata. Throwing Invalid Cloud Discovery Metadata Error."),ClientConfigurationError_createClientConfigurationError(nt)}}return this.isInKnownAuthorities()?(this.logger.verbose("The host is included in knownAuthorities. Creating new cloud discovery metadata from the host."),Authority_Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)):null}async getCloudDiscoveryMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(Pr,this.correlationId);const e=`${n.AAD_INSTANCE_DISCOVERY_ENDPT}${this.canonicalAuthority}oauth2/v2.0/authorize`,t={};let r=null;try{const o=await this.networkInterface.sendGetRequestAsync(e,t);let i,a;if(function isCloudInstanceDiscoveryResponse(e){return e.hasOwnProperty("tenant_discovery_endpoint")&&e.hasOwnProperty("metadata")}(o.body))i=o.body,a=i.metadata,this.logger.verbosePii(`tenant_discovery_endpoint is: ${i.tenant_discovery_endpoint}`);else{if(!function isCloudInstanceDiscoveryErrorResponse(e){return e.hasOwnProperty("error")&&e.hasOwnProperty("error_description")}(o.body))return this.logger.error("AAD did not return a CloudInstanceDiscoveryResponse or CloudInstanceDiscoveryErrorResponse"),null;if(this.logger.warning(`A CloudInstanceDiscoveryErrorResponse was returned. The cloud instance discovery network request's status code is: ${o.status}`),i=o.body,i.error===n.INVALID_INSTANCE)return this.logger.error("The CloudInstanceDiscoveryErrorResponse error is invalid_instance."),null;this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error is ${i.error}`),this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error description is ${i.error_description}`),this.logger.warning("Setting the value of the CloudInstanceDiscoveryMetadata (returned from the network) to []"),a=[]}this.logger.verbose("Attempting to find a match between the developer's authority and the CloudInstanceDiscoveryMetadata returned from the network request."),r=getCloudDiscoveryMetadataFromNetworkResponse(a,this.hostnameAndPort)}catch(e){if(e instanceof AuthError)this.logger.error(`There was a network error while attempting to get the cloud discovery instance metadata.\nError: ${e.errorCode}\nError Description: ${e.errorMessage}`);else{const t=e;this.logger.error(`A non-MSALJS error was thrown while attempting to get the cloud instance discovery metadata.\nError: ${t.name}\nError Description: ${t.message}`)}return null}return r||(this.logger.warning("The developer's authority was not found within the CloudInstanceDiscoveryMetadata returned from the network request."),this.logger.verbose("Creating custom Authority for custom domain scenario."),r=Authority_Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)),r}isInKnownAuthorities(){return this.authorityOptions.knownAuthorities.filter((e=>e&&UrlString.getDomainFromUrl(e).toLowerCase()===this.hostnameAndPort)).length>0}static generateAuthority(e,t){let r;if(t&&t.azureCloudInstance!==ur){const e=t.tenant?t.tenant:n.DEFAULT_COMMON_TENANT;r=`${t.azureCloudInstance}/${e}/`}return r||e}static createCloudDiscoveryMetadataFromHost(e){return{preferred_network:e,preferred_cache:e,aliases:[e]}}getPreferredCache(){if(this.managedIdentity)return n.DEFAULT_AUTHORITY_HOST;if(this.discoveryComplete())return this.metadata.preferred_cache;throw createClientAuthError(Ct)}isAlias(e){return this.metadata.aliases.indexOf(e)>-1}isAliasOfKnownMicrosoftAuthority(e){return sr.has(e)}static isPublicCloudAuthority(e){return n.KNOWN_PUBLIC_CLOUDS.indexOf(e)>=0}static buildRegionalAuthorityString(e,t,r){const o=new UrlString(e);o.validateAsUri();const i=o.getUrlComponents();let a=`${t}.${i.HostNameAndPort}`;this.isPublicCloudAuthority(i.HostNameAndPort)&&(a=`${t}.${n.REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX}`);const s=UrlString.constructAuthorityUriFromObject({...o.getUrlComponents(),HostNameAndPort:a}).urlString;return r?`${s}?${r}`:s}static replaceWithRegionalInformation(e,t){const r={...e};return r.authorization_endpoint=Authority_Authority.buildRegionalAuthorityString(r.authorization_endpoint,t),r.token_endpoint=Authority_Authority.buildRegionalAuthorityString(r.token_endpoint,t),r.end_session_endpoint&&(r.end_session_endpoint=Authority_Authority.buildRegionalAuthorityString(r.end_session_endpoint,t)),r}static transformCIAMAuthority(e){let t=e;const r=new UrlString(e).getUrlComponents();if(0===r.PathSegments.length&&r.HostNameAndPort.endsWith(n.CIAM_AUTH_URL)){t=`${t}${r.HostNameAndPort.split(".")[0]}${n.AAD_TENANT_DOMAIN_SUFFIX}`}return t}}function formatAuthorityUri(e){return e.endsWith(n.FORWARD_SLASH)?e:`${e}${n.FORWARD_SLASH}`}Authority_Authority.reservedTenantDomains=new Set(["{tenant}","{tenantid}",A.COMMON,A.CONSUMERS,A.ORGANIZATIONS]);const Fr={createNewGuid:()=>{throw createClientAuthError(rr)},base64Decode:()=>{throw createClientAuthError(rr)},base64Encode:()=>{throw createClientAuthError(rr)},base64UrlEncode:()=>{throw createClientAuthError(rr)},encodeKid:()=>{throw createClientAuthError(rr)},async getPublicKeyThumbprint(){throw createClientAuthError(rr)},async removeTokenBindingKey(){throw createClientAuthError(rr)},async clearKeystore(){throw createClientAuthError(rr)},async signJwt(){throw createClientAuthError(rr)},async hashString(){throw createClientAuthError(rr)}},Kr="@azure/msal-common",Br="14.12.0";class ScopeSet{constructor(e){const t=e?StringUtils.trimArrayEntries([...e]):[],r=t?StringUtils.removeEmptyStringsFromArray(t):[];this.validateInputScopes(r),this.scopes=new Set,r.forEach((e=>this.scopes.add(e)))}static fromString(e){const t=(e||n.EMPTY_STRING).split(" ");return new ScopeSet(t)}static createSearchScopes(e){const t=new ScopeSet(e);return t.containsOnlyOIDCScopes()?t.removeScope(n.OFFLINE_ACCESS_SCOPE):t.removeOIDCScopes(),t}validateInputScopes(e){if(!e||e.length<1)throw ClientConfigurationError_createClientConfigurationError(Qe)}containsScope(e){const t=this.printScopesLowerCase().split(" "),r=new ScopeSet(t);return!!e&&r.scopes.has(e.toLowerCase())}containsScopeSet(e){return!(!e||e.scopes.size<=0)&&(this.scopes.size>=e.scopes.size&&e.asArray().every((e=>this.containsScope(e))))}containsOnlyOIDCScopes(){let e=0;return p.forEach((t=>{this.containsScope(t)&&(e+=1)})),this.scopes.size===e}appendScope(e){e&&this.scopes.add(e.trim())}appendScopes(e){try{e.forEach((e=>this.appendScope(e)))}catch(e){throw createClientAuthError(Nt)}}removeScope(e){if(!e)throw createClientAuthError(Mt);this.scopes.delete(e.trim())}removeOIDCScopes(){p.forEach((e=>{this.scopes.delete(e)}))}unionScopeSets(e){if(!e)throw createClientAuthError(Ut);const t=new Set;return e.scopes.forEach((e=>t.add(e.toLowerCase()))),this.scopes.forEach((e=>t.add(e.toLowerCase()))),t}intersectingScopeSets(e){if(!e)throw createClientAuthError(Ut);e.containsOnlyOIDCScopes()||e.removeOIDCScopes();const t=this.unionScopeSets(e),r=e.getScopeCount(),n=this.getScopeCount();return t.size<n+r}getScopeCount(){return this.scopes.size}asArray(){const e=[];return this.scopes.forEach((t=>e.push(t))),e}printScopes(){if(this.scopes){return this.asArray().join(" ")}return n.EMPTY_STRING}printScopesLowerCase(){return this.printScopes().toLowerCase()}}function buildClientInfo(e,t){if(!e)throw createClientAuthError(ft);try{const r=t(e);return JSON.parse(r)}catch(e){throw createClientAuthError(gt)}}function buildClientInfoFromHomeAccountId(e){if(!e)throw createClientAuthError(gt);const t=e.split(U,2);return{uid:t[0],utid:t.length<2?n.EMPTY_STRING:t[1]}}function tenantIdMatchesHomeTenant(e,t){return!!e&&!!t&&e===t.split(".")[1]}function buildTenantProfileFromIdTokenClaims(e,t){const{oid:r,sub:n,tid:o,name:i,tfp:a,acr:s}=t,c=o||a||s||"";return{tenantId:c,localAccountId:r||n||"",name:i,isHomeTenant:tenantIdMatchesHomeTenant(c,e)}}function updateAccountTenantProfileData(e,t,r,n){let o=e;if(t){const{isHomeTenant:r,...n}=t;o={...e,...n}}if(r){const{isHomeTenant:t,...i}=buildTenantProfileFromIdTokenClaims(e.homeAccountId,r);return o={...o,...i,idTokenClaims:r,idToken:n},o}return o}function getTenantIdFromIdTokenClaims(e){if(e){return e.tid||e.tfp||e.acr||null}return null}class AccountEntity{generateAccountId(){return[this.homeAccountId,this.environment].join(N).toLowerCase()}generateAccountKey(){return AccountEntity.generateAccountCacheKey({homeAccountId:this.homeAccountId,environment:this.environment,tenantId:this.realm,username:this.username,localAccountId:this.localAccountId})}getAccountInfo(){return{homeAccountId:this.homeAccountId,environment:this.environment,tenantId:this.realm,username:this.username,localAccountId:this.localAccountId,name:this.name,nativeAccountId:this.nativeAccountId,authorityType:this.authorityType,tenantProfiles:new Map((this.tenantProfiles||[]).map((e=>[e.tenantId,e])))}}isSingleTenant(){return!this.tenantProfiles}static generateAccountCacheKey(e){const t=e.homeAccountId.split(".")[1];return[e.homeAccountId,e.environment||"",t||e.tenantId||""].join(N).toLowerCase()}static createAccount(e,t,r){const n=new AccountEntity;let o;t.authorityType===Ke?n.authorityType=P:t.protocolMode===cr?n.authorityType=O:n.authorityType=M,e.clientInfo&&r&&(o=buildClientInfo(e.clientInfo,r)),n.clientInfo=e.clientInfo,n.homeAccountId=e.homeAccountId,n.nativeAccountId=e.nativeAccountId;const i=e.environment||t&&t.getPreferredCache();if(!i)throw createClientAuthError(jt);n.environment=i,n.realm=o?.utid||getTenantIdFromIdTokenClaims(e.idTokenClaims)||"",n.localAccountId=o?.uid||e.idTokenClaims.oid||e.idTokenClaims.sub||"";const a=e.idTokenClaims.preferred_username||e.idTokenClaims.upn,s=e.idTokenClaims.emails?e.idTokenClaims.emails[0]:null;if(n.username=a||s||"",n.name=e.idTokenClaims.name,n.cloudGraphHostName=e.cloudGraphHostName,n.msGraphHost=e.msGraphHost,e.tenantProfiles)n.tenantProfiles=e.tenantProfiles;else{const t=[];if(e.idTokenClaims){const r=buildTenantProfileFromIdTokenClaims(e.homeAccountId,e.idTokenClaims);t.push(r)}n.tenantProfiles=t}return n}static createFromAccountInfo(e,t,r){const n=new AccountEntity;return n.authorityType=e.authorityType||M,n.homeAccountId=e.homeAccountId,n.localAccountId=e.localAccountId,n.nativeAccountId=e.nativeAccountId,n.realm=e.tenantId,n.environment=e.environment,n.username=e.username,n.name=e.name,n.cloudGraphHostName=t,n.msGraphHost=r,n.tenantProfiles=Array.from(e.tenantProfiles?.values()||[]),n}static generateHomeAccountId(e,t,r,n,o){if(t!==Ke&&t!==Be){if(e)try{const t=buildClientInfo(e,n.base64Decode);if(t.uid&&t.utid)return`${t.uid}.${t.utid}`}catch(e){}r.warning("No client info in response")}return o?.sub||""}static isAccountEntity(e){return!!e&&(e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("realm")&&e.hasOwnProperty("localAccountId")&&e.hasOwnProperty("username")&&e.hasOwnProperty("authorityType"))}static accountInfoIsEqual(e,t,r){if(!e||!t)return!1;let n=!0;if(r){const r=e.idTokenClaims||{},o=t.idTokenClaims||{};n=r.iat===o.iat&&r.nonce===o.nonce}return e.homeAccountId===t.homeAccountId&&e.localAccountId===t.localAccountId&&e.username===t.username&&e.tenantId===t.tenantId&&e.environment===t.environment&&e.nativeAccountId===t.nativeAccountId&&n}}const $r="cache_quota_exceeded",zr="cache_error_unknown",Gr={[$r]:"Exceeded cache storage capacity.",[zr]:"Unexpected error occurred when using cache storage."};class CacheError extends Error{constructor(e,t){const r=t||(Gr[e]?Gr[e]:Gr[zr]);super(`${e}: ${r}`),Object.setPrototypeOf(this,CacheError.prototype),this.name="CacheError",this.errorCode=e,this.errorMessage=r}}class CacheManager{constructor(e,t,r,n){this.clientId=e,this.cryptoImpl=t,this.commonLogger=r.clone(Kr,Br),this.staticAuthorityOptions=n}getAllAccounts(e){return this.buildTenantProfiles(this.getAccountsFilteredBy(e||{}),e)}getAccountInfoFilteredBy(e){const t=this.getAllAccounts(e);if(t.length>1){return t.sort((e=>e.idTokenClaims?-1:1))[0]}return 1===t.length?t[0]:null}getBaseAccountInfo(e){const t=this.getAccountsFilteredBy(e);return t.length>0?t[0].getAccountInfo():null}buildTenantProfiles(e,t){return e.flatMap((e=>this.getAccountInfoForTenantProfiles(e,t)))}getAccountInfoForTenantProfiles(e,t){return this.getTenantProfilesFromAccountEntity(e,t?.tenantId,t)}getTenantedAccountInfoByFilter(e,t,r,n){let o,i=null;if(n&&!this.tenantProfileMatchesFilter(r,n))return null;const a=this.getIdToken(e,t,r.tenantId);return a&&(o=extractTokenClaims(a.secret,this.cryptoImpl.base64Decode),!this.idTokenClaimsMatchTenantProfileFilter(o,n))?null:(i=updateAccountTenantProfileData(e,r,o,a?.secret),i)}getTenantProfilesFromAccountEntity(e,t,r){const n=e.getAccountInfo();let o=n.tenantProfiles||new Map;const i=this.getTokenKeys();if(t){const e=o.get(t);if(!e)return[];o=new Map([[t,e]])}const a=[];return o.forEach((e=>{const t=this.getTenantedAccountInfoByFilter(n,i,e,r);t&&a.push(t)})),a}tenantProfileMatchesFilter(e,t){return!(t.localAccountId&&!this.matchLocalAccountIdFromTenantProfile(e,t.localAccountId))&&((!t.name||e.name===t.name)&&(void 0===t.isHomeTenant||e.isHomeTenant===t.isHomeTenant))}idTokenClaimsMatchTenantProfileFilter(e,t){if(t){if(t.localAccountId&&!this.matchLocalAccountIdFromTokenClaims(e,t.localAccountId))return!1;if(t.loginHint&&!this.matchLoginHintFromTokenClaims(e,t.loginHint))return!1;if(t.username&&!this.matchUsername(e.preferred_username,t.username))return!1;if(t.name&&!this.matchName(e,t.name))return!1;if(t.sid&&!this.matchSid(e,t.sid))return!1}return!0}async saveCacheRecord(e,t,r){if(!e)throw createClientAuthError(Lt);try{e.account&&this.setAccount(e.account),e.idToken&&!1!==t?.idToken&&this.setIdTokenCredential(e.idToken),e.accessToken&&!1!==t?.accessToken&&await this.saveAccessToken(e.accessToken),e.refreshToken&&!1!==t?.refreshToken&&this.setRefreshTokenCredential(e.refreshToken),e.appMetadata&&this.setAppMetadata(e.appMetadata)}catch(e){throw this.commonLogger?.error("CacheManager.saveCacheRecord: failed"),e instanceof Error?(this.commonLogger?.errorPii(`CacheManager.saveCacheRecord: ${e.message}`,r),"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name||e.message.includes("exceeded the quota")?(this.commonLogger?.error("CacheManager.saveCacheRecord: exceeded storage quota",r),new CacheError($r)):new CacheError(e.name,e.message)):(this.commonLogger?.errorPii(`CacheManager.saveCacheRecord: ${e}`,r),new CacheError(zr))}}async saveAccessToken(e){const t={clientId:e.clientId,credentialType:e.credentialType,environment:e.environment,homeAccountId:e.homeAccountId,realm:e.realm,tokenType:e.tokenType,requestedClaimsHash:e.requestedClaimsHash},r=this.getTokenKeys(),n=ScopeSet.fromString(e.target),o=[];r.accessToken.forEach((e=>{if(!this.accessTokenKeyMatchesFilter(e,t,!1))return;const r=this.getAccessTokenCredential(e);if(r&&this.credentialMatchesFilter(r,t)){ScopeSet.fromString(r.target).intersectingScopeSets(n)&&o.push(this.removeAccessToken(e))}})),await Promise.all(o),this.setAccessTokenCredential(e)}getAccountsFilteredBy(e){const t=this.getAccountKeys(),r=[];return t.forEach((t=>{if(!this.isAccountKey(t,e.homeAccountId))return;const n=this.getAccount(t,this.commonLogger);if(!n)return;if(e.homeAccountId&&!this.matchHomeAccountId(n,e.homeAccountId))return;if(e.username&&!this.matchUsername(n.username,e.username))return;if(e.environment&&!this.matchEnvironment(n,e.environment))return;if(e.realm&&!this.matchRealm(n,e.realm))return;if(e.nativeAccountId&&!this.matchNativeAccountId(n,e.nativeAccountId))return;if(e.authorityType&&!this.matchAuthorityType(n,e.authorityType))return;const o={localAccountId:e?.localAccountId,name:e?.name},i=n.tenantProfiles?.filter((e=>this.tenantProfileMatchesFilter(e,o)));i&&0===i.length||r.push(n)})),r}isAccountKey(e,t,r){return!(e.split(N).length<3)&&(!(t&&!e.toLowerCase().includes(t.toLowerCase()))&&!(r&&!e.toLowerCase().includes(r.toLowerCase())))}isCredentialKey(e){if(e.split(N).length<6)return!1;const t=e.toLowerCase();if(-1===t.indexOf(x.ID_TOKEN.toLowerCase())&&-1===t.indexOf(x.ACCESS_TOKEN.toLowerCase())&&-1===t.indexOf(x.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase())&&-1===t.indexOf(x.REFRESH_TOKEN.toLowerCase()))return!1;if(t.indexOf(x.REFRESH_TOKEN.toLowerCase())>-1){const e=`${x.REFRESH_TOKEN}${N}${this.clientId}${N}`,r=`${x.REFRESH_TOKEN}${N}${H}${N}`;if(-1===t.indexOf(e.toLowerCase())&&-1===t.indexOf(r.toLowerCase()))return!1}else if(-1===t.indexOf(this.clientId.toLowerCase()))return!1;return!0}credentialMatchesFilter(e,t){if(t.clientId&&!this.matchClientId(e,t.clientId))return!1;if(t.userAssertionHash&&!this.matchUserAssertionHash(e,t.userAssertionHash))return!1;if("string"==typeof t.homeAccountId&&!this.matchHomeAccountId(e,t.homeAccountId))return!1;if(t.environment&&!this.matchEnvironment(e,t.environment))return!1;if(t.realm&&!this.matchRealm(e,t.realm))return!1;if(t.credentialType&&!this.matchCredentialType(e,t.credentialType))return!1;if(t.familyId&&!this.matchFamilyId(e,t.familyId))return!1;if(t.target&&!this.matchTarget(e,t.target))return!1;if((t.requestedClaimsHash||e.requestedClaimsHash)&&e.requestedClaimsHash!==t.requestedClaimsHash)return!1;if(e.credentialType===x.ACCESS_TOKEN_WITH_AUTH_SCHEME){if(t.tokenType&&!this.matchTokenType(e,t.tokenType))return!1;if(t.tokenType===z.SSH&&t.keyId&&!this.matchKeyId(e,t.keyId))return!1}return!0}getAppMetadataFilteredBy(e){const t=this.getKeys(),r={};return t.forEach((t=>{if(!this.isAppMetadata(t))return;const n=this.getAppMetadata(t);n&&(e.environment&&!this.matchEnvironment(n,e.environment)||e.clientId&&!this.matchClientId(n,e.clientId)||(r[t]=n))})),r}getAuthorityMetadataByAlias(e){const t=this.getAuthorityMetadataKeys();let r=null;return t.forEach((t=>{if(!this.isAuthorityMetadata(t)||-1===t.indexOf(this.clientId))return;const n=this.getAuthorityMetadata(t);n&&-1!==n.aliases.indexOf(e)&&(r=n)})),r}async removeAllAccounts(){const e=this.getAccountKeys(),t=[];e.forEach((e=>{t.push(this.removeAccount(e))})),await Promise.all(t)}async removeAccount(e){const t=this.getAccount(e,this.commonLogger);t&&(await this.removeAccountContext(t),this.removeItem(e))}async removeAccountContext(e){const t=this.getTokenKeys(),r=e.generateAccountId(),n=[];t.idToken.forEach((e=>{0===e.indexOf(r)&&this.removeIdToken(e)})),t.accessToken.forEach((e=>{0===e.indexOf(r)&&n.push(this.removeAccessToken(e))})),t.refreshToken.forEach((e=>{0===e.indexOf(r)&&this.removeRefreshToken(e)})),await Promise.all(n)}updateOutdatedCachedAccount(e,t,r){if(t&&t.isSingleTenant()){this.commonLogger?.verbose("updateOutdatedCachedAccount: Found a single-tenant (outdated) account entity in the cache, migrating to multi-tenant account entity");const n=this.getAccountKeys().filter((e=>e.startsWith(t.homeAccountId))),o=[];n.forEach((e=>{const t=this.getCachedAccountEntity(e);t&&o.push(t)}));const i=o.find((e=>tenantIdMatchesHomeTenant(e.realm,e.homeAccountId)))||o[0];i.tenantProfiles=o.map((e=>({tenantId:e.realm,localAccountId:e.localAccountId,name:e.name,isHomeTenant:tenantIdMatchesHomeTenant(e.realm,e.homeAccountId)})));const a=CacheManager.toObject(new AccountEntity,{...i}),s=a.generateAccountKey();return n.forEach((t=>{t!==s&&this.removeOutdatedAccount(e)})),this.setAccount(a),r?.verbose("Updated an outdated account entity in the cache"),a}return t}async removeAccessToken(e){const t=this.getAccessTokenCredential(e);if(t){if(t.credentialType.toLowerCase()===x.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase()&&t.tokenType===z.POP){const e=t.keyId;if(e)try{await this.cryptoImpl.removeTokenBindingKey(e)}catch(e){throw createClientAuthError(Qt)}}return this.removeItem(e)}}removeAppMetadata(){return this.getKeys().forEach((e=>{this.isAppMetadata(e)&&this.removeItem(e)})),!0}readAccountFromCache(e){const t=AccountEntity.generateAccountCacheKey(e);return this.getAccount(t,this.commonLogger)}getIdToken(e,t,r,n,o){this.commonLogger.trace("CacheManager - getIdToken called");const i={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:x.ID_TOKEN,clientId:this.clientId,realm:r},a=this.getIdTokensByFilter(i,t),s=a.size;if(s<1)return this.commonLogger.info("CacheManager:getIdToken - No token found"),null;if(s>1){let t=a;if(!r){const r=new Map;a.forEach(((t,n)=>{t.realm===e.tenantId&&r.set(n,t)}));const n=r.size;if(n<1)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account but none match account entity tenant id, returning first result"),a.values().next().value;if(1===n)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account, defaulting to home tenant profile"),r.values().next().value;t=r}return this.commonLogger.info("CacheManager:getIdToken - Multiple matching ID tokens found, clearing them"),t.forEach(((e,t)=>{this.removeIdToken(t)})),n&&o&&n.addFields({multiMatchedID:a.size},o),null}return this.commonLogger.info("CacheManager:getIdToken - Returning ID token"),a.values().next().value}getIdTokensByFilter(e,t){const r=t&&t.idToken||this.getTokenKeys().idToken,n=new Map;return r.forEach((t=>{if(!this.idTokenKeyMatchesFilter(t,{clientId:this.clientId,...e}))return;const r=this.getIdTokenCredential(t);r&&this.credentialMatchesFilter(r,e)&&n.set(t,r)})),n}idTokenKeyMatchesFilter(e,t){const r=e.toLowerCase();return(!t.clientId||-1!==r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase()))}removeIdToken(e){this.removeItem(e)}removeRefreshToken(e){this.removeItem(e)}getAccessToken(e,t,r,n,o,i){this.commonLogger.trace("CacheManager - getAccessToken called");const a=ScopeSet.createSearchScopes(t.scopes),s=t.authenticationScheme||z.BEARER,c=s&&s.toLowerCase()!==z.BEARER.toLowerCase()?x.ACCESS_TOKEN_WITH_AUTH_SCHEME:x.ACCESS_TOKEN,l={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:c,clientId:this.clientId,realm:n||e.tenantId,target:a,tokenType:s,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash},u=r&&r.accessToken||this.getTokenKeys().accessToken,d=[];u.forEach((e=>{if(this.accessTokenKeyMatchesFilter(e,l,!0)){const t=this.getAccessTokenCredential(e);t&&this.credentialMatchesFilter(t,l)&&d.push(t)}}));const h=d.length;return h<1?(this.commonLogger.info("CacheManager:getAccessToken - No token found"),null):h>1?(this.commonLogger.info("CacheManager:getAccessToken - Multiple access tokens found, clearing them"),d.forEach((e=>{this.removeAccessToken(generateCredentialKey(e))})),o&&i&&o.addFields({multiMatchedAT:d.length},i),null):(this.commonLogger.info("CacheManager:getAccessToken - Returning access token"),d[0])}accessTokenKeyMatchesFilter(e,t,r){const n=e.toLowerCase();if(t.clientId&&-1===n.indexOf(t.clientId.toLowerCase()))return!1;if(t.homeAccountId&&-1===n.indexOf(t.homeAccountId.toLowerCase()))return!1;if(t.realm&&-1===n.indexOf(t.realm.toLowerCase()))return!1;if(t.requestedClaimsHash&&-1===n.indexOf(t.requestedClaimsHash.toLowerCase()))return!1;if(t.target){const e=t.target.asArray();for(let t=0;t<e.length;t++){if(r&&!n.includes(e[t].toLowerCase()))return!1;if(!r&&n.includes(e[t].toLowerCase()))return!0}}return!0}getAccessTokensByFilter(e){const t=this.getTokenKeys(),r=[];return t.accessToken.forEach((t=>{if(!this.accessTokenKeyMatchesFilter(t,e,!0))return;const n=this.getAccessTokenCredential(t);n&&this.credentialMatchesFilter(n,e)&&r.push(n)})),r}getRefreshToken(e,t,r,n,o){this.commonLogger.trace("CacheManager - getRefreshToken called");const i=t?H:void 0,a={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:x.REFRESH_TOKEN,clientId:this.clientId,familyId:i},s=r&&r.refreshToken||this.getTokenKeys().refreshToken,c=[];s.forEach((e=>{if(this.refreshTokenKeyMatchesFilter(e,a)){const t=this.getRefreshTokenCredential(e);t&&this.credentialMatchesFilter(t,a)&&c.push(t)}}));const l=c.length;return l<1?(this.commonLogger.info("CacheManager:getRefreshToken - No refresh token found."),null):(l>1&&n&&o&&n.addFields({multiMatchedRT:l},o),this.commonLogger.info("CacheManager:getRefreshToken - returning refresh token"),c[0])}refreshTokenKeyMatchesFilter(e,t){const r=e.toLowerCase();return(!t.familyId||-1!==r.indexOf(t.familyId.toLowerCase()))&&(!(!t.familyId&&t.clientId&&-1===r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase())))}readAppMetadataFromCache(e){const t={environment:e,clientId:this.clientId},r=this.getAppMetadataFilteredBy(t),n=Object.keys(r).map((e=>r[e])),o=n.length;if(o<1)return null;if(o>1)throw createClientAuthError(Ot);return n[0]}isAppMetadataFOCI(e){const t=this.readAppMetadataFromCache(e);return!(!t||t.familyId!==H)}matchHomeAccountId(e,t){return!("string"!=typeof e.homeAccountId||t!==e.homeAccountId)}matchLocalAccountIdFromTokenClaims(e,t){return t===(e.oid||e.sub)}matchLocalAccountIdFromTenantProfile(e,t){return e.localAccountId===t}matchName(e,t){return!(t.toLowerCase()!==e.name?.toLowerCase())}matchUsername(e,t){return!(!e||"string"!=typeof e||t?.toLowerCase()!==e.toLowerCase())}matchUserAssertionHash(e,t){return!(!e.userAssertionHash||t!==e.userAssertionHash)}matchEnvironment(e,t){if(this.staticAuthorityOptions){const r=function getAliasesFromStaticSources(e,t){let r;const n=e.canonicalAuthority;if(n){const o=new UrlString(n).getUrlComponents().HostNameAndPort;r=getAliasesFromMetadata(o,e.cloudDiscoveryMetadata?.metadata,j,t)||getAliasesFromMetadata(o,ar.metadata,B,t)||e.knownAuthorities}return r||[]}(this.staticAuthorityOptions,this.commonLogger);if(r.includes(t)&&r.includes(e.environment))return!0}const r=this.getAuthorityMetadataByAlias(t);return!!(r&&r.aliases.indexOf(e.environment)>-1)}matchCredentialType(e,t){return e.credentialType&&t.toLowerCase()===e.credentialType.toLowerCase()}matchClientId(e,t){return!(!e.clientId||t!==e.clientId)}matchFamilyId(e,t){return!(!e.familyId||t!==e.familyId)}matchRealm(e,t){return!(e.realm?.toLowerCase()!==t.toLowerCase())}matchNativeAccountId(e,t){return!(!e.nativeAccountId||t!==e.nativeAccountId)}matchLoginHintFromTokenClaims(e,t){return e.login_hint===t||(e.preferred_username===t||e.upn===t)}matchSid(e,t){return e.sid===t}matchAuthorityType(e,t){return!(!e.authorityType||t.toLowerCase()!==e.authorityType.toLowerCase())}matchTarget(e,t){if(e.credentialType!==x.ACCESS_TOKEN&&e.credentialType!==x.ACCESS_TOKEN_WITH_AUTH_SCHEME||!e.target)return!1;return ScopeSet.fromString(e.target).containsScopeSet(t)}matchTokenType(e,t){return!(!e.tokenType||e.tokenType!==t)}matchKeyId(e,t){return!(!e.keyId||e.keyId!==t)}isAppMetadata(e){return-1!==e.indexOf(q)}isAuthorityMetadata(e){return-1!==e.indexOf(D)}generateAuthorityMetadataCacheKey(e){return`${D}-${this.clientId}-${e}`}static toObject(e,t){for(const r in t)e[r]=t[r];return e}}class DefaultStorageClass extends CacheManager{setAccount(){throw createClientAuthError(rr)}getAccount(){throw createClientAuthError(rr)}getCachedAccountEntity(){throw createClientAuthError(rr)}setIdTokenCredential(){throw createClientAuthError(rr)}getIdTokenCredential(){throw createClientAuthError(rr)}setAccessTokenCredential(){throw createClientAuthError(rr)}getAccessTokenCredential(){throw createClientAuthError(rr)}setRefreshTokenCredential(){throw createClientAuthError(rr)}getRefreshTokenCredential(){throw createClientAuthError(rr)}setAppMetadata(){throw createClientAuthError(rr)}getAppMetadata(){throw createClientAuthError(rr)}setServerTelemetry(){throw createClientAuthError(rr)}getServerTelemetry(){throw createClientAuthError(rr)}setAuthorityMetadata(){throw createClientAuthError(rr)}getAuthorityMetadata(){throw createClientAuthError(rr)}getAuthorityMetadataKeys(){throw createClientAuthError(rr)}setThrottlingCache(){throw createClientAuthError(rr)}getThrottlingCache(){throw createClientAuthError(rr)}removeItem(){throw createClientAuthError(rr)}getKeys(){throw createClientAuthError(rr)}getAccountKeys(){throw createClientAuthError(rr)}getTokenKeys(){throw createClientAuthError(rr)}async clear(){throw createClientAuthError(rr)}updateCredentialCacheKey(){throw createClientAuthError(rr)}removeOutdatedAccount(){throw createClientAuthError(rr)}}const Vr={tokenRenewalOffsetSeconds:300,preventCorsPreflight:!1},Yr={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:je.Info,correlationId:n.EMPTY_STRING},Wr={claimsBasedCachingEnabled:!1},Qr={async sendGetRequestAsync(){throw createClientAuthError(rr)},async sendPostRequestAsync(){throw createClientAuthError(rr)}},Jr={sku:n.SKU,version:Br,cpu:n.EMPTY_STRING,os:n.EMPTY_STRING},Zr={clientSecret:n.EMPTY_STRING,clientAssertion:void 0},Xr={azureCloudInstance:ur,tenant:`${n.DEFAULT_COMMON_TENANT}`},en={application:{appName:"",appVersion:""}};function isOidcProtocolMode(e){return e.authOptions.authority.options.protocolMode===lr}class ThrottlingUtils{static generateThrottlingStorageKey(e){return`${Y}.${JSON.stringify(e)}`}static preProcess(e,t){const r=ThrottlingUtils.generateThrottlingStorageKey(t),o=e.getThrottlingCache(r);if(o){if(o.throttleTime<Date.now())return void e.removeItem(r);throw new ServerError(o.errorCodes?.join(" ")||n.EMPTY_STRING,o.errorMessage,o.subError)}}static postProcess(e,t,r){if(ThrottlingUtils.checkResponseStatus(r)||ThrottlingUtils.checkResponseForRetryAfter(r)){const n={throttleTime:ThrottlingUtils.calculateThrottleTime(parseInt(r.headers[f])),error:r.body.error,errorCodes:r.body.error_codes,errorMessage:r.body.error_description,subError:r.body.suberror};e.setThrottlingCache(ThrottlingUtils.generateThrottlingStorageKey(t),n)}}static checkResponseStatus(e){return 429===e.status||e.status>=500&&e.status<600}static checkResponseForRetryAfter(e){return!!e.headers&&(e.headers.hasOwnProperty(f)&&(e.status<200||e.status>=300))}static calculateThrottleTime(e){const t=e<=0?0:e,r=Date.now()/1e3;return Math.floor(1e3*Math.min(r+(t||G),r+V))}static removeThrottle(e,t,r,n){const o={clientId:t,authority:r.authority,scopes:r.scopes,homeAccountIdentifier:n,claims:r.claims,authenticationScheme:r.authenticationScheme,resourceRequestMethod:r.resourceRequestMethod,resourceRequestUri:r.resourceRequestUri,shrClaims:r.shrClaims,sshKid:r.sshKid},i=this.generateThrottlingStorageKey(o);e.removeItem(i)}}class NetworkManager{constructor(e,t){this.networkClient=e,this.cacheManager=t}async sendPostRequest(e,t,r){let n;ThrottlingUtils.preProcess(this.cacheManager,e);try{n=await this.networkClient.sendPostRequestAsync(t,r)}catch(e){throw e instanceof AuthError?e:createClientAuthError(At)}return ThrottlingUtils.postProcess(this.cacheManager,e,n),n}}const tn="home_account_id",rn="UPN",nn="client_id",on="response_type",an="token_type",sn="req_cnf",cn="return_spa_code";class RequestValidator{static validateRedirectUri(e){if(!e)throw ClientConfigurationError_createClientConfigurationError(ze)}static validatePrompt(e){const t=[];for(const e in I)t.push(I[e]);if(t.indexOf(e)<0)throw ClientConfigurationError_createClientConfigurationError(Je)}static validateClaims(e){try{JSON.parse(e)}catch(e){throw ClientConfigurationError_createClientConfigurationError(Ze)}}static validateCodeChallengeParams(e,t){if(!e||!t)throw ClientConfigurationError_createClientConfigurationError(rt);this.validateCodeChallengeMethod(t)}static validateCodeChallengeMethod(e){if([E.PLAIN,E.S256].indexOf(e)<0)throw ClientConfigurationError_createClientConfigurationError(tt)}static sanitizeEQParams(e,t){return e?(t.forEach(((t,r)=>{e[r]&&delete e[r]})),Object.fromEntries(Object.entries(e).filter((e=>""!==e[1])))):{}}}class RequestParameterBuilder{constructor(){this.parameters=new Map}addResponseTypeCode(){this.parameters.set(on,encodeURIComponent(n.CODE_RESPONSE_TYPE))}addResponseTypeForTokenAndIdToken(){this.parameters.set(on,encodeURIComponent(`${n.TOKEN_RESPONSE_TYPE} ${n.ID_TOKEN_RESPONSE_TYPE}`))}addResponseMode(e){this.parameters.set("response_mode",encodeURIComponent(e||w.QUERY))}addNativeBroker(){this.parameters.set("nativebroker",encodeURIComponent("1"))}addScopes(e,t=!0,r=h){!t||r.includes("openid")||e.includes("openid")||r.push("openid");const n=t?[...e||[],...r]:e||[],o=new ScopeSet(n);this.parameters.set("scope",encodeURIComponent(o.printScopes()))}addClientId(e){this.parameters.set(nn,encodeURIComponent(e))}addRedirectUri(e){RequestValidator.validateRedirectUri(e),this.parameters.set("redirect_uri",encodeURIComponent(e))}addPostLogoutRedirectUri(e){RequestValidator.validateRedirectUri(e),this.parameters.set("post_logout_redirect_uri",encodeURIComponent(e))}addIdTokenHint(e){this.parameters.set("id_token_hint",encodeURIComponent(e))}addDomainHint(e){this.parameters.set("domain_hint",encodeURIComponent(e))}addLoginHint(e){this.parameters.set("login_hint",encodeURIComponent(e))}addCcsUpn(e){this.parameters.set(m,encodeURIComponent(`UPN:${e}`))}addCcsOid(e){this.parameters.set(m,encodeURIComponent(`Oid:${e.uid}@${e.utid}`))}addSid(e){this.parameters.set("sid",encodeURIComponent(e))}addClaims(e,t){const r=this.addClientCapabilitiesToClaims(e,t);RequestValidator.validateClaims(r),this.parameters.set("claims",encodeURIComponent(r))}addCorrelationId(e){this.parameters.set("client-request-id",encodeURIComponent(e))}addLibraryInfo(e){this.parameters.set("x-client-SKU",e.sku),this.parameters.set("x-client-VER",e.version),e.os&&this.parameters.set("x-client-OS",e.os),e.cpu&&this.parameters.set("x-client-CPU",e.cpu)}addApplicationTelemetry(e){e?.appName&&this.parameters.set("x-app-name",e.appName),e?.appVersion&&this.parameters.set("x-app-ver",e.appVersion)}addPrompt(e){RequestValidator.validatePrompt(e),this.parameters.set("prompt",encodeURIComponent(e))}addState(e){e&&this.parameters.set("state",encodeURIComponent(e))}addNonce(e){this.parameters.set("nonce",encodeURIComponent(e))}addCodeChallengeParams(e,t){if(RequestValidator.validateCodeChallengeParams(e,t),!e||!t)throw ClientConfigurationError_createClientConfigurationError(rt);this.parameters.set("code_challenge",encodeURIComponent(e)),this.parameters.set("code_challenge_method",encodeURIComponent(t))}addAuthorizationCode(e){this.parameters.set("code",encodeURIComponent(e))}addDeviceCode(e){this.parameters.set("device_code",encodeURIComponent(e))}addRefreshToken(e){this.parameters.set("refresh_token",encodeURIComponent(e))}addCodeVerifier(e){this.parameters.set("code_verifier",encodeURIComponent(e))}addClientSecret(e){this.parameters.set("client_secret",encodeURIComponent(e))}addClientAssertion(e){e&&this.parameters.set("client_assertion",encodeURIComponent(e))}addClientAssertionType(e){e&&this.parameters.set("client_assertion_type",encodeURIComponent(e))}addOboAssertion(e){this.parameters.set("assertion",encodeURIComponent(e))}addRequestTokenUse(e){this.parameters.set("requested_token_use",encodeURIComponent(e))}addGrantType(e){this.parameters.set("grant_type",encodeURIComponent(e))}addClientInfo(){this.parameters.set("client_info","1")}addExtraQueryParameters(e){const t=RequestValidator.sanitizeEQParams(e,this.parameters);Object.keys(t).forEach((t=>{this.parameters.set(t,e[t])}))}addClientCapabilitiesToClaims(e,t){let r;if(e)try{r=JSON.parse(e)}catch(e){throw ClientConfigurationError_createClientConfigurationError(Ze)}else r={};return t&&t.length>0&&(r.hasOwnProperty(T)||(r[T]={}),r[T][S]={values:t}),JSON.stringify(r)}addUsername(e){this.parameters.set(Z,encodeURIComponent(e))}addPassword(e){this.parameters.set(X,encodeURIComponent(e))}addPopToken(e){e&&(this.parameters.set(an,z.POP),this.parameters.set(sn,encodeURIComponent(e)))}addSshJwk(e){e&&(this.parameters.set(an,z.SSH),this.parameters.set(sn,encodeURIComponent(e)))}addServerTelemetry(e){this.parameters.set("x-client-current-telemetry",e.generateCurrentRequestHeaderValue()),this.parameters.set("x-client-last-telemetry",e.generateLastRequestHeaderValue())}addThrottling(){this.parameters.set("x-ms-lib-capability",W)}addLogoutHint(e){this.parameters.set("logout_hint",encodeURIComponent(e))}createQueryString(){const e=new Array;return this.parameters.forEach(((t,r)=>{e.push(`${r}=${t}`)})),e.join("&")}}async function createDiscoveredInstance(e,t,r,n,o,i,a){a?.addQueueMeasurement(Rr,i);const s=Authority_Authority.transformCIAMAuthority(formatAuthorityUri(e)),c=new Authority_Authority(s,t,r,n,o,i,a);try{return await jr(c.resolveEndpointsAsync.bind(c),Or,o,a,i)(),c}catch(e){throw createClientAuthError(Ct)}}class BaseClient{constructor(e,t){this.config=function buildClientConfiguration({authOptions:e,systemOptions:t,loggerOptions:r,cacheOptions:n,storageInterface:o,networkInterface:i,cryptoInterface:a,clientCredentials:s,libraryInfo:c,telemetry:l,serverTelemetryManager:u,persistencePlugin:d,serializableCache:h}){const p={...Yr,...r};return{authOptions:(g=e,{clientCapabilities:[],azureCloudOptions:Xr,skipAuthorityMetadataCache:!1,...g}),systemOptions:{...Vr,...t},loggerOptions:p,cacheOptions:{...Wr,...n},storageInterface:o||new DefaultStorageClass(e.clientId,Fr,new Logger_Logger(p)),networkInterface:i||Qr,cryptoInterface:a||Fr,clientCredentials:s||Zr,libraryInfo:{...Jr,...c},telemetry:{...en,...l},serverTelemetryManager:u||null,persistencePlugin:d||null,serializableCache:h||null};var g}(e),this.logger=new Logger_Logger(this.config.loggerOptions,Kr,Br),this.cryptoUtils=this.config.cryptoInterface,this.cacheManager=this.config.storageInterface,this.networkClient=this.config.networkInterface,this.networkManager=new NetworkManager(this.networkClient,this.cacheManager),this.serverTelemetryManager=this.config.serverTelemetryManager,this.authority=this.config.authOptions.authority,this.performanceClient=t}createTokenRequestHeaders(e){const t={};if(t[g]=n.URL_FORM_CONTENT_TYPE,!this.config.systemOptions.preventCorsPreflight&&e)switch(e.type){case tn:try{const r=buildClientInfoFromHomeAccountId(e.credential);t[m]=`Oid:${r.uid}@${r.utid}`}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case rn:t[m]=`UPN: ${e.credential}`}return t}async executePostToTokenEndpoint(e,t,r,n,o,i){i&&this.performanceClient?.addQueueMeasurement(i,o);const a=await this.networkManager.sendPostRequest(n,e,{body:t,headers:r});return this.performanceClient?.addFields({refreshTokenSize:a.body.refresh_token?.length||0,httpVerToken:a.headers?.[C]||""},o),this.config.serverTelemetryManager&&a.status<500&&429!==a.status&&this.config.serverTelemetryManager.clearTelemetryCache(),a}async updateAuthority(e,t){this.performanceClient?.addQueueMeasurement(Sr,t);const r=`https://${e}/${this.authority.tenant}/`,n=await createDiscoveredInstance(r,this.networkClient,this.cacheManager,this.authority.options,this.logger,t,this.performanceClient);this.authority=n}createTokenQueryParameters(e){const t=new RequestParameterBuilder;return e.tokenQueryParameters&&t.addExtraQueryParameters(e.tokenQueryParameters),t.createQueryString()}}const ln="no_tokens_found",un="native_account_unavailable",dn="refresh_token_expired",hn="bad_token",pn=["interaction_required","consent_required","login_required",hn],gn=["message_only","additional_action","basic_action","user_password_expired","consent_required","bad_token"],fn={[ln]:"No refresh token found in the cache. Please sign-in.",[un]:"The requested account is not available in the native broker. It may have been deleted or logged out. Please sign-in again using an interactive API.",[dn]:"Refresh token has expired.",[hn]:"Identity provider returned bad_token due to an expired or invalid refresh token. Please invoke an interactive API to resolve."};class InteractionRequiredAuthError extends AuthError{constructor(e,t,r,o,i,a,s,c){super(e,t,r),Object.setPrototypeOf(this,InteractionRequiredAuthError.prototype),this.timestamp=o||n.EMPTY_STRING,this.traceId=i||n.EMPTY_STRING,this.correlationId=a||n.EMPTY_STRING,this.claims=s||n.EMPTY_STRING,this.name="InteractionRequiredAuthError",this.errorNo=c}}function isInteractionRequiredError(e,t,r){const n=!!e&&pn.indexOf(e)>-1,o=!!r&&gn.indexOf(r)>-1,i=!!t&&pn.some((e=>t.indexOf(e)>-1));return n||i||o}function createInteractionRequiredAuthError(e){return new InteractionRequiredAuthError(e,fn[e])}class CacheRecord{constructor(e,t,r,n,o){this.account=e||null,this.idToken=t||null,this.accessToken=r||null,this.refreshToken=n||null,this.appMetadata=o||null}}class ProtocolUtils{static setRequestState(e,t,r){const o=ProtocolUtils.generateLibraryState(e,r);return t?`${o}${n.RESOURCE_DELIM}${t}`:o}static generateLibraryState(e,t){if(!e)throw createClientAuthError(Kt);const r={id:e.createNewGuid()};t&&(r.meta=t);const n=JSON.stringify(r);return e.base64Encode(n)}static parseRequestState(e,t){if(!e)throw createClientAuthError(Kt);if(!t)throw createClientAuthError(It);try{const r=t.split(n.RESOURCE_DELIM),o=r[0],i=r.length>1?r.slice(1).join(n.RESOURCE_DELIM):n.EMPTY_STRING,a=e.base64Decode(o),s=JSON.parse(a);return{userRequestState:i||n.EMPTY_STRING,libraryState:s}}catch(e){throw createClientAuthError(It)}}}const mn="sw";class PopTokenGenerator{constructor(e,t){this.cryptoUtils=e,this.performanceClient=t}async generateCnf(e,t){this.performanceClient?.addQueueMeasurement(kr,e.correlationId);const r=await jr(this.generateKid.bind(this),kr,t,this.performanceClient,e.correlationId)(e),n=this.cryptoUtils.base64UrlEncode(JSON.stringify(r));return{kid:r.kid,reqCnfString:n}}async generateKid(e){this.performanceClient?.addQueueMeasurement(br,e.correlationId);return{kid:await this.cryptoUtils.getPublicKeyThumbprint(e),xms_ksl:mn}}async signPopToken(e,t,r){return this.signPayload(e,t,r)}async signPayload(e,t,r,n){const{resourceRequestMethod:o,resourceRequestUri:i,shrClaims:a,shrNonce:s,shrOptions:c}=r,l=i?new UrlString(i):void 0,u=l?.getUrlComponents();return this.cryptoUtils.signJwt({at:e,ts:nowSeconds(),m:o?.toUpperCase(),u:u?.HostNameAndPort,nonce:s||this.cryptoUtils.createNewGuid(),p:u?.AbsolutePath,q:u?.QueryString?[[],u.QueryString]:void 0,client_claims:a||void 0,...n},t,c,r.correlationId)}}class TokenCacheContext{constructor(e,t){this.cache=e,this.hasChanged=t}get cacheHasChanged(){return this.hasChanged}get tokenCache(){return this.cache}}class ResponseHandler{constructor(e,t,r,n,o,i,a){this.clientId=e,this.cacheStorage=t,this.cryptoObj=r,this.logger=n,this.serializableCache=o,this.persistencePlugin=i,this.performanceClient=a}validateServerAuthorizationCodeResponse(e,t){if(!e.state||!t)throw e.state?createClientAuthError(wt,"Cached State"):createClientAuthError(wt,"Server State");let r,n;try{r=decodeURIComponent(e.state)}catch(t){throw createClientAuthError(It,e.state)}try{n=decodeURIComponent(t)}catch(t){throw createClientAuthError(It,e.state)}if(r!==n)throw createClientAuthError(Et);if(e.error||e.error_description||e.suberror){const t=function parseServerErrorNo(e){const t="code=",r=e.error_uri?.lastIndexOf(t);return r&&r>=0?e.error_uri?.substring(r+5):void 0}(e);if(isInteractionRequiredError(e.error,e.error_description,e.suberror))throw new InteractionRequiredAuthError(e.error||"",e.error_description,e.suberror,e.timestamp||"",e.trace_id||"",e.correlation_id||"",e.claims||"",t);throw new ServerError(e.error||"",e.error_description,e.suberror,t)}}validateTokenResponse(e,t){if(e.error||e.error_description||e.suberror){const r=`${e.error_codes} - [${e.timestamp}]: ${e.error_description} - Correlation ID: ${e.correlation_id} - Trace ID: ${e.trace_id}`,o=e.error_codes?.length?e.error_codes[0]:void 0,i=new ServerError(e.error,r,e.suberror,o);if(t&&e.status&&e.status>=u&&e.status<=d)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently unavailable and the access token is unable to be refreshed.\n${i}`);if(t&&e.status&&e.status>=s&&e.status<=c)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently available but is unable to refresh the access token.\n${i}`);if(isInteractionRequiredError(e.error,e.error_description,e.suberror))throw new InteractionRequiredAuthError(e.error,e.error_description,e.suberror,e.timestamp||n.EMPTY_STRING,e.trace_id||n.EMPTY_STRING,e.correlation_id||n.EMPTY_STRING,e.claims||n.EMPTY_STRING,o);throw i}}async handleServerTokenResponse(e,t,r,o,i,a,s,c,l){let u,d;if(this.performanceClient?.addQueueMeasurement(_r,e.correlation_id),e.id_token){if(u=extractTokenClaims(e.id_token||n.EMPTY_STRING,this.cryptoObj.base64Decode),i&&i.nonce&&u.nonce!==i.nonce)throw createClientAuthError(vt);if(o.maxAge||0===o.maxAge){const e=u.auth_time;if(!e)throw createClientAuthError(kt);checkMaxAge(e,o.maxAge)}}this.homeAccountIdentifier=AccountEntity.generateHomeAccountId(e.client_info||n.EMPTY_STRING,t.authorityType,this.logger,this.cryptoObj,u),i&&i.state&&(d=ProtocolUtils.parseRequestState(this.cryptoObj,i.state)),e.key_id=e.key_id||o.sshKid||void 0;const h=this.generateCacheRecord(e,t,r,o,u,a,i);let p;try{if(this.persistencePlugin&&this.serializableCache&&(this.logger.verbose("Persistence enabled, calling beforeCacheAccess"),p=new TokenCacheContext(this.serializableCache,!0),await this.persistencePlugin.beforeCacheAccess(p)),s&&!c&&h.account){const e=h.account.generateAccountKey();if(!this.cacheStorage.getAccount(e,this.logger))return this.logger.warning("Account used to refresh tokens not in persistence, refreshed tokens will not be stored in the cache"),await ResponseHandler.generateAuthenticationResult(this.cryptoObj,t,h,!1,o,u,d,void 0,l)}await this.cacheStorage.saveCacheRecord(h,o.storeInCache,o.correlationId)}finally{this.persistencePlugin&&this.serializableCache&&p&&(this.logger.verbose("Persistence enabled, calling afterCacheAccess"),await this.persistencePlugin.afterCacheAccess(p))}return ResponseHandler.generateAuthenticationResult(this.cryptoObj,t,h,!1,o,u,d,e,l)}generateCacheRecord(e,t,r,n,o,i,a){const s=t.getPreferredCache();if(!s)throw createClientAuthError(jt);const c=getTenantIdFromIdTokenClaims(o);let l,u;e.id_token&&o&&(l=function createIdTokenEntity(e,t,r,n,o){return{credentialType:x.ID_TOKEN,homeAccountId:e,environment:t,clientId:n,secret:r,realm:o}}(this.homeAccountIdentifier,s,e.id_token,this.clientId,c||""),u=function buildAccountToCache(e,t,r,n,o,i,a,s,c,l,u){u?.verbose("setCachedAccount called");const d=e.getAccountKeys().find((e=>e.startsWith(r)));let h=null;d&&(h=e.getAccount(d,u));const p=h||AccountEntity.createAccount({homeAccountId:r,idTokenClaims:n,clientInfo:i,environment:a,cloudGraphHostName:c?.cloud_graph_host_name,msGraphHost:c?.msgraph_host,nativeAccountId:l},t,o),g=p.tenantProfiles||[];if(s&&!g.find((e=>e.tenantId===s))){const e=buildTenantProfileFromIdTokenClaims(r,n);g.push(e)}return p.tenantProfiles=g,p}(this.cacheStorage,t,this.homeAccountIdentifier,o,this.cryptoObj.base64Decode,e.client_info,s,c,a,void 0,this.logger));let d=null;if(e.access_token){const o=e.scope?ScopeSet.fromString(e.scope):new ScopeSet(n.scopes||[]),a=("string"==typeof e.expires_in?parseInt(e.expires_in,10):e.expires_in)||0,l=("string"==typeof e.ext_expires_in?parseInt(e.ext_expires_in,10):e.ext_expires_in)||0,u=("string"==typeof e.refresh_in?parseInt(e.refresh_in,10):e.refresh_in)||void 0,h=r+a,p=h+l,g=u&&u>0?r+u:void 0;d=function createAccessTokenEntity(e,t,r,n,o,i,a,s,c,l,u,d,h,p,g){const f={homeAccountId:e,credentialType:x.ACCESS_TOKEN,secret:r,cachedAt:nowSeconds().toString(),expiresOn:a.toString(),extendedExpiresOn:s.toString(),environment:t,clientId:n,realm:o,target:i,tokenType:u||z.BEARER};if(d&&(f.userAssertionHash=d),l&&(f.refreshOn=l.toString()),p&&(f.requestedClaims=p,f.requestedClaimsHash=g),f.tokenType?.toLowerCase()!==z.BEARER.toLowerCase())switch(f.credentialType=x.ACCESS_TOKEN_WITH_AUTH_SCHEME,f.tokenType){case z.POP:const e=extractTokenClaims(r,c);if(!e?.cnf?.kid)throw createClientAuthError(Yt);f.keyId=e.cnf.kid;break;case z.SSH:f.keyId=h}return f}(this.homeAccountIdentifier,s,e.access_token,this.clientId,c||t.tenant||"",o.printScopes(),h,p,this.cryptoObj.base64Decode,g,e.token_type,i,e.key_id,n.claims,n.requestedClaimsHash)}let h=null;if(e.refresh_token){let t;if(e.refresh_token_expires_in){t=r+("string"==typeof e.refresh_token_expires_in?parseInt(e.refresh_token_expires_in,10):e.refresh_token_expires_in)}h=function createRefreshTokenEntity(e,t,r,n,o,i,a){const s={credentialType:x.REFRESH_TOKEN,homeAccountId:e,environment:t,clientId:n,secret:r};return i&&(s.userAssertionHash=i),o&&(s.familyId=o),a&&(s.expiresOn=a.toString()),s}(this.homeAccountIdentifier,s,e.refresh_token,this.clientId,e.foci,i,t)}let p=null;return e.foci&&(p={clientId:this.clientId,environment:s,familyId:e.foci}),new CacheRecord(u,l,d,h,p)}static async generateAuthenticationResult(e,t,r,o,i,a,s,c,l){let u,d,h=n.EMPTY_STRING,p=[],g=null,f=n.EMPTY_STRING;if(r.accessToken){if(r.accessToken.tokenType!==z.POP||i.popKid)h=r.accessToken.secret;else{const t=new PopTokenGenerator(e),{secret:n,keyId:o}=r.accessToken;if(!o)throw createClientAuthError(Zt);h=await t.signPopToken(n,o,i)}p=ScopeSet.fromString(r.accessToken.target).asArray(),g=new Date(1e3*Number(r.accessToken.expiresOn)),u=new Date(1e3*Number(r.accessToken.extendedExpiresOn)),r.accessToken.refreshOn&&(d=new Date(1e3*Number(r.accessToken.refreshOn)))}r.appMetadata&&(f=r.appMetadata.familyId===H?H:"");const m=a?.oid||a?.sub||"",y=a?.tid||"";c?.spa_accountid&&r.account&&(r.account.nativeAccountId=c?.spa_accountid);const C=r.account?updateAccountTenantProfileData(r.account.getAccountInfo(),void 0,a,r.idToken?.secret):null;return{authority:t.canonicalAuthority,uniqueId:m,tenantId:y,scopes:p,account:C,idToken:r?.idToken?.secret||"",idTokenClaims:a||{},accessToken:h,fromCache:o,expiresOn:g,extExpiresOn:u,refreshOn:d,correlationId:i.correlationId,requestId:l||n.EMPTY_STRING,familyId:f,tokenType:r.accessToken?.tokenType||n.EMPTY_STRING,state:s?s.userRequestState:n.EMPTY_STRING,cloudGraphHostName:r.account?.cloudGraphHostName||n.EMPTY_STRING,msGraphHost:r.account?.msGraphHost||n.EMPTY_STRING,code:c?.spa_code,fromNativeBroker:!1}}}async function getClientAssertion(e,t,r){if("string"==typeof e)return e;return e({clientId:t,tokenEndpoint:r})}class AuthorizationCodeClient extends BaseClient{constructor(e,t){super(e,t),this.includeRedirectUri=!0,this.oidcDefaultScopes=this.config.authOptions.authority.options.OIDCOptions?.defaultScopes}async getAuthCodeUrl(e){this.performanceClient?.addQueueMeasurement(Tr,e.correlationId);const t=await jr(this.createAuthCodeUrlQueryString.bind(this),vr,this.logger,this.performanceClient,e.correlationId)(e);return UrlString.appendQueryString(this.authority.authorizationEndpoint,t)}async acquireToken(e,t){if(this.performanceClient?.addQueueMeasurement(Ir,e.correlationId),!e.code)throw createClientAuthError(Pt);const r=nowSeconds(),n=await jr(this.executeTokenRequest.bind(this),Er,this.logger,this.performanceClient,e.correlationId)(this.authority,e),o=n.headers?.[y],i=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin,this.performanceClient);return i.validateTokenResponse(n.body),jr(i.handleServerTokenResponse.bind(i),_r,this.logger,this.performanceClient,e.correlationId)(n.body,this.authority,r,e,t,void 0,void 0,void 0,o)}handleFragmentResponse(e,t){if(new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,null,null).validateServerAuthorizationCodeResponse(e,t),!e.code)throw createClientAuthError(Wt);return e}getLogoutUri(e){if(!e)throw ClientConfigurationError_createClientConfigurationError(et);const t=this.createLogoutUrlQueryString(e);return UrlString.appendQueryString(this.authority.endSessionEndpoint,t)}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(Er,t.correlationId);const r=this.createTokenQueryParameters(t),n=UrlString.appendQueryString(e.tokenEndpoint,r),o=await jr(this.createTokenRequestBody.bind(this),wr,this.logger,this.performanceClient,t.correlationId)(t);let i;if(t.clientInfo)try{const e=buildClientInfo(t.clientInfo,this.cryptoUtils.base64Decode);i={credential:`${e.uid}${U}${e.utid}`,type:tn}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}const a=this.createTokenRequestHeaders(i||t.ccsCredential),s={clientId:t.tokenBodyParameters?.clientId||this.config.authOptions.clientId,authority:e.canonicalAuthority,scopes:t.scopes,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid};return jr(this.executePostToTokenEndpoint.bind(this),hr,this.logger,this.performanceClient,t.correlationId)(n,o,a,s,t.correlationId,hr)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(wr,e.correlationId);const t=new RequestParameterBuilder;if(t.addClientId(e.tokenBodyParameters?.[nn]||this.config.authOptions.clientId),this.includeRedirectUri?t.addRedirectUri(e.redirectUri):RequestValidator.validateRedirectUri(e.redirectUri),t.addScopes(e.scopes,!0,this.oidcDefaultScopes),t.addAuthorizationCode(e.code),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&!isOidcProtocolMode(this.config)&&t.addServerTelemetry(this.serverTelemetryManager),e.codeVerifier&&t.addCodeVerifier(e.codeVerifier),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const r=this.config.clientCredentials.clientAssertion;t.addClientAssertion(await getClientAssertion(r.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(r.assertionType)}if(t.addGrantType(v),t.addClientInfo(),e.authenticationScheme===z.POP){const r=new PopTokenGenerator(this.cryptoUtils,this.performanceClient);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await jr(r.generateCnf.bind(r),kr,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}t.addPopToken(n)}else if(e.authenticationScheme===z.SSH){if(!e.sshJwk)throw ClientConfigurationError_createClientConfigurationError(at);t.addSshJwk(e.sshJwk)}const r=e.correlationId||this.config.cryptoInterface.createNewGuid();let n;if(t.addCorrelationId(r),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),e.clientInfo)try{const t=buildClientInfo(e.clientInfo,this.cryptoUtils.base64Decode);n={credential:`${t.uid}${U}${t.utid}`,type:tn}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}else n=e.ccsCredential;if(this.config.systemOptions.preventCorsPreflight&&n)switch(n.type){case tn:try{const e=buildClientInfoFromHomeAccountId(n.credential);t.addCcsOid(e)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case rn:t.addCcsUpn(n.credential)}return e.tokenBodyParameters&&t.addExtraQueryParameters(e.tokenBodyParameters),!e.enableSpaAuthorizationCode||e.tokenBodyParameters&&e.tokenBodyParameters[cn]||t.addExtraQueryParameters({[cn]:"1"}),t.createQueryString()}async createAuthCodeUrlQueryString(e){this.performanceClient?.addQueueMeasurement(vr,e.correlationId);const t=new RequestParameterBuilder;t.addClientId(e.extraQueryParameters?.[nn]||this.config.authOptions.clientId);const r=[...e.scopes||[],...e.extraScopesToConsent||[]];t.addScopes(r,!0,this.oidcDefaultScopes),t.addRedirectUri(e.redirectUri);const n=e.correlationId||this.config.cryptoInterface.createNewGuid();if(t.addCorrelationId(n),t.addResponseMode(e.responseMode),t.addResponseTypeCode(),t.addLibraryInfo(this.config.libraryInfo),isOidcProtocolMode(this.config)||t.addApplicationTelemetry(this.config.telemetry.application),t.addClientInfo(),e.codeChallenge&&e.codeChallengeMethod&&t.addCodeChallengeParams(e.codeChallenge,e.codeChallengeMethod),e.prompt&&t.addPrompt(e.prompt),e.domainHint&&t.addDomainHint(e.domainHint),e.prompt!==I.SELECT_ACCOUNT)if(e.sid&&e.prompt===I.NONE)this.logger.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from request"),t.addSid(e.sid);else if(e.account){const r=this.extractAccountSid(e.account);let n=this.extractLoginHint(e.account);if(n&&e.domainHint&&(this.logger.warning('AuthorizationCodeClient.createAuthCodeUrlQueryString: "domainHint" param is set, skipping opaque "login_hint" claim. Please consider not passing domainHint'),n=null),n){this.logger.verbose("createAuthCodeUrlQueryString: login_hint claim present on account"),t.addLoginHint(n);try{const r=buildClientInfoFromHomeAccountId(e.account.homeAccountId);t.addCcsOid(r)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(r&&e.prompt===I.NONE){this.logger.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from account"),t.addSid(r);try{const r=buildClientInfoFromHomeAccountId(e.account.homeAccountId);t.addCcsOid(r)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(e.loginHint)this.logger.verbose("createAuthCodeUrlQueryString: Adding login_hint from request"),t.addLoginHint(e.loginHint),t.addCcsUpn(e.loginHint);else if(e.account.username){this.logger.verbose("createAuthCodeUrlQueryString: Adding login_hint from account"),t.addLoginHint(e.account.username);try{const r=buildClientInfoFromHomeAccountId(e.account.homeAccountId);t.addCcsOid(r)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}}else e.loginHint&&(this.logger.verbose("createAuthCodeUrlQueryString: No account, adding login_hint from request"),t.addLoginHint(e.loginHint),t.addCcsUpn(e.loginHint));else this.logger.verbose("createAuthCodeUrlQueryString: Prompt is select_account, ignoring account hints");if(e.nonce&&t.addNonce(e.nonce),e.state&&t.addState(e.state),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),e.extraQueryParameters&&t.addExtraQueryParameters(e.extraQueryParameters),e.nativeBroker&&(t.addNativeBroker(),e.authenticationScheme===z.POP)){const r=new PopTokenGenerator(this.cryptoUtils);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await jr(r.generateCnf.bind(r),kr,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}t.addPopToken(n)}return t.createQueryString()}createLogoutUrlQueryString(e){const t=new RequestParameterBuilder;return e.postLogoutRedirectUri&&t.addPostLogoutRedirectUri(e.postLogoutRedirectUri),e.correlationId&&t.addCorrelationId(e.correlationId),e.idTokenHint&&t.addIdTokenHint(e.idTokenHint),e.state&&t.addState(e.state),e.logoutHint&&t.addLogoutHint(e.logoutHint),e.extraQueryParameters&&t.addExtraQueryParameters(e.extraQueryParameters),t.createQueryString()}extractAccountSid(e){return e.idTokenClaims?.sid||null}extractLoginHint(e){return e.idTokenClaims?.login_hint||null}}class RefreshTokenClient extends BaseClient{constructor(e,t){super(e,t)}async acquireToken(e){this.performanceClient?.addQueueMeasurement(gr,e.correlationId);const t=nowSeconds(),r=await jr(this.executeTokenRequest.bind(this),pr,this.logger,this.performanceClient,e.correlationId)(e,this.authority),n=r.headers?.[y],o=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return o.validateTokenResponse(r.body),jr(o.handleServerTokenResponse.bind(o),_r,this.logger,this.performanceClient,e.correlationId)(r.body,this.authority,t,e,void 0,void 0,!0,e.forceCache,n)}async acquireTokenByRefreshToken(e){if(!e)throw ClientConfigurationError_createClientConfigurationError(Xe);if(this.performanceClient?.addQueueMeasurement(mr,e.correlationId),!e.account)throw createClientAuthError(Dt);if(this.cacheManager.isAppMetadataFOCI(e.account.environment))try{return await jr(this.acquireTokenWithCachedRefreshToken.bind(this),fr,this.logger,this.performanceClient,e.correlationId)(e,!0)}catch(t){const r=t instanceof InteractionRequiredAuthError&&t.errorCode===ln,n=t instanceof ServerError&&t.errorCode===Q&&t.subError===J;if(r||n)return jr(this.acquireTokenWithCachedRefreshToken.bind(this),fr,this.logger,this.performanceClient,e.correlationId)(e,!1);throw t}return jr(this.acquireTokenWithCachedRefreshToken.bind(this),fr,this.logger,this.performanceClient,e.correlationId)(e,!1)}async acquireTokenWithCachedRefreshToken(e,t){this.performanceClient?.addQueueMeasurement(fr,e.correlationId);const r=((e,t,r,n,o)=>(...i)=>{r.trace(`Executing function ${t}`);const a=n?.startMeasurement(t,o);if(o){const e=t+"CallCount";n?.incrementFields({[e]:1},o)}try{const n=e(...i);return a?.end({success:!0}),r.trace(`Returning result from ${t}`),n}catch(e){r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e}})(this.cacheManager.getRefreshToken.bind(this.cacheManager),Lr,this.logger,this.performanceClient,e.correlationId)(e.account,t,void 0,this.performanceClient,e.correlationId);if(!r)throw createInteractionRequiredAuthError(ln);if(r.expiresOn&&isTokenExpired(r.expiresOn,e.refreshTokenExpirationOffsetSeconds||300))throw createInteractionRequiredAuthError(dn);const n={...e,refreshToken:r.secret,authenticationScheme:e.authenticationScheme||z.BEARER,ccsCredential:{credential:e.account.homeAccountId,type:tn}};try{return await jr(this.acquireToken.bind(this),gr,this.logger,this.performanceClient,e.correlationId)(n)}catch(e){if(e instanceof InteractionRequiredAuthError&&e.subError===hn){this.logger.verbose("acquireTokenWithRefreshToken: bad refresh token, removing from cache");const e=generateCredentialKey(r);this.cacheManager.removeRefreshToken(e)}throw e}}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(pr,e.correlationId);const r=this.createTokenQueryParameters(e),n=UrlString.appendQueryString(t.tokenEndpoint,r),o=await jr(this.createTokenRequestBody.bind(this),yr,this.logger,this.performanceClient,e.correlationId)(e),i=this.createTokenRequestHeaders(e.ccsCredential),a={clientId:e.tokenBodyParameters?.clientId||this.config.authOptions.clientId,authority:t.canonicalAuthority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};return jr(this.executePostToTokenEndpoint.bind(this),dr,this.logger,this.performanceClient,e.correlationId)(n,o,i,a,e.correlationId,dr)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(yr,e.correlationId);const t=e.correlationId,r=new RequestParameterBuilder;if(r.addClientId(e.tokenBodyParameters?.[nn]||this.config.authOptions.clientId),e.redirectUri&&r.addRedirectUri(e.redirectUri),r.addScopes(e.scopes,!0,this.config.authOptions.authority.options.OIDCOptions?.defaultScopes),r.addGrantType(_),r.addClientInfo(),r.addLibraryInfo(this.config.libraryInfo),r.addApplicationTelemetry(this.config.telemetry.application),r.addThrottling(),this.serverTelemetryManager&&!isOidcProtocolMode(this.config)&&r.addServerTelemetry(this.serverTelemetryManager),r.addCorrelationId(t),r.addRefreshToken(e.refreshToken),this.config.clientCredentials.clientSecret&&r.addClientSecret(this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const t=this.config.clientCredentials.clientAssertion;r.addClientAssertion(await getClientAssertion(t.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),r.addClientAssertionType(t.assertionType)}if(e.authenticationScheme===z.POP){const t=new PopTokenGenerator(this.cryptoUtils,this.performanceClient);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await jr(t.generateCnf.bind(t),kr,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}r.addPopToken(n)}else if(e.authenticationScheme===z.SSH){if(!e.sshJwk)throw ClientConfigurationError_createClientConfigurationError(at);r.addSshJwk(e.sshJwk)}if((!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&r.addClaims(e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.ccsCredential)switch(e.ccsCredential.type){case tn:try{const t=buildClientInfoFromHomeAccountId(e.ccsCredential.credential);r.addCcsOid(t)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case rn:r.addCcsUpn(e.ccsCredential.credential)}return e.tokenBodyParameters&&r.addExtraQueryParameters(e.tokenBodyParameters),r.createQueryString()}}class SilentFlowClient extends BaseClient{constructor(e,t){super(e,t)}async acquireToken(e){try{const[t,r]=await this.acquireCachedToken({...e,scopes:e.scopes?.length?e.scopes:[...h]});if(r===he){this.logger.info("SilentFlowClient:acquireCachedToken - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");new RefreshTokenClient(this.config,this.performanceClient).acquireTokenByRefreshToken(e).catch((()=>{}))}return t}catch(t){if(t instanceof ClientAuthError&&t.errorCode===Gt){return new RefreshTokenClient(this.config,this.performanceClient).acquireTokenByRefreshToken(e)}throw t}}async acquireCachedToken(e){this.performanceClient?.addQueueMeasurement(Cr,e.correlationId);let t=ce;if(e.forceRefresh||!this.config.cacheOptions.claimsBasedCachingEnabled&&!StringUtils.isEmptyObj(e.claims))throw this.setCacheOutcome(le,e.correlationId),createClientAuthError(Gt);if(!e.account)throw createClientAuthError(Dt);const r=e.account.tenantId||function getTenantFromAuthorityString(e){const t=new UrlString(e).getUrlComponents(),r=t.PathSegments.slice(-1)[0]?.toLowerCase();switch(r){case A.COMMON:case A.ORGANIZATIONS:case A.CONSUMERS:return;default:return r}}(e.authority),n=this.cacheManager.getTokenKeys(),o=this.cacheManager.getAccessToken(e.account,e,n,r,this.performanceClient,e.correlationId);if(!o)throw this.setCacheOutcome(ue,e.correlationId),createClientAuthError(Gt);if(function wasClockTurnedBack(e){return Number(e)>nowSeconds()}(o.cachedAt)||isTokenExpired(o.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.setCacheOutcome(de,e.correlationId),createClientAuthError(Gt);o.refreshOn&&isTokenExpired(o.refreshOn,0)&&(t=he);const i=e.authority||this.authority.getPreferredCache(),a={account:this.cacheManager.readAccountFromCache(e.account),accessToken:o,idToken:this.cacheManager.getIdToken(e.account,n,r,this.performanceClient,e.correlationId),refreshToken:null,appMetadata:this.cacheManager.readAppMetadataFromCache(i)};return this.setCacheOutcome(t,e.correlationId),this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),[await jr(this.generateResultFromCacheRecord.bind(this),Ar,this.logger,this.performanceClient,e.correlationId)(a,e),t]}setCacheOutcome(e,t){this.serverTelemetryManager?.setCacheOutcome(e),this.performanceClient?.addFields({cacheOutcome:e},t),e!==ce&&this.logger.info(`Token refresh is required due to cache outcome: ${e}`)}async generateResultFromCacheRecord(e,t){let r;if(this.performanceClient?.addQueueMeasurement(Ar,t.correlationId),e.idToken&&(r=extractTokenClaims(e.idToken.secret,this.config.cryptoInterface.base64Decode)),t.maxAge||0===t.maxAge){const e=r?.auth_time;if(!e)throw createClientAuthError(kt);checkMaxAge(e,t.maxAge)}return ResponseHandler.generateAuthenticationResult(this.cryptoUtils,this.authority,e,!0,t,r)}}class ServerTelemetryManager{constructor(e,t){this.cacheOutcome=ce,this.cacheManager=t,this.apiId=e.apiId,this.correlationId=e.correlationId,this.wrapperSKU=e.wrapperSKU||n.EMPTY_STRING,this.wrapperVer=e.wrapperVer||n.EMPTY_STRING,this.telemetryCacheKey=$.CACHE_KEY+N+e.clientId}generateCurrentRequestHeaderValue(){const e=`${this.apiId}${$.VALUE_SEPARATOR}${this.cacheOutcome}`,t=[this.wrapperSKU,this.wrapperVer].join($.VALUE_SEPARATOR),r=[e,this.getRegionDiscoveryFields()].join($.VALUE_SEPARATOR);return[$.SCHEMA_VERSION,r,t].join($.CATEGORY_SEPARATOR)}generateLastRequestHeaderValue(){const e=this.getLastRequests(),t=ServerTelemetryManager.maxErrorsToSend(e),r=e.failedRequests.slice(0,2*t).join($.VALUE_SEPARATOR),n=e.errors.slice(0,t).join($.VALUE_SEPARATOR),o=e.errors.length,i=[o,t<o?$.OVERFLOW_TRUE:$.OVERFLOW_FALSE].join($.VALUE_SEPARATOR);return[$.SCHEMA_VERSION,e.cacheHits,r,n,i].join($.CATEGORY_SEPARATOR)}cacheFailedRequest(e){const t=this.getLastRequests();t.errors.length>=$.MAX_CACHED_ERRORS&&(t.failedRequests.shift(),t.failedRequests.shift(),t.errors.shift()),t.failedRequests.push(this.apiId,this.correlationId),e instanceof Error&&e&&e.toString()?e instanceof AuthError?e.subError?t.errors.push(e.subError):e.errorCode?t.errors.push(e.errorCode):t.errors.push(e.toString()):t.errors.push(e.toString()):t.errors.push($.UNKNOWN_ERROR),this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t)}incrementCacheHits(){const e=this.getLastRequests();return e.cacheHits+=1,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e),e.cacheHits}getLastRequests(){return this.cacheManager.getServerTelemetry(this.telemetryCacheKey)||{failedRequests:[],errors:[],cacheHits:0}}clearTelemetryCache(){const e=this.getLastRequests(),t=ServerTelemetryManager.maxErrorsToSend(e);if(t===e.errors.length)this.cacheManager.removeItem(this.telemetryCacheKey);else{const r={failedRequests:e.failedRequests.slice(2*t),errors:e.errors.slice(t),cacheHits:0};this.cacheManager.setServerTelemetry(this.telemetryCacheKey,r)}}static maxErrorsToSend(e){let t,r=0,o=0;const i=e.errors.length;for(t=0;t<i;t++){const i=e.failedRequests[2*t]||n.EMPTY_STRING,a=e.failedRequests[2*t+1]||n.EMPTY_STRING,s=e.errors[t]||n.EMPTY_STRING;if(o+=i.toString().length+a.toString().length+s.length+3,!(o<$.MAX_LAST_HEADER_BYTES))break;r+=1}return r}getRegionDiscoveryFields(){const e=[];return e.push(this.regionUsed||n.EMPTY_STRING),e.push(this.regionSource||n.EMPTY_STRING),e.push(this.regionOutcome||n.EMPTY_STRING),e.join(",")}updateRegionDiscoveryMetadata(e){this.regionUsed=e.region_used,this.regionSource=e.region_source,this.regionOutcome=e.region_outcome}setCacheOutcome(e){this.cacheOutcome=e}}class NetworkUtils{static getNetworkResponse(e,t,r){return{headers:e,body:t,status:r}}static urlToHttpOptions(e){const t={protocol:e.protocol,hostname:e.hostname&&e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,hash:e.hash,search:e.search,pathname:e.pathname,path:`${e.pathname||""}${e.search||""}`,href:e.href};return""!==e.port&&(t.port=Number(e.port)),(e.username||e.password)&&(t.auth=`${decodeURIComponent(e.username)}:${decodeURIComponent(e.password)}`),t}}var yn=r(8611),Cn=r(5692);class HttpClient_HttpClient{constructor(e,t){this.proxyUrl=e||"",this.customAgentOptions=t||{}}async sendGetRequestAsync(e,t,r){return this.proxyUrl?networkRequestViaProxy(e,this.proxyUrl,Te,t,this.customAgentOptions,r):networkRequestViaHttps(e,Te,t,this.customAgentOptions,r)}async sendPostRequestAsync(e,t){return this.proxyUrl?networkRequestViaProxy(e,this.proxyUrl,Se,t,this.customAgentOptions):networkRequestViaHttps(e,Se,t,this.customAgentOptions)}}const networkRequestViaProxy=(e,t,r,n,o,s)=>{const c=new URL(e),l=new URL(t),u=n?.headers||{},d={host:l.hostname,port:l.port,method:"CONNECT",path:c.hostname,headers:u};o&&Object.keys(o).length&&(d.agent=new yn.Agent(o));let h="";if(r===Se){const e=n?.body||"";h=`Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ${e.length}\r\n\r\n${e}`}else s&&(d.timeout=s);const p=`${r.toUpperCase()} ${c.href} HTTP/1.1\r\nHost: ${c.host}\r\nConnection: close\r\n`+h+"\r\n";return new Promise(((e,t)=>{const r=yn.request(d);s&&r.on("timeout",(()=>{r.destroy(),t(new Error("Request time out"))})),r.end(),r.on("connect",((n,o)=>{const s=n?.statusCode||Ie.SERVER_ERROR;(s<Ie.SUCCESS_RANGE_START||s>Ie.SUCCESS_RANGE_END)&&(r.destroy(),o.destroy(),t(new Error(`Error connecting to proxy. Http status code: ${n.statusCode}. Http status message: ${n?.statusMessage||"Unknown"}`))),o.write(p);const c=[];o.on("data",(e=>{c.push(e)})),o.on("end",(()=>{const t=Buffer.concat([...c]).toString().split("\r\n"),n=parseInt(t[0].split(" ")[1]),o=t[0].split(" ").slice(2).join(" "),s=t[t.length-1],l=t.slice(1,t.length-2),u=new Map;l.forEach((e=>{const t=e.split(new RegExp(/:\s(.*)/s)),r=t[0];let n=t[1];try{const e=JSON.parse(n);e&&"object"==typeof e&&(n=e)}catch(e){}u.set(r,n)}));const d=Object.fromEntries(u),h=NetworkUtils.getNetworkResponse(d,parseBody(n,o,d,s),n);(n<i||n>a)&&h.body.error!==be&&r.destroy(),e(h)})),o.on("error",(e=>{r.destroy(),o.destroy(),t(new Error(e.toString()))}))})),r.on("error",(e=>{r.destroy(),t(new Error(e.toString()))}))}))},networkRequestViaHttps=(e,t,r,n,o)=>{const s=t===Se,c=r?.body||"",l=new URL(e),u={method:t,headers:r?.headers||{},...NetworkUtils.urlToHttpOptions(l)};return n&&Object.keys(n).length&&(u.agent=new Cn.Agent(n)),s?u.headers={...u.headers,"Content-Length":c.length}:o&&(u.timeout=o),new Promise(((e,t)=>{let r;r="http:"===u.protocol?yn.request(u):Cn.request(u),s&&r.write(c),o&&r.on("timeout",(()=>{r.destroy(),t(new Error("Request time out"))})),r.end(),r.on("response",(t=>{const n=t.headers,o=t.statusCode,s=t.statusMessage,c=[];t.on("data",(e=>{c.push(e)})),t.on("end",(()=>{const t=Buffer.concat([...c]).toString(),l=n,u=NetworkUtils.getNetworkResponse(l,parseBody(o,s,l,t),o);(o<i||o>a)&&u.body.error!==be&&r.destroy(),e(u)}))})),r.on("error",(e=>{r.destroy(),t(new Error(e.toString()))}))}))},parseBody=(e,t,r,n)=>{let o;try{o=JSON.parse(n)}catch(n){let i,a;e>=s&&e<=c?(i="client_error",a="A client"):e>=u&&e<=d?(i="server_error",a="A server"):(i="unknown_error",a="An unknown"),o={error:i,error_description:`${a} error occured.\nHttp status code: ${e}\nHttp status message: ${t||"Unknown"}\nHeaders: ${JSON.stringify(r)}`}}return o},An="invalid_file_extension",Tn="invalid_file_path",Sn="invalid_managed_identity_id_type",In="invalid_secret",En="missing_client_id",wn="network_unavailable",vn="platform_not_supported",kn="unable_to_create_azure_arc",bn="unable_to_create_cloud_shell",_n="unable_to_create_source",Rn="unable_to_read_secret_file",On="user_assigned_not_available_at_runtime",Pn="www_authenticate_header_missing",Mn="www_authenticate_header_unsupported_format",Nn={[pe]:"azure_pod_identity_authority_host_url_malformed",[ge]:"identity_endpoint_url_malformed",[fe]:"imds_endpoint_url_malformed",[me]:"msi_endpoint_url_malformed"},Un={[An]:"The file path in the WWW-Authenticate header does not contain a .key file.",[Tn]:"The file path in the WWW-Authenticate header is not in a valid Windows or Linux Format.",[Sn]:"More than one ManagedIdentityIdType was provided.",[In]:"The secret in the file on the file path in the WWW-Authenticate header is greater than 4096 bytes.",[vn]:"The platform is not supported by Azure Arc. Azure Arc only supports Windows and Linux.",[En]:"A ManagedIdentityId id was not provided.",[Nn.AZURE_POD_IDENTITY_AUTHORITY_HOST]:`The Managed Identity's '${pe}' environment variable is malformed.`,[Nn.IDENTITY_ENDPOINT]:`The Managed Identity's '${ge}' environment variable is malformed.`,[Nn.IMDS_ENDPOINT]:`The Managed Identity's '${fe}' environment variable is malformed.`,[Nn.MSI_ENDPOINT]:`The Managed Identity's '${me}' environment variable is malformed.`,[wn]:"Authentication unavailable. The request to the managed identity endpoint timed out.",[kn]:"Azure Arc Managed Identities can only be system assigned.",[bn]:"Cloud Shell Managed Identities can only be system assigned.",[_n]:"Unable to create a Managed Identity source based on environment variables.",[Rn]:"Unable to read the secret file.",[On]:"Service Fabric user assigned managed identity ClientId or ResourceId is not configurable at runtime.",[Pn]:"A 401 response was received form the Azure Arc Managed Identity, but the www-authenticate header is missing.",[Mn]:"A 401 response was received form the Azure Arc Managed Identity, but the www-authenticate header is in an unsupported format."};class ManagedIdentityError extends AuthError{constructor(e){super(e,Un[e]),this.name="ManagedIdentityError",Object.setPrototypeOf(this,ManagedIdentityError.prototype)}}function ManagedIdentityError_createManagedIdentityError(e){return new ManagedIdentityError(e)}const xn={clientId:n.EMPTY_STRING,authority:n.DEFAULT_AUTHORITY,clientSecret:n.EMPTY_STRING,clientAssertion:n.EMPTY_STRING,clientCertificate:{thumbprint:n.EMPTY_STRING,privateKey:n.EMPTY_STRING,x5c:n.EMPTY_STRING},knownAuthorities:[],cloudDiscoveryMetadata:n.EMPTY_STRING,authorityMetadata:n.EMPTY_STRING,clientCapabilities:[],protocolMode:cr,azureCloudOptions:{azureCloudInstance:ur,tenant:n.EMPTY_STRING},skipAuthorityMetadataCache:!1},qn={claimsBasedCachingEnabled:!1},Hn={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:je.Info},Dn={loggerOptions:Hn,networkClient:new HttpClient_HttpClient,proxyUrl:n.EMPTY_STRING,customAgentOptions:{},disableInternalRetries:!1},Ln={application:{appName:n.EMPTY_STRING,appVersion:n.EMPTY_STRING}};var jn=r(6982),Fn=r.n(jn);const Kn=new Uint8Array(256);let Bn=Kn.length;function rng(){return Bn>Kn.length-16&&(Fn().randomFillSync(Kn),Bn=0),Kn.slice(Bn,Bn+=16)}const $n=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const zn=function validate(e){return"string"==typeof e&&$n.test(e)},Gn=[];for(let e=0;e<256;++e)Gn.push((e+256).toString(16).substr(1));const Vn=function stringify(e,t=0){const r=(Gn[e[t+0]]+Gn[e[t+1]]+Gn[e[t+2]]+Gn[e[t+3]]+"-"+Gn[e[t+4]]+Gn[e[t+5]]+"-"+Gn[e[t+6]]+Gn[e[t+7]]+"-"+Gn[e[t+8]]+Gn[e[t+9]]+"-"+Gn[e[t+10]]+Gn[e[t+11]]+Gn[e[t+12]]+Gn[e[t+13]]+Gn[e[t+14]]+Gn[e[t+15]]).toLowerCase();if(!zn(r))throw TypeError("Stringified UUID is invalid");return r};const Yn=function v4(e,t,r){const n=(e=e||{}).random||(e.rng||rng)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=n[e];return t}return Vn(n)};class GuidGenerator{generateGuid(){return Yn()}isGuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}}class EncodingUtils{static base64Encode(e,t){return Buffer.from(e,t).toString("base64")}static base64EncodeUrl(e,t){return EncodingUtils.base64Encode(e,t).replace(/=/g,n.EMPTY_STRING).replace(/\+/g,"-").replace(/\//g,"_")}static base64Decode(e){return Buffer.from(e,"base64").toString("utf8")}static base64DecodeUrl(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";return EncodingUtils.base64Decode(t)}}class HashUtils{sha256(e){return jn.createHash(Ee).update(e).digest()}}class PkceGenerator{constructor(){this.hashUtils=new HashUtils}async generatePkceCodes(){const e=this.generateCodeVerifier();return{verifier:e,challenge:this.generateCodeChallengeFromVerifier(e)}}generateCodeVerifier(){const e=[],t=256-256%we.length;for(;e.length<=32;){const r=jn.randomBytes(1)[0];if(r>=t)continue;const n=r%we.length;e.push(we[n])}const r=e.join(n.EMPTY_STRING);return EncodingUtils.base64EncodeUrl(r)}generateCodeChallengeFromVerifier(e){return EncodingUtils.base64EncodeUrl(this.hashUtils.sha256(e).toString("base64"),"base64")}}class CryptoProvider_CryptoProvider{constructor(){this.pkceGenerator=new PkceGenerator,this.guidGenerator=new GuidGenerator,this.hashUtils=new HashUtils}base64UrlEncode(){throw new Error("Method not implemented.")}encodeKid(){throw new Error("Method not implemented.")}createNewGuid(){return this.guidGenerator.generateGuid()}base64Encode(e){return EncodingUtils.base64Encode(e)}base64Decode(e){return EncodingUtils.base64Decode(e)}generatePkceCodes(){return this.pkceGenerator.generatePkceCodes()}getPublicKeyThumbprint(){throw new Error("Method not implemented.")}removeTokenBindingKey(){throw new Error("Method not implemented.")}clearKeystore(){throw new Error("Method not implemented.")}signJwt(){throw new Error("Method not implemented.")}async hashString(e){return EncodingUtils.base64EncodeUrl(this.hashUtils.sha256(e).toString("base64"),"base64")}}class Deserializer{static deserializeJSONBlob(e){return e?JSON.parse(e):{}}static deserializeAccounts(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],o={homeAccountId:n.home_account_id,environment:n.environment,realm:n.realm,localAccountId:n.local_account_id,username:n.username,authorityType:n.authority_type,name:n.name,clientInfo:n.client_info,lastModificationTime:n.last_modification_time,lastModificationApp:n.last_modification_app,tenantProfiles:n.tenantProfiles?.map((e=>JSON.parse(e)))},i=new AccountEntity;CacheManager.toObject(i,o),t[r]=i})),t}static deserializeIdTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],o={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,realm:n.realm};t[r]=o})),t}static deserializeAccessTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],o={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,realm:n.realm,target:n.target,cachedAt:n.cached_at,expiresOn:n.expires_on,extendedExpiresOn:n.extended_expires_on,refreshOn:n.refresh_on,keyId:n.key_id,tokenType:n.token_type,requestedClaims:n.requestedClaims,requestedClaimsHash:n.requestedClaimsHash,userAssertionHash:n.userAssertionHash};t[r]=o})),t}static deserializeRefreshTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],o={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,familyId:n.family_id,target:n.target,realm:n.realm};t[r]=o})),t}static deserializeAppMetadata(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r];t[r]={clientId:n.client_id,environment:n.environment,familyId:n.family_id}})),t}static deserializeAllCache(e){return{accounts:e.Account?this.deserializeAccounts(e.Account):{},idTokens:e.IdToken?this.deserializeIdTokens(e.IdToken):{},accessTokens:e.AccessToken?this.deserializeAccessTokens(e.AccessToken):{},refreshTokens:e.RefreshToken?this.deserializeRefreshTokens(e.RefreshToken):{},appMetadata:e.AppMetadata?this.deserializeAppMetadata(e.AppMetadata):{}}}}class Serializer{static serializeJSONBlob(e){return JSON.stringify(e)}static serializeAccounts(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,realm:n.realm,local_account_id:n.localAccountId,username:n.username,authority_type:n.authorityType,name:n.name,client_info:n.clientInfo,last_modification_time:n.lastModificationTime,last_modification_app:n.lastModificationApp,tenantProfiles:n.tenantProfiles?.map((e=>JSON.stringify(e)))}})),t}static serializeIdTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,realm:n.realm}})),t}static serializeAccessTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,realm:n.realm,target:n.target,cached_at:n.cachedAt,expires_on:n.expiresOn,extended_expires_on:n.extendedExpiresOn,refresh_on:n.refreshOn,key_id:n.keyId,token_type:n.tokenType,requestedClaims:n.requestedClaims,requestedClaimsHash:n.requestedClaimsHash,userAssertionHash:n.userAssertionHash}})),t}static serializeRefreshTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,family_id:n.familyId,target:n.target,realm:n.realm}})),t}static serializeAppMetadata(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={client_id:n.clientId,environment:n.environment,family_id:n.familyId}})),t}static serializeAllCache(e){return{Account:this.serializeAccounts(e.accounts),IdToken:this.serializeIdTokens(e.idTokens),AccessToken:this.serializeAccessTokens(e.accessTokens),RefreshToken:this.serializeRefreshTokens(e.refreshTokens),AppMetadata:this.serializeAppMetadata(e.appMetadata)}}}class NodeStorage_NodeStorage extends CacheManager{constructor(e,t,r,n){super(t,r,e,n),this.cache={},this.changeEmitters=[],this.logger=e}registerChangeEmitter(e){this.changeEmitters.push(e)}emitChange(){this.changeEmitters.forEach((e=>e.call(null)))}cacheToInMemoryCache(e){const t={accounts:{},idTokens:{},accessTokens:{},refreshTokens:{},appMetadata:{}};for(const r in e){const n=e[r];if("object"==typeof n)if(n instanceof AccountEntity)t.accounts[r]=n;else if(isIdTokenEntity(n))t.idTokens[r]=n;else if(isAccessTokenEntity(n))t.accessTokens[r]=n;else if(isRefreshTokenEntity(n))t.refreshTokens[r]=n;else{if(!isAppMetadataEntity(r,n))continue;t.appMetadata[r]=n}}return t}inMemoryCacheToCache(e){let t=this.getCache();return t={...t,...e.accounts,...e.idTokens,...e.accessTokens,...e.refreshTokens,...e.appMetadata},t}getInMemoryCache(){this.logger.trace("Getting in-memory cache");return this.cacheToInMemoryCache(this.getCache())}setInMemoryCache(e){this.logger.trace("Setting in-memory cache");const t=this.inMemoryCacheToCache(e);this.setCache(t),this.emitChange()}getCache(){return this.logger.trace("Getting cache key-value store"),this.cache}setCache(e){this.logger.trace("Setting cache key value store"),this.cache=e,this.emitChange()}getItem(e){this.logger.tracePii(`Item key: ${e}`);return this.getCache()[e]}setItem(e,t){this.logger.tracePii(`Item key: ${e}`);const r=this.getCache();r[e]=t,this.setCache(r)}getAccountKeys(){const e=this.getInMemoryCache();return Object.keys(e.accounts)}getTokenKeys(){const e=this.getInMemoryCache();return{idToken:Object.keys(e.idTokens),accessToken:Object.keys(e.accessTokens),refreshToken:Object.keys(e.refreshTokens)}}getAccount(e){const t=this.getCachedAccountEntity(e);return t&&AccountEntity.isAccountEntity(t)?this.updateOutdatedCachedAccount(e,t):null}getCachedAccountEntity(e){return this.getItem(e)?Object.assign(new AccountEntity,this.getItem(e)):null}setAccount(e){const t=e.generateAccountKey();this.setItem(t,e)}getIdTokenCredential(e){const t=this.getItem(e);return isIdTokenEntity(t)?t:null}setIdTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getAccessTokenCredential(e){const t=this.getItem(e);return isAccessTokenEntity(t)?t:null}setAccessTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getRefreshTokenCredential(e){const t=this.getItem(e);return isRefreshTokenEntity(t)?t:null}setRefreshTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getAppMetadata(e){const t=this.getItem(e);return isAppMetadataEntity(e,t)?t:null}setAppMetadata(e){const t=function generateAppMetadataKey({environment:e,clientId:t}){return[q,e,t].join(N).toLowerCase()}(e);this.setItem(t,e)}getServerTelemetry(e){const t=this.getItem(e);return t&&function isServerTelemetryEntity(e,t){const r=0===e.indexOf($.CACHE_KEY);let n=!0;return t&&(n=t.hasOwnProperty("failedRequests")&&t.hasOwnProperty("errors")&&t.hasOwnProperty("cacheHits")),r&&n}(e,t)?t:null}setServerTelemetry(e,t){this.setItem(e,t)}getAuthorityMetadata(e){const t=this.getItem(e);return t&&function isAuthorityMetadataEntity(e,t){return!!t&&0===e.indexOf(D)&&t.hasOwnProperty("aliases")&&t.hasOwnProperty("preferred_cache")&&t.hasOwnProperty("preferred_network")&&t.hasOwnProperty("canonical_authority")&&t.hasOwnProperty("authorization_endpoint")&&t.hasOwnProperty("token_endpoint")&&t.hasOwnProperty("issuer")&&t.hasOwnProperty("aliasesFromNetwork")&&t.hasOwnProperty("endpointsFromNetwork")&&t.hasOwnProperty("expiresAt")&&t.hasOwnProperty("jwks_uri")}(e,t)?t:null}getAuthorityMetadataKeys(){return this.getKeys().filter((e=>this.isAuthorityMetadata(e)))}setAuthorityMetadata(e,t){this.setItem(e,t)}getThrottlingCache(e){const t=this.getItem(e);return t&&function isThrottlingEntity(e,t){let r=!1;e&&(r=0===e.indexOf(Y));let n=!0;return t&&(n=t.hasOwnProperty("throttleTime")),r&&n}(e,t)?t:null}setThrottlingCache(e,t){this.setItem(e,t)}removeItem(e){this.logger.tracePii(`Item key: ${e}`);let t=!1;const r=this.getCache();return r[e]&&(delete r[e],t=!0),t&&(this.setCache(r),this.emitChange()),t}removeOutdatedAccount(e){this.removeItem(e)}containsKey(e){return this.getKeys().includes(e)}getKeys(){this.logger.trace("Retrieving all cache keys");const e=this.getCache();return[...Object.keys(e)]}async clear(){this.logger.trace("Clearing cache entries created by MSAL");this.getKeys().forEach((e=>{this.removeItem(e)})),this.emitChange()}static generateInMemoryCache(e){return Deserializer.deserializeAllCache(Deserializer.deserializeJSONBlob(e))}static generateJsonCache(e){return Serializer.serializeAllCache(e)}updateCredentialCacheKey(e,t){const r=generateCredentialKey(t);if(e!==r){const n=this.getItem(e);if(n)return this.removeItem(e),this.setItem(r,n),this.logger.verbose(`Updated an outdated ${t.credentialType} cache key`),r;this.logger.error(`Attempted to update an outdated ${t.credentialType} cache key but no item matching the outdated key was found in storage`)}return e}}const Wn={},Qn={},Jn={},Zn={},Xn={};class TokenCache{constructor(e,t,r){this.cacheHasChanged=!1,this.storage=e,this.storage.registerChangeEmitter(this.handleChangeEvent.bind(this)),r&&(this.persistence=r),this.logger=t}hasChanged(){return this.cacheHasChanged}serialize(){this.logger.trace("Serializing in-memory cache");let e=Serializer.serializeAllCache(this.storage.getInMemoryCache());return this.cacheSnapshot?(this.logger.trace("Reading cache snapshot from disk"),e=this.mergeState(JSON.parse(this.cacheSnapshot),e)):this.logger.trace("No cache snapshot to merge"),this.cacheHasChanged=!1,JSON.stringify(e)}deserialize(e){if(this.logger.trace("Deserializing JSON to in-memory cache"),this.cacheSnapshot=e,this.cacheSnapshot){this.logger.trace("Reading cache snapshot from disk");const e=Deserializer.deserializeAllCache(this.overlayDefaults(JSON.parse(this.cacheSnapshot)));this.storage.setInMemoryCache(e)}else this.logger.trace("No cache snapshot to deserialize")}getKVStore(){return this.storage.getCache()}async getAllAccounts(){let e;this.logger.trace("getAllAccounts called");try{return this.persistence&&(e=new TokenCacheContext(this,!0),await this.persistence.beforeCacheAccess(e)),this.storage.getAllAccounts()}finally{this.persistence&&e&&await this.persistence.afterCacheAccess(e)}}async getAccountByHomeId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter((t=>t.homeAccountId===e))[0]||null}async getAccountByLocalId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter((t=>t.localAccountId===e))[0]||null}async removeAccount(e){let t;this.logger.trace("removeAccount called");try{this.persistence&&(t=new TokenCacheContext(this,!0),await this.persistence.beforeCacheAccess(t)),await this.storage.removeAccount(AccountEntity.generateAccountCacheKey(e))}finally{this.persistence&&t&&await this.persistence.afterCacheAccess(t)}}handleChangeEvent(){this.cacheHasChanged=!0}mergeState(e,t){this.logger.trace("Merging in-memory cache with cache snapshot");const r=this.mergeRemovals(e,t);return this.mergeUpdates(r,t)}mergeUpdates(e,t){return Object.keys(t).forEach((r=>{const n=t[r];if(e.hasOwnProperty(r)){const t=null!==n,o="object"==typeof n,i=!Array.isArray(n),a=void 0!==e[r]&&null!==e[r];t&&o&&i&&a?this.mergeUpdates(e[r],n):e[r]=n}else null!==n&&(e[r]=n)})),e}mergeRemovals(e,t){this.logger.trace("Remove updated entries in cache");const r=e.Account?this.mergeRemovalsDict(e.Account,t.Account):e.Account,n=e.AccessToken?this.mergeRemovalsDict(e.AccessToken,t.AccessToken):e.AccessToken,o=e.RefreshToken?this.mergeRemovalsDict(e.RefreshToken,t.RefreshToken):e.RefreshToken,i=e.IdToken?this.mergeRemovalsDict(e.IdToken,t.IdToken):e.IdToken,a=e.AppMetadata?this.mergeRemovalsDict(e.AppMetadata,t.AppMetadata):e.AppMetadata;return{...e,Account:r,AccessToken:n,RefreshToken:o,IdToken:i,AppMetadata:a}}mergeRemovalsDict(e,t){const r={...e};return Object.keys(e).forEach((e=>{t&&t.hasOwnProperty(e)||delete r[e]})),r}overlayDefaults(e){return this.logger.trace("Overlaying input cache with the default cache"),{Account:{...Wn,...e.Account},IdToken:{...Qn,...e.IdToken},AccessToken:{...Jn,...e.AccessToken},RefreshToken:{...Zn,...e.RefreshToken},AppMetadata:{...Xn,...e.AppMetadata}}}}var eo=r(4040);class ClientAssertion{static fromAssertion(e){const t=new ClientAssertion;return t.jwt=e,t}static fromCertificate(e,t,r){const n=new ClientAssertion;return n.privateKey=t,n.thumbprint=e,r&&(n.publicCertificate=this.parseCertificate(r)),n}getJwt(e,t,r){if(this.privateKey&&this.thumbprint)return this.jwt&&!this.isExpired()&&t===this.issuer&&r===this.jwtAudience?this.jwt:this.createJwt(e,t,r);if(this.jwt)return this.jwt;throw createClientAuthError($t)}createJwt(e,t,r){this.issuer=t,this.jwtAudience=r;const n=nowSeconds();this.expirationTime=n+600;const o={alg:Ne,x5t:EncodingUtils.base64EncodeUrl(this.thumbprint,"hex")};this.publicCertificate&&Object.assign(o,{x5c:this.publicCertificate});const i={[Ue]:this.jwtAudience,[xe]:this.expirationTime,[qe]:this.issuer,[He]:this.issuer,[De]:n,[Le]:e.createNewGuid()};return this.jwt=eo.sign(i,this.privateKey,{header:o}),this.jwt}isExpired(){return this.expirationTime<nowSeconds()}static parseCertificate(e){const t=/-----BEGIN CERTIFICATE-----\r*\n(.+?)\r*\n-----END CERTIFICATE-----/gs,r=[];let o;for(;null!==(o=t.exec(e));)r.push(o[1].replace(/\r*\n/g,n.EMPTY_STRING));return r}}const to="2.9.2",ro={code:"invalid_loopback_server_address_type",desc:"Loopback server address is not type string. This is unexpected."},no={code:"unable_to_load_redirectUrl",desc:"Loopback server callback was invoked without a url. This is unexpected."},oo={code:"no_auth_code_in_response",desc:"No auth code found in the server response. Please check your network trace to determine what happened."},io={code:"no_loopback_server_exists",desc:"No loopback server exists yet."},ao={code:"loopback_server_already_exists",desc:"Loopback server already exists. Cannot create another."},so={code:"loopback_server_timeout",desc:"Timed out waiting for auth code listener to be registered."},co={code:"state_not_found",desc:"State not found. Please verify that the request originated from msal."};class NodeAuthError extends AuthError{constructor(e,t){super(e,t),this.name="NodeAuthError"}static createInvalidLoopbackAddressTypeError(){return new NodeAuthError(ro.code,`${ro.desc}`)}static createUnableToLoadRedirectUrlError(){return new NodeAuthError(no.code,`${no.desc}`)}static createNoAuthCodeInResponseError(){return new NodeAuthError(oo.code,`${oo.desc}`)}static createNoLoopbackServerExistsError(){return new NodeAuthError(io.code,`${io.desc}`)}static createLoopbackServerAlreadyExistsError(){return new NodeAuthError(ao.code,`${ao.desc}`)}static createLoopbackServerTimeoutError(){return new NodeAuthError(so.code,`${so.desc}`)}static createStateNotFoundError(){return new NodeAuthError(co.code,co.desc)}}class UsernamePasswordClient extends BaseClient{constructor(e){super(e)}async acquireToken(e){this.logger.info("in acquireToken call in username-password client");const t=nowSeconds(),r=await this.executeTokenRequest(this.authority,e),n=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);n.validateTokenResponse(r.body);return n.handleServerTokenResponse(r.body,this.authority,t,e)}async executeTokenRequest(e,t){const r=this.createTokenQueryParameters(t),n=UrlString.appendQueryString(e.tokenEndpoint,r),o=await this.createTokenRequestBody(t),i=this.createTokenRequestHeaders({credential:t.username,type:rn}),a={clientId:this.config.authOptions.clientId,authority:e.canonicalAuthority,scopes:t.scopes,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid};return this.executePostToTokenEndpoint(n,o,i,a,t.correlationId)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addUsername(e.username),t.addPassword(e.password),t.addScopes(e.scopes),t.addResponseTypeForTokenAndIdToken(),t.addGrantType(b),t.addClientInfo(),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.username&&t.addCcsUpn(e.username),t.createQueryString()}}class ClientApplication{constructor(e){this.config=function buildAppConfiguration({auth:e,broker:t,cache:r,system:n,telemetry:o}){const i={...Dn,networkClient:new HttpClient_HttpClient(n?.proxyUrl,n?.customAgentOptions),loggerOptions:n?.loggerOptions||Hn,disableInternalRetries:n?.disableInternalRetries||!1};return{auth:{...xn,...e},broker:{...t},cache:{...qn,...r},system:{...i,...n},telemetry:{...Ln,...o}}}(e),this.cryptoProvider=new CryptoProvider_CryptoProvider,this.logger=new Logger_Logger(this.config.system.loggerOptions,"@azure/msal-node",to),this.storage=new NodeStorage_NodeStorage(this.logger,this.config.auth.clientId,this.cryptoProvider,function buildStaticAuthorityOptions(e){const t=e.cloudDiscoveryMetadata;let r;if(t)try{r=JSON.parse(t)}catch(e){throw ClientConfigurationError_createClientConfigurationError(nt)}return{canonicalAuthority:e.authority?formatAuthorityUri(e.authority):void 0,knownAuthorities:e.knownAuthorities,cloudDiscoveryMetadata:r}}(this.config.auth)),this.tokenCache=new TokenCache(this.storage,this.logger,this.config.cache.cachePlugin)}async getAuthCodeUrl(e){this.logger.info("getAuthCodeUrl called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),responseMode:e.responseMode||w.QUERY,authenticationScheme:z.BEARER},r=await this.buildOauthClientConfiguration(t.authority,t.correlationId,void 0,void 0,e.azureCloudOptions),n=new AuthorizationCodeClient(r);return this.logger.verbose("Auth code client created",t.correlationId),n.getAuthCodeUrl(t)}async acquireTokenByCode(e,t){this.logger.info("acquireTokenByCode called"),e.state&&t&&(this.logger.info("acquireTokenByCode - validating state"),this.validateState(e.state,t.state||""),t={...t,state:""});const r={...e,...await this.initializeBaseRequest(e),authenticationScheme:z.BEARER},n=this.initializeServerTelemetryManager(Pe,r.correlationId);try{const o=await this.buildOauthClientConfiguration(r.authority,r.correlationId,n,void 0,e.azureCloudOptions),i=new AuthorizationCodeClient(o);return this.logger.verbose("Auth code client created",r.correlationId),await i.acquireToken(r,t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(r.correlationId),n.cacheFailedRequest(e),e}}async acquireTokenByRefreshToken(e){this.logger.info("acquireTokenByRefreshToken called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),authenticationScheme:z.BEARER},r=this.initializeServerTelemetryManager(Me,t.correlationId);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,r,void 0,e.azureCloudOptions),o=new RefreshTokenClient(n);return this.logger.verbose("Refresh token client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}async acquireTokenSilent(e){const t={...e,...await this.initializeBaseRequest(e),forceRefresh:e.forceRefresh||!1},r=this.initializeServerTelemetryManager(_e,t.correlationId,t.forceRefresh);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,r,void 0,e.azureCloudOptions),o=new SilentFlowClient(n);return this.logger.verbose("Silent flow client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}async acquireTokenByUsernamePassword(e){this.logger.info("acquireTokenByUsernamePassword called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)},r=this.initializeServerTelemetryManager(Re,t.correlationId);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,r,void 0,e.azureCloudOptions),o=new UsernamePasswordClient(n);return this.logger.verbose("Username password client created",t.correlationId),await o.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}getTokenCache(){return this.logger.info("getTokenCache called"),this.tokenCache}validateState(e,t){if(!e)throw NodeAuthError.createStateNotFoundError();if(e!==t)throw createClientAuthError(Et)}getLogger(){return this.logger}setLogger(e){this.logger=e}async buildOauthClientConfiguration(e,t,r,o,i){this.logger.verbose("buildOauthClientConfiguration called",t);const a=i||this.config.auth.azureCloudOptions,s=await this.createAuthority(e,t,o,a);this.logger.info(`Building oauth client configuration with the following authority: ${s.tokenEndpoint}.`,t),r?.updateRegionDiscoveryMetadata(s.regionDiscoveryMetadata);return{authOptions:{clientId:this.config.auth.clientId,authority:s,clientCapabilities:this.config.auth.clientCapabilities},loggerOptions:{logLevel:this.config.system.loggerOptions.logLevel,loggerCallback:this.config.system.loggerOptions.loggerCallback,piiLoggingEnabled:this.config.system.loggerOptions.piiLoggingEnabled,correlationId:t},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.cryptoProvider,networkInterface:this.config.system.networkClient,storageInterface:this.storage,serverTelemetryManager:r,clientCredentials:{clientSecret:this.clientSecret,clientAssertion:await this.getClientAssertion(s)},libraryInfo:{sku:ve,version:to,cpu:process.arch||n.EMPTY_STRING,os:process.platform||n.EMPTY_STRING},telemetry:this.config.telemetry,persistencePlugin:this.config.cache.cachePlugin,serializableCache:this.tokenCache}}async getClientAssertion(e){return this.developerProvidedClientAssertion&&(this.clientAssertion=ClientAssertion.fromAssertion(await getClientAssertion(this.developerProvidedClientAssertion,this.config.auth.clientId,e.tokenEndpoint))),this.clientAssertion&&{assertion:this.clientAssertion.getJwt(this.cryptoProvider,this.config.auth.clientId,e.tokenEndpoint),assertionType:ke}}async initializeBaseRequest(e){return this.logger.verbose("initializeRequestScopes called",e.correlationId),e.authenticationScheme&&e.authenticationScheme===z.POP&&this.logger.verbose("Authentication Scheme 'pop' is not supported yet, setting Authentication Scheme to 'Bearer' for request",e.correlationId),e.authenticationScheme=z.BEARER,this.config.cache.claimsBasedCachingEnabled&&e.claims&&!StringUtils.isEmptyObj(e.claims)&&(e.requestedClaimsHash=await this.cryptoProvider.hashString(e.claims)),{...e,scopes:[...e&&e.scopes||[],...h],correlationId:e&&e.correlationId||this.cryptoProvider.createNewGuid(),authority:e.authority||this.config.auth.authority}}initializeServerTelemetryManager(e,t,r){const n={clientId:this.config.auth.clientId,correlationId:t,apiId:e,forceRefresh:r||!1};return new ServerTelemetryManager(n,this.storage)}async createAuthority(e,t,r,n){this.logger.verbose("createAuthority called",t);const o=Authority_Authority.generateAuthority(e,n),i={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,azureRegionConfiguration:r,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache};return createDiscoveredInstance(o,this.config.system.networkClient,this.storage,i,this.logger,t)}clearCache(){this.storage.clear()}}class ClientCredentialClient_ClientCredentialClient extends BaseClient{constructor(e,t){super(e),this.appTokenProvider=t}async acquireToken(e){if(e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority);const[t,r]=await this.getCachedAuthenticationResult(e,this.config,this.cryptoUtils,this.authority,this.cacheManager,this.serverTelemetryManager);if(t){if(r===he){this.logger.info("ClientCredentialClient:getCachedAuthenticationResult - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");const t=!0;await this.executeTokenRequest(e,this.authority,t)}return t}return this.executeTokenRequest(e,this.authority)}async getCachedAuthenticationResult(e,t,r,n,o,i){const a=t,s=t;let c,l=ce;a.serializableCache&&a.persistencePlugin&&(c=new TokenCacheContext(a.serializableCache,!1),await a.persistencePlugin.beforeCacheAccess(c));const u=this.readAccessTokenFromCache(n,s.managedIdentityId?.id||a.authOptions.clientId,new ScopeSet(e.scopes||[]),o);return a.serializableCache&&a.persistencePlugin&&c&&await a.persistencePlugin.afterCacheAccess(c),u?isTokenExpired(u.expiresOn,a.systemOptions?.tokenRenewalOffsetSeconds||300)?(i?.setCacheOutcome(de),[null,de]):(u.refreshOn&&isTokenExpired(u.refreshOn.toString(),0)&&(l=he,i?.setCacheOutcome(he)),[await ResponseHandler.generateAuthenticationResult(r,n,{account:null,idToken:null,accessToken:u,refreshToken:null,appMetadata:null},!0,e),l]):(i?.setCacheOutcome(ue),[null,ue])}readAccessTokenFromCache(e,t,r,o){const i={homeAccountId:n.EMPTY_STRING,environment:e.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:x.ACCESS_TOKEN,clientId:t,realm:e.tenant,target:ScopeSet.createSearchScopes(r.asArray())},a=o.getAccessTokensByFilter(i);if(a.length<1)return null;if(a.length>1)throw createClientAuthError(_t);return a[0]}async executeTokenRequest(e,t,r){let n,o;if(this.appTokenProvider){this.logger.info("Using appTokenProvider extensibility.");const t={correlationId:e.correlationId,tenantId:this.config.authOptions.authority.tenant,scopes:e.scopes,claims:e.claims};o=nowSeconds();const r=await this.appTokenProvider(t);n={access_token:r.accessToken,expires_in:r.expiresInSeconds,refresh_in:r.refreshInSeconds,token_type:z.BEARER}}else{const r=this.createTokenQueryParameters(e),i=UrlString.appendQueryString(t.tokenEndpoint,r),a=await this.createTokenRequestBody(e),s=this.createTokenRequestHeaders(),c={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};this.logger.info("Sending token request to endpoint: "+t.tokenEndpoint),o=nowSeconds();const l=await this.executePostToTokenEndpoint(i,a,s,c,e.correlationId);n=l.body,n.status=l.status}const i=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);i.validateTokenResponse(n,r);return await i.handleServerTokenResponse(n,this.authority,o,e)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addScopes(e.scopes,!1),t.addGrantType(k),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=e.clientAssertion||this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),t.createQueryString()}}class OnBehalfOfClient extends BaseClient{constructor(e){super(e)}async acquireToken(e){if(this.scopeSet=new ScopeSet(e.scopes||[]),this.userAssertionHash=await this.cryptoUtils.hashString(e.oboAssertion),e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority,this.userAssertionHash);try{return await this.getCachedAuthenticationResult(e)}catch(t){return await this.executeTokenRequest(e,this.authority,this.userAssertionHash)}}async getCachedAuthenticationResult(e){const t=this.readAccessTokenFromCacheForOBO(this.config.authOptions.clientId,e);if(!t)throw this.serverTelemetryManager?.setCacheOutcome(ue),this.logger.info("SilentFlowClient:acquireCachedToken - No access token found in cache for the given properties."),createClientAuthError(Gt);if(isTokenExpired(t.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.serverTelemetryManager?.setCacheOutcome(de),this.logger.info(`OnbehalfofFlow:getCachedAuthenticationResult - Cached access token is expired or will expire within ${this.config.systemOptions.tokenRenewalOffsetSeconds} seconds.`),createClientAuthError(Gt);const r=this.readIdTokenFromCacheForOBO(t.homeAccountId);let o,i=null;if(r){o=extractTokenClaims(r.secret,EncodingUtils.base64Decode);const e=o.oid||o.sub,t={homeAccountId:r.homeAccountId,environment:r.environment,tenantId:r.realm,username:n.EMPTY_STRING,localAccountId:e||n.EMPTY_STRING};i=this.cacheManager.readAccountFromCache(t)}return this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),ResponseHandler.generateAuthenticationResult(this.cryptoUtils,this.authority,{account:i,accessToken:t,idToken:r,refreshToken:null,appMetadata:null},!0,e,o)}readIdTokenFromCacheForOBO(e){const t={homeAccountId:e,environment:this.authority.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:x.ID_TOKEN,clientId:this.config.authOptions.clientId,realm:this.authority.tenant},r=this.cacheManager.getIdTokensByFilter(t);return Object.values(r).length<1?null:Object.values(r)[0]}readAccessTokenFromCacheForOBO(e,t){const r=t.authenticationScheme||z.BEARER,n={credentialType:r&&r.toLowerCase()!==z.BEARER.toLowerCase()?x.ACCESS_TOKEN_WITH_AUTH_SCHEME:x.ACCESS_TOKEN,clientId:e,target:ScopeSet.createSearchScopes(this.scopeSet.asArray()),tokenType:r,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash,userAssertionHash:this.userAssertionHash},o=this.cacheManager.getAccessTokensByFilter(n),i=o.length;if(i<1)return null;if(i>1)throw createClientAuthError(_t);return o[0]}async executeTokenRequest(e,t,r){const n=this.createTokenQueryParameters(e),o=UrlString.appendQueryString(t.tokenEndpoint,n),i=await this.createTokenRequestBody(e),a=this.createTokenRequestHeaders(),s={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid},c=nowSeconds(),l=await this.executePostToTokenEndpoint(o,i,a,s,e.correlationId),u=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);u.validateTokenResponse(l.body);return await u.handleServerTokenResponse(l.body,this.authority,c,e,void 0,r)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addScopes(e.scopes),t.addGrantType(R),t.addClientInfo(),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),t.addRequestTokenUse("on_behalf_of"),t.addOboAssertion(e.oboAssertion),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),t.createQueryString()}}class ConfidentialClientApplication extends ClientApplication{constructor(e){super(e),this.setClientCredential(this.config),this.appTokenProvider=void 0}SetAppTokenProvider(e){this.appTokenProvider=e}async acquireTokenByClientCredential(e){let t;this.logger.info("acquireTokenByClientCredential called",e.correlationId),e.clientAssertion&&(t={assertion:await getClientAssertion(e.clientAssertion,this.config.auth.clientId),assertionType:ke});const r=await this.initializeBaseRequest(e),n={...r,scopes:r.scopes.filter((e=>!h.includes(e)))},o={...e,...n,clientAssertion:t},i=new UrlString(o.authority).getUrlComponents().PathSegments[0];if(Object.values(A).includes(i))throw createClientAuthError(tr);const a={azureRegion:o.azureRegion,environmentRegion:process.env.REGION_NAME},s=this.initializeServerTelemetryManager(Oe,o.correlationId,o.skipCache);try{const t=await this.buildOauthClientConfiguration(o.authority,o.correlationId,s,a,e.azureCloudOptions),r=new ClientCredentialClient_ClientCredentialClient(t,this.appTokenProvider);return this.logger.verbose("Client credential client created",o.correlationId),await r.acquireToken(o)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(o.correlationId),s.cacheFailedRequest(e),e}}async acquireTokenOnBehalfOf(e){this.logger.info("acquireTokenOnBehalfOf called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)};try{const r=await this.buildOauthClientConfiguration(t.authority,t.correlationId,void 0,void 0,e.azureCloudOptions),n=new OnBehalfOfClient(r);return this.logger.verbose("On behalf of client created",t.correlationId),await n.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),e}}setClientCredential(e){const t=!!e.auth.clientSecret,r=!!e.auth.clientAssertion,o=e.auth.clientCertificate||{thumbprint:n.EMPTY_STRING,privateKey:n.EMPTY_STRING},i=!!o.thumbprint||!!o.privateKey;if(!this.appTokenProvider){if(t&&r||r&&i||t&&i)throw createClientAuthError(zt);if(e.auth.clientSecret)this.clientSecret=e.auth.clientSecret;else if(e.auth.clientAssertion)this.developerProvidedClientAssertion=e.auth.clientAssertion;else{if(!i)throw createClientAuthError(zt);this.clientAssertion=ClientAssertion.fromCertificate(o.thumbprint,o.privateKey,e.auth.clientCertificate?.x5c)}}}}const lo="client_id",uo="object_id",ho="mi_res_id";class BaseManagedIdentitySource{constructor(e,t,r,n){this.logger=e,this.nodeStorage=t,this.networkClient=r,this.cryptoProvider=n}async getServerTokenResponseAsync(e,t,r,n){return this.getServerTokenResponse(e)}getServerTokenResponse(e){let t,r;e.body.expires_on&&(r=e.body.expires_on-nowSeconds(),r>7200&&(t=r/2));return{status:e.status,access_token:e.body.access_token,expires_in:r,scope:e.body.resource,token_type:e.body.token_type,refresh_in:t,error:e.body.message,correlation_id:e.body.correlationId}}async acquireTokenWithManagedIdentity(e,t,r,o){const i=this.createRequest(e.resource,t),a=i.headers;a[g]=n.URL_FORM_CONTENT_TYPE;const s={headers:a};Object.keys(i.bodyParameters).length&&(s.body=i.computeParametersBodyString());const c=nowSeconds();let l;try{l=i.httpMethod===Se?await this.networkClient.sendPostRequestAsync(i.computeUri(),s):await this.networkClient.sendGetRequestAsync(i.computeUri(),s)}catch(e){throw e instanceof AuthError?e:createClientAuthError(At)}const u=new ResponseHandler(t.id,this.nodeStorage,this.cryptoProvider,this.logger,null,null),d=await this.getServerTokenResponseAsync(l,this.networkClient,i,s);return u.validateTokenResponse(d,o),u.handleServerTokenResponse(d,r,c,e)}getManagedIdentityUserAssignedIdQueryParameterKey(e){switch(e){case ye:return this.logger.info("[Managed Identity] Adding user assigned client id to the request."),lo;case Ce:return this.logger.info("[Managed Identity] Adding user assigned resource id to the request."),ho;case Ae:return this.logger.info("[Managed Identity] Adding user assigned object id to the request."),uo;default:throw ManagedIdentityError_createManagedIdentityError(Sn)}}}BaseManagedIdentitySource.getValidatedEnvVariableUrlString=(e,t,r,n)=>{try{return new UrlString(t).urlString}catch(t){throw n.info(`[Managed Identity] ${r} managed identity is unavailable because the '${e}' environment variable is malformed.`),ManagedIdentityError_createManagedIdentityError(Nn[e])}};r(9896),r(6928);process.env.ProgramData;const po="4.2.1",go="04b07795-8ddb-461a-bbee-02f9e1bf7b46";var fo;!function(e){e.AzureChina="https://login.chinacloudapi.cn",e.AzureGermany="https://login.microsoftonline.de",e.AzureGovernment="https://login.microsoftonline.us",e.AzurePublicCloud="https://login.microsoftonline.com"}(fo||(fo={}));const mo=fo.AzurePublicCloud,yo=["*"];let Co;let Ao;const To={generatePluginConfiguration:function generatePluginConfiguration(e){var t,r,n,o,i,a,s;const c={cache:{},broker:{isEnabled:null!==(r=null===(t=e.brokerOptions)||void 0===t?void 0:t.enabled)&&void 0!==r&&r,enableMsaPassthrough:null!==(o=null===(n=e.brokerOptions)||void 0===n?void 0:n.legacyEnableMsaPassthrough)&&void 0!==o&&o,parentWindowHandle:null===(i=e.brokerOptions)||void 0===i?void 0:i.parentWindowHandle}};if(null===(a=e.tokenCachePersistenceOptions)||void 0===a?void 0:a.enabled){if(void 0===Co)throw new Error(["Persistent token caching was requested, but no persistence provider was configured.","You must install the identity-cache-persistence plugin package (`npm install --save @azure/identity-cache-persistence`)","and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling","`useIdentityPlugin(cachePersistencePlugin)` before using `tokenCachePersistenceOptions`."].join(" "));const t=e.tokenCachePersistenceOptions.name||"msal.cache";c.cache.cachePlugin=Co(Object.assign({name:`${t}.nocae`},e.tokenCachePersistenceOptions)),c.cache.cachePluginCae=Co(Object.assign({name:`${t}.cae`},e.tokenCachePersistenceOptions))}if(null===(s=e.brokerOptions)||void 0===s?void 0:s.enabled){if(void 0===Ao)throw new Error(["Broker for WAM was requested to be enabled, but no native broker was configured.","You must install the identity-broker plugin package (`npm install --save @azure/identity-broker`)","and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling","`useIdentityPlugin(createNativeBrokerPlugin())` before using `enableBroker`."].join(" "));c.broker.nativeBrokerPlugin=Ao.broker}return c}};var So=r(2624);const Io=(0,So.KV)("identity");function formatError(e,t){let r="ERROR.";return(null==e?void 0:e.length)&&(r+=` Scopes: ${Array.isArray(e)?e.join(", "):e}.`),`${r} Error message: ${"string"==typeof t?t:t.message}.`}function credentialLoggerInstance(e,t,r=Io){const n=t?`${t.fullTitle} ${e}`:e;return{title:e,fullTitle:n,info:function info(e){r.info(`${n} =>`,e)},warning:function warning(e){r.warning(`${n} =>`,e)},verbose:function verbose(e){r.verbose(`${n} =>`,e)}}}function credentialLogger(e,t=Io){const r=credentialLoggerInstance(e,void 0,t);return Object.assign(Object.assign({},r),{parent:t,getToken:credentialLoggerInstance("=> getToken()",r,t)})}class CredentialUnavailableError extends Error{constructor(e){super(e),this.name="CredentialUnavailableError"}}const Eo="AuthenticationError";class AuthenticationError extends Error{constructor(e,t){let r={error:"unknown",errorDescription:"An unknown error occurred and no additional details are available."};if(function isErrorResponse(e){return e&&"string"==typeof e.error&&"string"==typeof e.error_description}(t))r=convertOAuthErrorResponseToErrorResponse(t);else if("string"==typeof t)try{r=convertOAuthErrorResponseToErrorResponse(JSON.parse(t))}catch(n){r=400===e?{error:"authority_not_found",errorDescription:"The specified authority URL was not found."}:{error:"unknown_error",errorDescription:`An unknown error has occurred. Response body:\n\n${t}`}}else r={error:"unknown_error",errorDescription:"An unknown error occurred and no additional details are available."};super(`${r.error} Status code: ${e}\nMore details:\n${r.errorDescription}`),this.statusCode=e,this.errorResponse=r,this.name=Eo}}Error;function convertOAuthErrorResponseToErrorResponse(e){return{error:e.error,errorDescription:e.error_description,correlationId:e.correlation_id,errorCodes:e.error_codes,timestamp:e.timestamp,traceId:e.trace_id}}class AuthenticationRequiredError extends Error{constructor(e){super(e.message),this.scopes=e.scopes,this.getTokenOptions=e.getTokenOptions,this.name="AuthenticationRequiredError"}}var wo=r(3985),extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},extendStatics(e,t)};Object.create;Object.create;var vo=new WeakMap,ko=new WeakMap,bo=function(){function AbortSignal(){this.onabort=null,vo.set(this,[]),ko.set(this,!1)}return Object.defineProperty(AbortSignal.prototype,"aborted",{get:function(){if(!ko.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");return ko.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(AbortSignal,"none",{get:function(){return new AbortSignal},enumerable:!1,configurable:!0}),AbortSignal.prototype.addEventListener=function(e,t){if(!vo.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");vo.get(this).push(t)},AbortSignal.prototype.removeEventListener=function(e,t){if(!vo.has(this))throw new TypeError("Expected `this` to be an instance of AbortSignal.");var r=vo.get(this),n=r.indexOf(t);n>-1&&r.splice(n,1)},AbortSignal.prototype.dispatchEvent=function(e){throw new Error("This is a stub dispatchEvent implementation that should not be used.  It only exists for type-checking purposes.")},AbortSignal}();function abortSignal(e){if(!e.aborted){e.onabort&&e.onabort.call(e);var t=vo.get(e);t&&t.slice().forEach((function(t){t.call(e,{type:"abort"})})),ko.set(e,!0)}}var _o=function(e){function AbortError(t){var r=e.call(this,t)||this;return r.name="AbortError",r}return function __extends(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function __(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}(AbortError,e),AbortError}(Error),Ro=function(){function AbortController(e){var t=this;if(this._signal=new bo,e){Array.isArray(e)||(e=arguments);for(var r=0,n=e;r<n.length;r++){var o=n[r];o.aborted?this.abort():o.addEventListener("abort",(function(){t.abort()}))}}}return Object.defineProperty(AbortController.prototype,"signal",{get:function(){return this._signal},enumerable:!1,configurable:!0}),AbortController.prototype.abort=function(){abortSignal(this._signal)},AbortController.timeout=function(e){var t=new bo,r=setTimeout(abortSignal,e,t);return"function"==typeof r.unref&&r.unref(),t},AbortController}();const Oo=credentialLogger("IdentityUtils");function getAuthority(e,t){return t||(t=mo),new RegExp(`${e}/?$`).test(t)?t:t.endsWith("/")?t+e:`${t}/${e}`}function getKnownAuthorities(e,t,r){return"adfs"===e&&t||r?[t]:[]}const defaultLoggerCallback=(e,t=(wo.Ll?"Node":"Browser"))=>(r,n,o)=>{if(!o)switch(r){case je.Error:return void e.info(`MSAL ${t} V2 error: ${n}`);case je.Info:return void e.info(`MSAL ${t} V2 info message: ${n}`);case je.Verbose:return void e.info(`MSAL ${t} V2 verbose message: ${n}`);case je.Warning:return void e.info(`MSAL ${t} V2 warning: ${n}`)}};function getMSALLogLevel(e){switch(e){case"error":return je.Error;case"info":default:return je.Info;case"verbose":return je.Verbose;case"warning":return je.Warning}}function publicToMsal(e){const[t]=e.authority.match(/([a-z]*\.[a-z]*\.[a-z]*)/)||[""];return Object.assign(Object.assign({},e),{localAccountId:e.homeAccountId,environment:t})}var Po=r(9834),Mo=r(3443);const No=(0,r(1652).y)({namespace:"Microsoft.AAD",packageName:"@azure/identity",packageVersion:po});function parseExpirationTimestamp(e){if("number"==typeof e.expires_on)return 1e3*e.expires_on;if("string"==typeof e.expires_on){const t=+e.expires_on;if(!isNaN(t))return 1e3*t;const r=Date.parse(e.expires_on);if(!isNaN(r))return r}if("number"==typeof e.expires_in)return Date.now()+1e3*e.expires_in;throw new Error(`Failed to parse token expiration from body. expires_in="${e.expires_in}", expires_on="${e.expires_on}"`)}const Uo="noCorrelationId";class IdentityClient extends Po.ServiceClient{constructor(e){var t,r;const n=`azsdk-js-identity/${po}`,o=(null===(t=null==e?void 0:e.userAgentOptions)||void 0===t?void 0:t.userAgentPrefix)?`${e.userAgentOptions.userAgentPrefix} ${n}`:`${n}`,i=function getIdentityClientAuthorityHost(e){let t=null==e?void 0:e.authorityHost;return wo.Ll&&(t=null!=t?t:process.env.AZURE_AUTHORITY_HOST),null!=t?t:mo}(e);if(!i.startsWith("https:"))throw new Error("The authorityHost address must use the 'https' protocol.");super(Object.assign(Object.assign({requestContentType:"application/json; charset=utf-8",retryOptions:{maxRetries:3}},e),{userAgentOptions:{userAgentPrefix:o},baseUri:i})),this.authorityHost=i,this.abortControllers=new Map,this.allowLoggingAccountIdentifiers=null===(r=null==e?void 0:e.loggingOptions)||void 0===r?void 0:r.allowLoggingAccountIdentifiers,this.tokenCredentialOptions=Object.assign({},e)}async sendTokenRequest(e){Io.info(`IdentityClient: sending token request to [${e.url}]`);const t=await this.sendRequest(e);if(!t.bodyAsText||200!==t.status&&201!==t.status){const e=new AuthenticationError(t.status,t.bodyAsText);throw Io.warning(`IdentityClient: authentication error. HTTP status: ${t.status}, ${e.errorResponse.errorDescription}`),e}{const r=JSON.parse(t.bodyAsText);if(!r.access_token)return null;this.logIdentifiers(t);const n={accessToken:{token:r.access_token,expiresOnTimestamp:parseExpirationTimestamp(r)},refreshToken:r.refresh_token};return Io.info(`IdentityClient: [${e.url}] token acquired, expires on ${n.accessToken.expiresOnTimestamp}`),n}}async refreshAccessToken(e,t,r,n,o,i={}){if(void 0===n)return null;Io.info(`IdentityClient: refreshing access token with client ID: ${t}, scopes: ${r} started`);const a={grant_type:"refresh_token",client_id:t,refresh_token:n,scope:r};void 0!==o&&(a.client_secret=o);const s=new URLSearchParams(a);return No.withSpan("IdentityClient.refreshAccessToken",i,(async r=>{try{const n=function getIdentityTokenEndpointSuffix(e){return"adfs"===e?"oauth2/token":"oauth2/v2.0/token"}(e),o=(0,Mo.createPipelineRequest)({url:`${this.authorityHost}/${e}/${n}`,method:"POST",body:s.toString(),abortSignal:i.abortSignal,headers:(0,Mo.createHttpHeaders)({Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"}),tracingOptions:r.tracingOptions}),a=await this.sendTokenRequest(o);return Io.info(`IdentityClient: refreshed token for client ID: ${t}`),a}catch(e){if(e.name===Eo&&"interaction_required"===e.errorResponse.error)return Io.info(`IdentityClient: interaction required for client ID: ${t}`),null;throw Io.warning(`IdentityClient: failed refreshing token for client ID: ${t}: ${e}`),e}}))}generateAbortSignal(e){const t=new Ro,r=this.abortControllers.get(e)||[];r.push(t),this.abortControllers.set(e,r);const n=t.signal.onabort;return t.signal.onabort=(...t)=>{this.abortControllers.set(e,void 0),n&&n(...t)},t.signal}abortRequests(e){const t=e||Uo,r=[...this.abortControllers.get(t)||[],...this.abortControllers.get(Uo)||[]];if(r.length){for(const e of r)e.abort();this.abortControllers.set(t,void 0)}}getCorrelationId(e){var t;const r=null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.split("&").map((e=>e.split("="))).find((([e])=>"client-request-id"===e));return r&&r.length&&r[1]||Uo}async sendGetRequestAsync(e,t){const r=(0,Mo.createPipelineRequest)({url:e,method:"GET",body:null==t?void 0:t.body,headers:(0,Mo.createHttpHeaders)(null==t?void 0:t.headers),abortSignal:this.generateAbortSignal(Uo)}),n=await this.sendRequest(r);return this.logIdentifiers(n),{body:n.bodyAsText?JSON.parse(n.bodyAsText):void 0,headers:n.headers.toJSON(),status:n.status}}async sendPostRequestAsync(e,t){const r=(0,Mo.createPipelineRequest)({url:e,method:"POST",body:null==t?void 0:t.body,headers:(0,Mo.createHttpHeaders)(null==t?void 0:t.headers),abortSignal:this.generateAbortSignal(this.getCorrelationId(t))}),n=await this.sendRequest(r);return this.logIdentifiers(n),{body:n.bodyAsText?JSON.parse(n.bodyAsText):void 0,headers:n.headers.toJSON(),status:n.status}}getTokenCredentialOptions(){return this.tokenCredentialOptions}logIdentifiers(e){if(!this.allowLoggingAccountIdentifiers||!e.bodyAsText)return;try{const t=(e.parsedBody||JSON.parse(e.bodyAsText)).access_token;if(!t)return;const r=t.split(".")[1],{appid:n,upn:o,tid:i,oid:a}=JSON.parse(Buffer.from(r,"base64").toString("utf8"));Io.info(`[Authenticated account] Client ID: ${n}. Tenant ID: ${i}. User Principal Name: ${o||"No User Principal Name available"}. Object ID (user): ${a}`)}catch(e){Io.warning("allowLoggingAccountIdentifiers was set, but we couldn't log the account information. Error:",e.message)}}}var xo;function calculateRegionalAuthority(e){var t,r;let n=e;return void 0===n&&void 0!==(null===(r=null===(t=globalThis.process)||void 0===t?void 0:t.env)||void 0===r?void 0:r.AZURE_REGIONAL_AUTHORITY_NAME)&&(n=process.env.AZURE_REGIONAL_AUTHORITY_NAME),n===xo.AutoDiscoverRegion?"AUTO_DISCOVER":n}function resolveTenantId(e,t,r){return t?(function checkTenantId(e,t){if(!t.match(/^[0-9a-zA-Z-.]+$/)){const t=new Error("Invalid tenant id provided. You can locate your tenant id by following the instructions listed here: https://learn.microsoft.com/partner-center/find-ids-and-domain-names.");throw e.info(formatError("",t)),t}}(e,t),t):(r||(r=go),r!==go?"common":"organizations")}!function(e){e.AutoDiscoverRegion="AutoDiscoverRegion",e.USWest="westus",e.USWest2="westus2",e.USCentral="centralus",e.USEast="eastus",e.USEast2="eastus2",e.USNorthCentral="northcentralus",e.USSouthCentral="southcentralus",e.USWestCentral="westcentralus",e.CanadaCentral="canadacentral",e.CanadaEast="canadaeast",e.BrazilSouth="brazilsouth",e.EuropeNorth="northeurope",e.EuropeWest="westeurope",e.UKSouth="uksouth",e.UKWest="ukwest",e.FranceCentral="francecentral",e.FranceSouth="francesouth",e.SwitzerlandNorth="switzerlandnorth",e.SwitzerlandWest="switzerlandwest",e.GermanyNorth="germanynorth",e.GermanyWestCentral="germanywestcentral",e.NorwayWest="norwaywest",e.NorwayEast="norwayeast",e.AsiaEast="eastasia",e.AsiaSouthEast="southeastasia",e.JapanEast="japaneast",e.JapanWest="japanwest",e.AustraliaEast="australiaeast",e.AustraliaSouthEast="australiasoutheast",e.AustraliaCentral="australiacentral",e.AustraliaCentral2="australiacentral2",e.IndiaCentral="centralindia",e.IndiaSouth="southindia",e.IndiaWest="westindia",e.KoreaSouth="koreasouth",e.KoreaCentral="koreacentral",e.UAECentral="uaecentral",e.UAENorth="uaenorth",e.SouthAfricaNorth="southafricanorth",e.SouthAfricaWest="southafricawest",e.ChinaNorth="chinanorth",e.ChinaEast="chinaeast",e.ChinaNorth2="chinanorth2",e.ChinaEast2="chinaeast2",e.GermanyCentral="germanycentral",e.GermanyNorthEast="germanynortheast",e.GovernmentUSVirginia="usgovvirginia",e.GovernmentUSIowa="usgoviowa",e.GovernmentUSArizona="usgovarizona",e.GovernmentUSTexas="usgovtexas",e.GovernmentUSDodEast="usdodeast",e.GovernmentUSDodCentral="usdodcentral"}(xo||(xo={}));const qo=credentialLogger("MsalClient");function generateMsalConfiguration(e,t,r={}){var n,o,i;const a=resolveTenantId(qo,t,e),s=getAuthority(a,null!==(n=r.authorityHost)&&void 0!==n?n:process.env.AZURE_AUTHORITY_HOST),c=new IdentityClient(Object.assign(Object.assign({},r.tokenCredentialOptions),{authorityHost:s,loggingOptions:r.loggingOptions}));return{auth:{clientId:e,authority:s,knownAuthorities:getKnownAuthorities(a,s,r.disableInstanceDiscovery)},system:{networkClient:c,loggerOptions:{loggerCallback:defaultLoggerCallback(null!==(o=r.logger)&&void 0!==o?o:qo),logLevel:getMSALLogLevel((0,So.XM)()),piiLoggingEnabled:null===(i=r.loggingOptions)||void 0===i?void 0:i.enableUnsafeSupportLogging}}}}function createMsalClient(e,t,r={}){const n={msalConfig:generateMsalConfiguration(e,t,r),cachedAccount:r.authenticationRecord?publicToMsal(r.authenticationRecord):null,pluginConfiguration:To.generatePluginConfiguration(r)},o=new Map;async function getConfidentialApp(e={}){const t=e.enableCae?"CAE":"default";let r=o.get(t);if(r)return qo.getToken.info("Existing ConfidentialClientApplication found in cache, returning it."),r;qo.getToken.info(`Creating new ConfidentialClientApplication with CAE ${e.enableCae?"enabled":"disabled"}.`);const i=e.enableCae?n.pluginConfiguration.cache.cachePluginCae:n.pluginConfiguration.cache.cachePlugin;return n.msalConfig.auth.clientCapabilities=e.enableCae?["cp1"]:void 0,r=new ConfidentialClientApplication(Object.assign(Object.assign({},n.msalConfig),{broker:{nativeBrokerPlugin:n.pluginConfiguration.broker.nativeBrokerPlugin},cache:{cachePlugin:await i}})),o.set(t,r),r}async function withSilentAuthentication(e,t,o,i){var a;let s=null;try{s=await async function getTokenSilent(e,t,r={}){if(null===n.cachedAccount){qo.getToken.info("No cached account found in local state, attempting to load it from MSAL cache.");const r=e.getTokenCache(),o=await r.getAllAccounts();if(void 0===o||0===o.length)throw new AuthenticationRequiredError({scopes:t});if(o.length>1)throw qo.info('More than one account was found authenticated for this Client ID and Tenant ID.\nHowever, no "authenticationRecord" has been provided for this credential,\ntherefore we\'re unable to pick between these accounts.\nA new login attempt will be requested, to ensure the correct account is picked.\nTo work with multiple accounts for the same Client ID and Tenant ID, please provide an "authenticationRecord" when initializing a credential to prevent this from happening.'),new AuthenticationRequiredError({scopes:t});n.cachedAccount=o[0]}r.claims&&(n.cachedClaims=r.claims);const o={account:n.cachedAccount,scopes:t,claims:n.cachedClaims};return n.pluginConfiguration.broker.isEnabled&&(o.tokenQueryParameters||(o.tokenQueryParameters={}),n.pluginConfiguration.broker.enableMsaPassthrough&&(o.tokenQueryParameters.msal_request_type="consumer_passthrough")),qo.getToken.info("Attempting to acquire token silently"),e.acquireTokenSilent(o)}(e,t,o)}catch(e){if("AuthenticationRequiredError"!==e.name)throw e;if(r.disableAutomaticAuthentication)throw new AuthenticationRequiredError({scopes:t,getTokenOptions:o,message:"Automatic authentication has been disabled. You may call the authentication() method."})}if(null===s)try{s=await i()}catch(e){throw function handleMsalError(e,t,r){if("AuthError"===t.name||"ClientAuthError"===t.name||"BrowserAuthError"===t.name){const r=t;switch(r.errorCode){case"endpoints_resolution_error":return Oo.info(formatError(e,t.message)),new CredentialUnavailableError(t.message);case"device_code_polling_cancelled":return new _o("The authentication has been aborted by the caller.");case"consent_required":case"interaction_required":case"login_required":Oo.info(formatError(e,`Authentication returned errorCode ${r.errorCode}`));break;default:Oo.info(formatError(e,`Failed to acquire token: ${t.message}`))}}return"ClientConfigurationError"===t.name||"BrowserConfigurationAuthError"===t.name||"AbortError"===t.name?t:"NativeAuthError"===t.name?(Oo.info(formatError(e,`Error from the native broker: ${t.message} with status code: ${t.statusCode}`)),t):new AuthenticationRequiredError({scopes:e,getTokenOptions:r,message:t.message})}(t,e,o)}return function ensureValidMsalToken(e,t,r){const error=t=>(Oo.getToken.info(t),new AuthenticationRequiredError({scopes:Array.isArray(e)?e:[e],getTokenOptions:r,message:t}));if(!t)throw error("No response");if(!t.expiresOn)throw error('Response had no "expiresOn" property.');if(!t.accessToken)throw error('Response had no "accessToken" property.')}(t,s,o),n.cachedAccount=null!==(a=null==s?void 0:s.account)&&void 0!==a?a:null,qo.getToken.info(function formatSuccess(e){return`SUCCESS. Scopes: ${Array.isArray(e)?e.join(", "):e}.`}(t)),{token:s.accessToken,expiresOnTimestamp:s.expiresOn.getTime()}}return{getTokenByClientSecret:async function getTokenByClientSecret(e,t,r={}){qo.getToken.info("Attempting to acquire token using client secret"),n.msalConfig.auth.clientSecret=t;const o=await getConfidentialApp(r);return withSilentAuthentication(o,e,r,(()=>o.acquireTokenByClientCredential({scopes:e,authority:n.msalConfig.auth.authority,azureRegion:calculateRegionalAuthority(),claims:null==r?void 0:r.claims})))},getTokenByClientAssertion:async function getTokenByClientAssertion(e,t,r={}){qo.getToken.info("Attempting to acquire token using client assertion"),n.msalConfig.auth.clientAssertion=t;const o=await getConfidentialApp(r);return withSilentAuthentication(o,e,r,(()=>o.acquireTokenByClientCredential({scopes:e,authority:n.msalConfig.auth.authority,azureRegion:calculateRegionalAuthority(),claims:null==r?void 0:r.claims,clientAssertion:t})))},getTokenByClientCertificate:async function getTokenByClientCertificate(e,t,r={}){qo.getToken.info("Attempting to acquire token using client certificate"),n.msalConfig.auth.clientCertificate=t;const o=await getConfidentialApp(r);return withSilentAuthentication(o,e,r,(()=>o.acquireTokenByClientCredential({scopes:e,azureRegion:calculateRegionalAuthority(),authority:n.msalConfig.auth.authority,claims:null==r?void 0:r.claims})))}}}const Ho=credentialLogger("ClientAssertionCredential");class ClientAssertionCredential{constructor(e,t,r,n={}){if(!e||!t||!r)throw new Error("ClientAssertionCredential: tenantId, clientId, and clientAssertion are required parameters.");this.tenantId=e,this.additionallyAllowedTenantIds=function resolveAdditionallyAllowedTenantIds(e){return e&&0!==e.length?e.includes("*")?yo:e:[]}(null==n?void 0:n.additionallyAllowedTenants),this.options=n,this.getAssertion=r,this.msalClient=createMsalClient(t,e,Object.assign(Object.assign({},n),{logger:Ho,tokenCredentialOptions:this.options}))}async getToken(e,t={}){return No.withSpan(`${this.constructor.name}.getToken`,t,(async t=>{t.tenantId=function processMultiTenantRequest(e,t,r=[],n){var o;let i;if(i=process.env.AZURE_IDENTITY_DISABLE_MULTITENANTAUTH||"adfs"===e?e:null!==(o=null==t?void 0:t.tenantId)&&void 0!==o?o:e,e&&i!==e&&!r.includes("*")&&!r.some((e=>0===e.localeCompare(i)))){const t=function createConfigurationErrorMessage(e){return`The current credential is not configured to acquire tokens for tenant ${e}. To enable acquiring tokens for this tenant add it to the AdditionallyAllowedTenants on the credential options, or add "*" to AdditionallyAllowedTenants to allow acquiring tokens for any tenant.`}(e);throw null==n||n.info(t),new CredentialUnavailableError(t)}return i}(this.tenantId,t,this.additionallyAllowedTenantIds,Ho);const r=await this.getAssertion(),n=Array.isArray(e)?e:[e];return this.msalClient.getTokenByClientAssertion(n,r,t)}))}}},1045:(e,t,r)=>{"use strict";var n=r(181).Buffer,o=r(181).SlowBuffer;function bufferEq(e,t){if(!n.isBuffer(e)||!n.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,o=0;o<e.length;o++)r|=e[o]^t[o];return 0===r}e.exports=bufferEq,bufferEq.install=function(){n.prototype.equal=o.prototype.equal=function equal(e){return bufferEq(this,e)}};var i=n.prototype.equal,a=o.prototype.equal;bufferEq.restore=function(){n.prototype.equal=i,o.prototype.equal=a}},2010:(e,t,r)=>{"use strict";var n=r(2861).Buffer,o=r(3527),i=128;function signatureAsBuffer(e){if(n.isBuffer(e))return e;if("string"==typeof e)return n.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function countPadding(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=i&&--n,n}e.exports={derToJose:function derToJose(e,t){e=signatureAsBuffer(e);var r=o(t),i=r+1,a=e.length,s=0;if(48!==e[s++])throw new Error('Could not find expected "seq"');var c=e[s++];if(129===c&&(c=e[s++]),a-s<c)throw new Error('"seq" specified length of "'+c+'", only "'+(a-s)+'" remaining');if(2!==e[s++])throw new Error('Could not find expected "int" for "r"');var l=e[s++];if(a-s-2<l)throw new Error('"r" specified length of "'+l+'", only "'+(a-s-2)+'" available');if(i<l)throw new Error('"r" specified length of "'+l+'", max of "'+i+'" is acceptable');var u=s;if(s+=l,2!==e[s++])throw new Error('Could not find expected "int" for "s"');var d=e[s++];if(a-s!==d)throw new Error('"s" specified length of "'+d+'", expected "'+(a-s)+'"');if(i<d)throw new Error('"s" specified length of "'+d+'", max of "'+i+'" is acceptable');var h=s;if((s+=d)!==a)throw new Error('Expected to consume entire buffer, but "'+(a-s)+'" bytes remain');var p=r-l,g=r-d,f=n.allocUnsafe(p+l+g+d);for(s=0;s<p;++s)f[s]=0;e.copy(f,s,u+Math.max(-p,0),u+l);for(var m=s=r;s<m+g;++s)f[s]=0;return e.copy(f,s,h+Math.max(-g,0),h+d),f=function base64Url(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}(f=f.toString("base64"))},joseToDer:function joseToDer(e,t){e=signatureAsBuffer(e);var r=o(t),a=e.length;if(a!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+a+'"');var s=countPadding(e,0,r),c=countPadding(e,r,e.length),l=r-s,u=r-c,d=2+l+1+1+u,h=d<i,p=n.allocUnsafe((h?2:3)+d),g=0;return p[g++]=48,h?p[g++]=d:(p[g++]=129,p[g++]=255&d),p[g++]=2,p[g++]=l,s<0?(p[g++]=0,g+=e.copy(p,g,0,r)):g+=e.copy(p,g,s,r),p[g++]=2,p[g++]=u,c<0?(p[g++]=0,e.copy(p,g,r)):e.copy(p,g,r+c),p}}},3527:e=>{"use strict";function getParamSize(e){return(e/8|0)+(e%8==0?0:1)}var t={ES256:getParamSize(256),ES384:getParamSize(384),ES512:getParamSize(521)};e.exports=function getParamBytesForAlg(e){var r=t[e];if(r)return r;throw new Error('Unknown algorithm "'+e+'"')}},7260:(e,t,r)=>{var n=r(652);e.exports=function(e,t){t=t||{};var r=n.decode(e,t);if(!r)return null;var o=r.payload;if("string"==typeof o)try{var i=JSON.parse(o);null!==i&&"object"==typeof i&&(o=i)}catch(e){}return!0===t.complete?{header:r.header,payload:o,signature:r.signature}:o}},4040:(e,t,r)=>{e.exports={decode:r(7260),verify:r(1691),sign:r(7651),JsonWebTokenError:r(1741),NotBeforeError:r(3726),TokenExpiredError:r(8980)}},1741:e=>{var JsonWebTokenError=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(JsonWebTokenError.prototype=Object.create(Error.prototype)).constructor=JsonWebTokenError,e.exports=JsonWebTokenError},3726:(e,t,r)=>{var n=r(1741),NotBeforeError=function(e,t){n.call(this,e),this.name="NotBeforeError",this.date=t};(NotBeforeError.prototype=Object.create(n.prototype)).constructor=NotBeforeError,e.exports=NotBeforeError},8980:(e,t,r)=>{var n=r(1741),TokenExpiredError=function(e,t){n.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(TokenExpiredError.prototype=Object.create(n.prototype)).constructor=TokenExpiredError,e.exports=TokenExpiredError},1977:(e,t,r)=>{const n=r(9589);e.exports=n.satisfies(process.version,">=15.7.0")},4977:(e,t,r)=>{var n=r(9589);e.exports=n.satisfies(process.version,"^6.12.0 || >=8.0.0")},4623:(e,t,r)=>{const n=r(9589);e.exports=n.satisfies(process.version,">=16.9.0")},855:(e,t,r)=>{var n=r(6585);e.exports=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var o=n(e);if(void 0===o)return;return Math.floor(r+o/1e3)}return"number"==typeof e?r+e:void 0}},7019:(e,t,r)=>{const n=r(1977),o=r(4623),i={ec:["ES256","ES384","ES512"],rsa:["RS256","PS256","RS384","PS384","RS512","PS512"],"rsa-pss":["PS256","PS384","PS512"]},a={ES256:"prime256v1",ES384:"secp384r1",ES512:"secp521r1"};e.exports=function(e,t){if(!e||!t)return;const r=t.asymmetricKeyType;if(!r)return;const s=i[r];if(!s)throw new Error(`Unknown key type "${r}".`);if(!s.includes(e))throw new Error(`"alg" parameter for "${r}" key type must be one of: ${s.join(", ")}.`);if(n)switch(r){case"ec":const r=t.asymmetricKeyDetails.namedCurve,n=a[e];if(r!==n)throw new Error(`"alg" parameter "${e}" requires curve "${n}".`);break;case"rsa-pss":if(o){const r=parseInt(e.slice(-3),10),{hashAlgorithm:n,mgf1HashAlgorithm:o,saltLength:i}=t.asymmetricKeyDetails;if(n!==`sha${r}`||o!==n)throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}.`);if(void 0!==i&&i>r>>3)throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}.`)}}}},6942:(e,t,r)=>{var n=r(1045),o=r(2861).Buffer,i=r(6982),a=r(2010),s=r(9023),c="secret must be a string or buffer",l="key must be a string or a buffer",u="function"==typeof i.createPublicKey;function checkIsPublicKey(e){if(!o.isBuffer(e)&&"string"!=typeof e){if(!u)throw typeError(l);if("object"!=typeof e)throw typeError(l);if("string"!=typeof e.type)throw typeError(l);if("string"!=typeof e.asymmetricKeyType)throw typeError(l);if("function"!=typeof e.export)throw typeError(l)}}function checkIsPrivateKey(e){if(!o.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw typeError("key must be a string, a buffer or an object")}function fromBase64(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function toBase64(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function typeError(e){var t=[].slice.call(arguments,1),r=s.format.bind(s,e).apply(null,t);return new TypeError(r)}function normalizeInput(e){return function bufferOrString(e){return o.isBuffer(e)||"string"==typeof e}(e)||(e=JSON.stringify(e)),e}function createHmacSigner(e){return function sign(t,r){!function checkIsSecretKey(e){if(!o.isBuffer(e)){if("string"==typeof e)return e;if(!u)throw typeError(c);if("object"!=typeof e)throw typeError(c);if("secret"!==e.type)throw typeError(c);if("function"!=typeof e.export)throw typeError(c)}}(r),t=normalizeInput(t);var n=i.createHmac("sha"+e,r);return fromBase64((n.update(t),n.digest("base64")))}}function createHmacVerifier(e){return function verify(t,r,i){var a=createHmacSigner(e)(t,i);return n(o.from(r),o.from(a))}}function createKeySigner(e){return function sign(t,r){checkIsPrivateKey(r),t=normalizeInput(t);var n=i.createSign("RSA-SHA"+e);return fromBase64((n.update(t),n.sign(r,"base64")))}}function createKeyVerifier(e){return function verify(t,r,n){checkIsPublicKey(n),t=normalizeInput(t),r=toBase64(r);var o=i.createVerify("RSA-SHA"+e);return o.update(t),o.verify(n,r,"base64")}}function createPSSKeySigner(e){return function sign(t,r){checkIsPrivateKey(r),t=normalizeInput(t);var n=i.createSign("RSA-SHA"+e);return fromBase64((n.update(t),n.sign({key:r,padding:i.constants.RSA_PKCS1_PSS_PADDING,saltLength:i.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function createPSSKeyVerifier(e){return function verify(t,r,n){checkIsPublicKey(n),t=normalizeInput(t),r=toBase64(r);var o=i.createVerify("RSA-SHA"+e);return o.update(t),o.verify({key:n,padding:i.constants.RSA_PKCS1_PSS_PADDING,saltLength:i.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function createECDSASigner(e){var t=createKeySigner(e);return function sign(){var r=t.apply(null,arguments);return r=a.derToJose(r,"ES"+e)}}function createECDSAVerifer(e){var t=createKeyVerifier(e);return function verify(r,n,o){return n=a.joseToDer(n,"ES"+e).toString("base64"),t(r,n,o)}}function createNoneSigner(){return function sign(){return""}}function createNoneVerifier(){return function verify(e,t){return""===t}}u&&(l+=" or a KeyObject",c+="or a KeyObject"),e.exports=function jwa(e){var t={hs:createHmacSigner,rs:createKeySigner,ps:createPSSKeySigner,es:createECDSASigner,none:createNoneSigner},r={hs:createHmacVerifier,rs:createKeyVerifier,ps:createPSSKeyVerifier,es:createECDSAVerifer,none:createNoneVerifier},n=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!n)throw typeError('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var o=(n[1]||n[3]).toLowerCase(),i=n[2];return{sign:t[o](i),verify:r[o](i)}}},652:(e,t,r)=>{var n=r(6456),o=r(3440);t.ALGORITHMS=["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],t.sign=n.sign,t.verify=o.verify,t.decode=o.decode,t.isValid=o.isValid,t.createSign=function createSign(e){return new n(e)},t.createVerify=function createVerify(e){return new o(e)}},2103:(e,t,r)=>{var n=r(2861).Buffer,o=r(2203);function DataStream(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=n.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=n.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}r(9023).inherits(DataStream,o),DataStream.prototype.write=function write(e){this.buffer=n.concat([this.buffer,n.from(e)]),this.emit("data",e)},DataStream.prototype.end=function end(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1},e.exports=DataStream},6456:(e,t,r)=>{var n=r(2861).Buffer,o=r(2103),i=r(6942),a=r(2203),s=r(7894),c=r(9023);function base64url(e,t){return n.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function jwsSign(e){var t=e.header,r=e.payload,n=e.secret||e.privateKey,o=e.encoding,a=i(t.alg),l=function jwsSecuredInput(e,t,r){r=r||"utf8";var n=base64url(s(e),"binary"),o=base64url(s(t),r);return c.format("%s.%s",n,o)}(t,r,o),u=a.sign(l,n);return c.format("%s.%s",l,u)}function SignStream(e){var t=e.secret||e.privateKey||e.key,r=new o(t);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=r,this.payload=new o(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}c.inherits(SignStream,a),SignStream.prototype.sign=function sign(){try{var e=jwsSign({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},SignStream.sign=jwsSign,e.exports=SignStream},7894:(e,t,r)=>{var n=r(181).Buffer;e.exports=function toString(e){return"string"==typeof e?e:"number"==typeof e||n.isBuffer(e)?e.toString():JSON.stringify(e)}},3440:(e,t,r)=>{var n=r(2861).Buffer,o=r(2103),i=r(6942),a=r(2203),s=r(7894),c=r(9023),l=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function safeJsonParse(e){if(function isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}function headerFromJWS(e){var t=e.split(".",1)[0];return safeJsonParse(n.from(t,"base64").toString("binary"))}function signatureFromJWS(e){return e.split(".")[2]}function isValidJws(e){return l.test(e)&&!!headerFromJWS(e)}function jwsVerify(e,t,r){if(!t){var n=new Error("Missing algorithm parameter for jws.verify");throw n.code="MISSING_ALGORITHM",n}var o=signatureFromJWS(e=s(e)),a=function securedInputFromJWS(e){return e.split(".",2).join(".")}(e);return i(t).verify(a,o,r)}function jwsDecode(e,t){if(t=t||{},!isValidJws(e=s(e)))return null;var r=headerFromJWS(e);if(!r)return null;var o=function payloadFromJWS(e,t){t=t||"utf8";var r=e.split(".")[1];return n.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(o=JSON.parse(o,t.encoding)),{header:r,payload:o,signature:signatureFromJWS(e)}}function VerifyStream(e){var t=(e=e||{}).secret||e.publicKey||e.key,r=new o(t);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=r,this.signature=new o(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}c.inherits(VerifyStream,a),VerifyStream.prototype.verify=function verify(){try{var e=jwsVerify(this.signature.buffer,this.algorithm,this.key.buffer),t=jwsDecode(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},VerifyStream.decode=jwsDecode,VerifyStream.isValid=isValidJws,VerifyStream.verify=jwsVerify,e.exports=VerifyStream},7651:(e,t,r)=>{const n=r(855),o=r(4977),i=r(7019),a=r(652),s=r(6111),c=r(7914),l=r(8928),u=r(3639),d=r(9001),h=r(5931),p=r(7083),{KeyObject:g,createSecretKey:f,createPrivateKey:m}=r(6982),y=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];o&&y.splice(3,0,"PS256","PS384","PS512");const C={expiresIn:{isValid:function(e){return l(e)||h(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return l(e)||h(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return h(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:s.bind(null,y),message:'"algorithm" must be a valid string enum value'},header:{isValid:d,message:'"header" must be an object'},encoding:{isValid:h,message:'"encoding" must be a string'},issuer:{isValid:h,message:'"issuer" must be a string'},subject:{isValid:h,message:'"subject" must be a string'},jwtid:{isValid:h,message:'"jwtid" must be a string'},noTimestamp:{isValid:c,message:'"noTimestamp" must be a boolean'},keyid:{isValid:h,message:'"keyid" must be a string'},mutatePayload:{isValid:c,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:c,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:c,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}},A={iat:{isValid:u,message:'"iat" should be a number of seconds'},exp:{isValid:u,message:'"exp" should be a number of seconds'},nbf:{isValid:u,message:'"nbf" should be a number of seconds'}};function validate(e,t,r,n){if(!d(r))throw new Error('Expected "'+n+'" to be a plain object.');Object.keys(r).forEach((function(o){const i=e[o];if(i){if(!i.isValid(r[o]))throw new Error(i.message)}else if(!t)throw new Error('"'+o+'" is not allowed in "'+n+'"')}))}const T={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},S=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];e.exports=function(e,t,r,o){"function"==typeof r?(o=r,r={}):r=r||{};const s="object"==typeof e&&!Buffer.isBuffer(e),c=Object.assign({alg:r.algorithm||"HS256",typ:s?"JWT":void 0,kid:r.keyid},r.header);function failure(e){if(o)return o(e);throw e}if(!t&&"none"!==r.algorithm)return failure(new Error("secretOrPrivateKey must have a value"));if(null!=t&&!(t instanceof g))try{t=m(t)}catch(e){try{t=f("string"==typeof t?Buffer.from(t):t)}catch(e){return failure(new Error("secretOrPrivateKey is not valid key material"))}}if(c.alg.startsWith("HS")&&"secret"!==t.type)return failure(new Error(`secretOrPrivateKey must be a symmetric key when using ${c.alg}`));if(/^(?:RS|PS|ES)/.test(c.alg)){if("private"!==t.type)return failure(new Error(`secretOrPrivateKey must be an asymmetric key when using ${c.alg}`));if(!r.allowInsecureKeySizes&&!c.alg.startsWith("ES")&&void 0!==t.asymmetricKeyDetails&&t.asymmetricKeyDetails.modulusLength<2048)return failure(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`))}if(void 0===e)return failure(new Error("payload is required"));if(s){try{!function validatePayload(e){return validate(A,!0,e,"payload")}(e)}catch(e){return failure(e)}r.mutatePayload||(e=Object.assign({},e))}else{const t=S.filter((function(e){return void 0!==r[e]}));if(t.length>0)return failure(new Error("invalid "+t.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return failure(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return failure(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function validateOptions(e){return validate(C,!1,e,"options")}(r)}catch(e){return failure(e)}if(!r.allowInvalidAsymmetricKeyTypes)try{i(c.alg,t)}catch(e){return failure(e)}const l=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:s&&(e.iat=l),void 0!==r.notBefore){try{e.nbf=n(r.notBefore,l)}catch(e){return failure(e)}if(void 0===e.nbf)return failure(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=n(r.expiresIn,l)}catch(e){return failure(e)}if(void 0===e.exp)return failure(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(T).forEach((function(t){const n=T[t];if(void 0!==r[t]){if(void 0!==e[n])return failure(new Error('Bad "options.'+t+'" option. The payload already has an "'+n+'" property.'));e[n]=r[t]}}));const u=r.encoding||"utf8";if("function"!=typeof o){let n=a.sign({header:c,payload:e,secret:t,encoding:u});if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&n.length<256)throw new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`);return n}o=o&&p(o),a.createSign({header:c,privateKey:t,payload:e,encoding:u}).once("error",o).once("done",(function(e){if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&e.length<256)return o(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`));o(null,e)}))}},1691:(e,t,r)=>{const n=r(1741),o=r(3726),i=r(8980),a=r(7260),s=r(855),c=r(7019),l=r(4977),u=r(652),{KeyObject:d,createSecretKey:h,createPublicKey:p}=r(6982),g=["RS256","RS384","RS512"],f=["ES256","ES384","ES512"],m=["RS256","RS384","RS512"],y=["HS256","HS384","HS512"];l&&(g.splice(g.length,0,"PS256","PS384","PS512"),m.splice(m.length,0,"PS256","PS384","PS512")),e.exports=function(e,t,r,l){let C;if("function"!=typeof r||l||(l=r,r={}),r||(r={}),r=Object.assign({},r),C=l||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return C(new n("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return C(new n("nonce must be a non-empty string"));if(void 0!==r.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof r.allowInvalidAsymmetricKeyTypes)return C(new n("allowInvalidAsymmetricKeyTypes must be a boolean"));const A=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return C(new n("jwt must be provided"));if("string"!=typeof e)return C(new n("jwt must be a string"));const T=e.split(".");if(3!==T.length)return C(new n("jwt malformed"));let S;try{S=a(e,{complete:!0})}catch(e){return C(e)}if(!S)return C(new n("invalid token"));const I=S.header;let E;if("function"==typeof t){if(!l)return C(new n("verify must be called asynchronous if secret or public key is provided as a callback"));E=t}else E=function(e,r){return r(null,t)};return E(I,(function(t,a){if(t)return C(new n("error in secret or public key callback: "+t.message));const l=""!==T[2].trim();if(!l&&a)return C(new n("jwt signature is required"));if(l&&!a)return C(new n("secret or public key must be provided"));if(!l&&!r.algorithms)return C(new n('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=a&&!(a instanceof d))try{a=p(a)}catch(e){try{a=h("string"==typeof a?Buffer.from(a):a)}catch(e){return C(new n("secretOrPublicKey is not valid key material"))}}if(r.algorithms||("secret"===a.type?r.algorithms=y:["rsa","rsa-pss"].includes(a.asymmetricKeyType)?r.algorithms=m:"ec"===a.asymmetricKeyType?r.algorithms=f:r.algorithms=g),-1===r.algorithms.indexOf(S.header.alg))return C(new n("invalid algorithm"));if(I.alg.startsWith("HS")&&"secret"!==a.type)return C(new n(`secretOrPublicKey must be a symmetric key when using ${I.alg}`));if(/^(?:RS|PS|ES)/.test(I.alg)&&"public"!==a.type)return C(new n(`secretOrPublicKey must be an asymmetric key when using ${I.alg}`));if(!r.allowInvalidAsymmetricKeyTypes)try{c(I.alg,a)}catch(e){return C(e)}let E;try{E=u.verify(e,S.header.alg,a)}catch(e){return C(e)}if(!E)return C(new n("invalid signature"));const w=S.payload;if(void 0!==w.nbf&&!r.ignoreNotBefore){if("number"!=typeof w.nbf)return C(new n("invalid nbf value"));if(w.nbf>A+(r.clockTolerance||0))return C(new o("jwt not active",new Date(1e3*w.nbf)))}if(void 0!==w.exp&&!r.ignoreExpiration){if("number"!=typeof w.exp)return C(new n("invalid exp value"));if(A>=w.exp+(r.clockTolerance||0))return C(new i("jwt expired",new Date(1e3*w.exp)))}if(r.audience){const e=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(w.aud)?w.aud:[w.aud]).some((function(t){return e.some((function(e){return e instanceof RegExp?e.test(t):e===t}))})))return C(new n("jwt audience invalid. expected: "+e.join(" or ")))}if(r.issuer){if("string"==typeof r.issuer&&w.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(w.iss))return C(new n("jwt issuer invalid. expected: "+r.issuer))}if(r.subject&&w.sub!==r.subject)return C(new n("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&w.jti!==r.jwtid)return C(new n("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&w.nonce!==r.nonce)return C(new n("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof w.iat)return C(new n("iat required when maxAge is specified"));const e=s(r.maxAge,w.iat);if(void 0===e)return C(new n('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(A>=e+(r.clockTolerance||0))return C(new i("maxAge exceeded",new Date(1e3*e)))}if(!0===r.complete){const e=S.signature;return C(null,{header:I,payload:w,signature:e})}return C(null,w)}))}},6111:e=>{var t=1/0,r=9007199254740991,n=17976931348623157e292,o=NaN,i="[object Arguments]",a="[object Function]",s="[object GeneratorFunction]",c="[object String]",l="[object Symbol]",u=/^\s+|\s+$/g,d=/^[-+]0x[0-9a-f]+$/i,h=/^0b[01]+$/i,p=/^0o[0-7]+$/i,g=/^(?:0|[1-9]\d*)$/,f=parseInt;function baseIsNaN(e){return e!=e}function baseValues(e,t){return function arrayMap(e,t){for(var r=-1,n=e?e.length:0,o=Array(n);++r<n;)o[r]=t(e[r],r,e);return o}(t,(function(t){return e[t]}))}var m=Object.prototype,y=m.hasOwnProperty,C=m.toString,A=m.propertyIsEnumerable,T=function overArg(e,t){return function(r){return e(t(r))}}(Object.keys,Object),S=Math.max;function arrayLikeKeys(e,t){var r=I(e)||function isArguments(e){return function isArrayLikeObject(e){return isObjectLike(e)&&isArrayLike(e)}(e)&&y.call(e,"callee")&&(!A.call(e,"callee")||C.call(e)==i)}(e)?function baseTimes(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,o=!!n;for(var a in e)!t&&!y.call(e,a)||o&&("length"==a||isIndex(a,n))||r.push(a);return r}function baseKeys(e){if(!function isPrototype(e){var t=e&&e.constructor,r="function"==typeof t&&t.prototype||m;return e===r}(e))return T(e);var t=[];for(var r in Object(e))y.call(e,r)&&"constructor"!=r&&t.push(r);return t}function isIndex(e,t){return!!(t=null==t?r:t)&&("number"==typeof e||g.test(e))&&e>-1&&e%1==0&&e<t}var I=Array.isArray;function isArrayLike(e){return null!=e&&function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=r}(e.length)&&!function isFunction(e){var t=isObject(e)?C.call(e):"";return t==a||t==s}(e)}function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function isObjectLike(e){return!!e&&"object"==typeof e}e.exports=function includes(e,r,i,a){e=isArrayLike(e)?e:function values(e){return e?baseValues(e,function keys(e){return isArrayLike(e)?arrayLikeKeys(e):baseKeys(e)}(e)):[]}(e),i=i&&!a?function toInteger(e){var r=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||isObjectLike(e)&&C.call(e)==l}(e))return o;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(u,"");var r=h.test(e);return r||p.test(e)?f(e.slice(2),r?2:8):d.test(e)?o:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*n}return e==e?e:0}(e),i=r%1;return r==r?i?r-i:r:0}(i):0;var s=e.length;return i<0&&(i=S(s+i,0)),function isString(e){return"string"==typeof e||!I(e)&&isObjectLike(e)&&C.call(e)==c}(e)?i<=s&&e.indexOf(r,i)>-1:!!s&&function baseIndexOf(e,t,r){if(t!=t)return function baseFindIndex(e,t,r,n){for(var o=e.length,i=r+(n?1:-1);n?i--:++i<o;)if(t(e[i],i,e))return i;return-1}(e,baseIsNaN,r);for(var n=r-1,o=e.length;++n<o;)if(e[n]===t)return n;return-1}(e,r,i)>-1}},7914:e=>{var t=Object.prototype.toString;e.exports=function isBoolean(e){return!0===e||!1===e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==t.call(e)}},8928:e=>{var t=1/0,r=17976931348623157e292,n=NaN,o="[object Symbol]",i=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,u=Object.prototype.toString;function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function isInteger(e){return"number"==typeof e&&e==function toInteger(e){var d=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&u.call(e)==o}(e))return n;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var r=s.test(e);return r||c.test(e)?l(e.slice(2),r?2:8):a.test(e)?n:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*r}return e==e?e:0}(e),h=d%1;return d==d?h?d-h:d:0}(e)}},3639:e=>{var t=Object.prototype.toString;e.exports=function isNumber(e){return"number"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==t.call(e)}},9001:e=>{var t=Function.prototype,r=Object.prototype,n=t.toString,o=r.hasOwnProperty,i=n.call(Object),a=r.toString,s=function overArg(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object);e.exports=function isPlainObject(e){if(!function isObjectLike(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=a.call(e)||function isHostObject(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=s(e);if(null===t)return!0;var r=o.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&n.call(r)==i}},5931:e=>{var t=Object.prototype.toString,r=Array.isArray;e.exports=function isString(e){return"string"==typeof e||!r(e)&&function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==t.call(e)}},7083:e=>{var t=1/0,r=17976931348623157e292,n=NaN,o="[object Symbol]",i=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,u=Object.prototype.toString;function before(e,d){var h;if("function"!=typeof d)throw new TypeError("Expected a function");return e=function toInteger(e){var d=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&u.call(e)==o}(e))return n;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(i,"");var r=s.test(e);return r||c.test(e)?l(e.slice(2),r?2:8):a.test(e)?n:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*r}return e==e?e:0}(e),h=d%1;return d==d?h?d-h:d:0}(e),function(){return--e>0&&(h=d.apply(this,arguments)),e<=1&&(d=void 0),h}}function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function once(e){return before(2,e)}},2861:(e,t,r)=>{var n=r(181),o=n.Buffer;function copyProps(e,t){for(var r in e)t[r]=e[r]}function SafeBuffer(e,t,r){return o(e,t,r)}o.from&&o.alloc&&o.allocUnsafe&&o.allocUnsafeSlow?e.exports=n:(copyProps(n,t),t.Buffer=SafeBuffer),copyProps(o,SafeBuffer),SafeBuffer.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return o(e,t,r)},SafeBuffer.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=o(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},SafeBuffer.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o(e)},SafeBuffer.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}}};
//# sourceMappingURL=feature-162.js.map