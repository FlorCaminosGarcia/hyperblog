"use strict";var it=Object.create;var ge=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var at=Object.getPrototypeOf,lt=Object.prototype.hasOwnProperty;var D=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var ut=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ot(e))!lt.call(n,i)&&i!==t&&ge(n,i,{get:()=>e[i],enumerable:!(r=st(e,i))||r.enumerable});return n};var dt=(n,e,t)=>(t=n!=null?it(at(n)):{},ut(e||!n||!n.__esModule?ge(t,"default",{value:n,enumerable:!0}):t,n));var xe=D(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.bytePairEncode=k.BinaryMap=k.binaryMapKey=void 0;var ct=(n,e,t)=>{let r=t-e,i=16777215>>>Math.max(0,(3-r)*8),s=(n[e+0]|n[e+1]<<8|n[e+2]<<16)&i,o=16777215>>>Math.min(31,Math.max(0,(6-r)*8)),l=(n[e+3]|n[e+4]<<8|n[e+5]<<16)&o;return s+16777216*l};k.binaryMapKey=ct;var te=class n{constructor(){this.nested=new Map,this.final=new Map}get(e,t=0,r=e.length){let i=r<6+t,s=(0,k.binaryMapKey)(e,t,r);return i?this.final.get(s):this.nested.get(s)?.get(e,6+t,r)}set(e,t){let r=(0,k.binaryMapKey)(e,0,e.length);if(e.length<6){this.final.set(r,t);return}let s=this.nested.get(r);if(s instanceof n)s.set(e.subarray(6),t);else{let o=new n;o.set(e.subarray(6),t),this.nested.set(r,o)}}};k.BinaryMap=te;var w=new Int32Array(128),x=new Int32Array(128);function ft(n,e,t){if(t===1)return[e.get(n)];let r=2147483647,i=-1;for(;w.length<t*2;)x=new Int32Array(x.length*2),w=new Int32Array(w.length*2);for(let a=0;a<t-1;a++){let d=e.get(n,a,a+2)??2147483647;d<r&&(r=d,i=a),x[a]=a,w[a]=d}x[t-1]=t-1,w[t-1]=2147483647,x[t]=t,w[t]=2147483647;let s=t+1;function o(a,d=0){if(a+d+2<s){let p=e.get(n,x[a],x[a+d+2]);if(p!==void 0)return p}return 2147483647}for(;r!==2147483647;){w[x[i]]=o(i,1),i>0&&(w[x[i-1]]=o(i-1,1));for(let a=i+1;a<s-1;a++)x[a]=x[a+1];s--,i=-1,r=2147483647;for(let a=0;a<s-1;a++){let d=w[x[a]];w[x[a]]<r&&(r=d,i=a)}}let l=[];for(let a=0;a<s-1;a++)l.push(e.get(n,x[a],x[a+1]));return l}k.bytePairEncode=ft});var ve=D(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.makeTextEncoder=void 0;var re=class{constructor(){this.length=0,this.encoder=new TextEncoder}encode(e){let t=this.encoder.encode(e);return this.length=t.length,t}},ne=class{constructor(){this.buffer=Buffer.alloc(256),this.length=0}encode(e){for(;;){if(this.length=this.buffer.write(e,"utf8"),this.length<this.buffer.length-4)return this.buffer;this.buffer=Buffer.alloc(this.length*2),this.length=this.buffer.write(e)}}},pt=()=>typeof Buffer<"u"?new ne:new re;O.makeTextEncoder=pt});var _e=D(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.LRUCache=void 0;var ie=class{constructor(e){this.size=e,this.nodes=new Map}get(e){let t=this.nodes.get(e);if(t)return this.moveToHead(t),t.value}set(e,t){let r=this.nodes.get(e);if(r)r.value=t,this.moveToHead(r);else{let i=new se(e,t);this.nodes.set(e,i),this.addNode(i),this.nodes.size>this.size&&(this.nodes.delete(this.tail.key),this.removeNode(this.tail))}}moveToHead(e){this.removeNode(e),e.next=void 0,e.prev=void 0,this.addNode(e)}addNode(e){this.head&&(this.head.prev=e,e.next=this.head),this.tail||(this.tail=e),this.head=e}removeNode(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev}};F.LRUCache=ie;var se=class{constructor(e,t){this.key=e,this.value=t}}});var ae=D(j=>{"use strict";Object.defineProperty(j,"__esModule",{value:!0});j.TikTokenizer=void 0;var C=xe(),ht=ve(),bt=_e();function Tt(n){let e=new Map;try{let i=require("fs").readFileSync(n,"utf-8");return t(i),e}catch(r){throw new Error(`Failed to load from BPE encoder file stream: ${r}`)}function t(r){for(let i of r.split(/[\r\n]+/)){if(i.trim()==="")continue;let s=i.split(" ");if(s.length!==2)throw new Error("Invalid format in the BPE encoder file stream");let o=new Uint8Array(Buffer.from(s[0],"base64")),l=parseInt(s[1]);if(!isNaN(l))e.set(o,l);else throw new Error(`Can't parse ${s[1]} to integer`)}}}function mt(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var oe=class{constructor(e,t,r,i=8192){this.textEncoder=(0,ht.makeTextEncoder)(),this.textDecoder=new TextDecoder("utf-8"),this.cache=new bt.LRUCache(i);let s=typeof e=="string"?Tt(e):e;this.init(s,t,r)}init(e,t,r){this.encoder=new C.BinaryMap;for(let[i,s]of e)this.encoder.set(i,s);this.regex=new RegExp(r,"gu"),this.specialTokensRegex=new RegExp(Array.from(t.keys()).map(i=>mt(i)).join("|")),this.specialTokensEncoder=t,this.decoder=new Map;for(let[i,s]of e)this.decoder.set(s,i);if(e.size!==this.decoder.size)throw new Error("Encoder and decoder sizes do not match");this.specialTokensDecoder=new Map;for(let[i,s]of t)this.specialTokensDecoder.set(s,i)}findNextSpecialToken(e,t,r){let i=t,s=null;if(r&&this.specialTokensRegex)for(;s=e.slice(i).match(this.specialTokensRegex),!(!s||r&&r.includes(s[0]));)i+=s.index+1;let o=s?i+s.index:e.length;return[s,o]}encode(e,t){let r=[],i=0;for(;;){let s,o;if([s,o]=this.findNextSpecialToken(e,i,t),o>i&&this.encodeByIndex(e,r,i,o),s){if(i=i+this.encodeSpecialToken(r,s),i>=e.length)break}else break}return r}encodeSpecialToken(e,t){let r=this.specialTokensEncoder?.get(t[0]);return e.push(r),t.index+t[0].length}encodeByIndex(e,t,r,i){let s,o=e.substring(r,i);for(this.regex.lastIndex=0;s=this.regex.exec(o);){let l=this.cache.get(s[0]);if(l)for(let a of l)t.push(a);else{let a=this.textEncoder.encode(s[0]),d=this.encoder.get(a,0,this.textEncoder.length);if(d!==void 0)t.push(d),this.cache.set(s[0],[d]);else{let p=(0,C.bytePairEncode)(a,this.encoder,this.textEncoder.length);for(let f of p)t.push(f);this.cache.set(s[0],p)}}}}encodeTrimSuffixByIndex(e,t,r,i,s,o,l){let a,d=e.substring(r,i);for(this.regex.lastIndex=0;a=this.regex.exec(d);){let p=a[0],f=this.cache.get(p);if(f)if(o+f.length<=s)o+=f.length,l+=p.length,t.push(...f);else{let b=s-o;o+=b,l+=p.length,t.push(...f.slice(0,b));break}else{let b=this.textEncoder.encode(p),y=this.encoder.get(b,0,b.length);if(y!==void 0)if(this.cache.set(p,[y]),o+1<=s)o++,l+=p.length,t.push(y);else break;else{let _=(0,C.bytePairEncode)(b,this.encoder,this.textEncoder.length);if(this.cache.set(p,_),o+_.length<=s){o+=_.length,l+=p.length;for(let I of _)t.push(I)}else{let I=s-o;o+=I,l+=p.length;for(let g=0;g<I;g++)t.push(_[g]);break}}}if(o>=s)break}return{tokenCount:o,encodeLength:l}}encodeTrimSuffix(e,t,r){let i=[],s=0,o=0,l=0;for(;;){let d,p;if([d,p]=this.findNextSpecialToken(e,s,r),p>s){let{tokenCount:f,encodeLength:b}=this.encodeTrimSuffixByIndex(e,i,s,p,t,o,l);if(o=f,l=b,o>=t)break}if(d!==null){if(o++,o<=t&&(s=s+this.encodeSpecialToken(i,d),l+=d[0].length,s>=e.length)||o>=t)break}else break}let a=l===e.length?e:e.slice(0,l);return{tokenIds:i,text:a}}encodeTrimPrefix(e,t,r){let i=[],s=0,o=0,l=0,a=new Map;for(a.set(o,l);;){let b,y;if([b,y]=this.findNextSpecialToken(e,s,r),y>s){let _,I=e.substring(s,y);for(this.regex.lastIndex=0;_=this.regex.exec(I);){let g=_[0],S=this.cache.get(g);if(S)o+=S.length,l+=g.length,i.push(...S),a.set(o,l);else{let ee=this.textEncoder.encode(g),P=this.encoder.get(ee);if(P!==void 0)this.cache.set(g,[P]),o++,l+=g.length,i.push(P),a.set(o,l);else{let N=(0,C.bytePairEncode)(ee,this.encoder,this.textEncoder.length);this.cache.set(g,N),o+=N.length,l+=g.length;for(let me of N)i.push(me);a.set(o,l)}}}}if(b!==null){if(s=s+this.encodeSpecialToken(i,b),o++,l+=b[0].length,a.set(o,l),s>=e.length)break}else break}if(o<=t)return{tokenIds:i,text:e};let d=o-t,p=0,f=0;for(let[b,y]of a)if(b>=d){p=b,f=y;break}if(p>t){let b=this.encode(e,r),y=b.slice(b.length-t);return{tokenIds:y,text:this.decode(y)}}return{tokenIds:i.slice(p),text:e.slice(f)}}decode(e){let t=[];for(let r of e){let i=[],s=this.decoder?.get(r);if(s!==void 0)i=Array.from(s);else{let o=this.specialTokensDecoder?.get(r);if(o!==void 0){let l=this.textEncoder.encode(o);i=Array.from(l.subarray(0,this.textEncoder.length))}}t.push(...i)}return this.textDecoder.decode(new Uint8Array(t))}};j.TikTokenizer=oe});var Be=D(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.createTokenizer=T.createByEncoderName=T.createByModelName=T.getRegexByModel=T.getRegexByEncoder=T.getSpecialTokensByModel=T.getSpecialTokensByEncoder=T.MODEL_TO_ENCODING=void 0;var yt=ae(),gt=new Map([["gpt-4o-","o200k_base"],["gpt-4-","cl100k_base"],["gpt-3.5-turbo-","cl100k_base"],["gpt-35-turbo-","cl100k_base"]]);T.MODEL_TO_ENCODING=new Map([["gpt-4o","o200k_base"],["gpt-4","cl100k_base"],["gpt-3.5-turbo","cl100k_base"],["text-davinci-003","p50k_base"],["text-davinci-002","p50k_base"],["text-davinci-001","r50k_base"],["text-curie-001","r50k_base"],["text-babbage-001","r50k_base"],["text-ada-001","r50k_base"],["davinci","r50k_base"],["curie","r50k_base"],["babbage","r50k_base"],["ada","r50k_base"],["code-davinci-002","p50k_base"],["code-davinci-001","p50k_base"],["code-cushman-002","p50k_base"],["code-cushman-001","p50k_base"],["davinci-codex","p50k_base"],["cushman-codex","p50k_base"],["text-davinci-edit-001","p50k_edit"],["code-davinci-edit-001","p50k_edit"],["text-embedding-ada-002","cl100k_base"],["text-similarity-davinci-001","r50k_base"],["text-similarity-curie-001","r50k_base"],["text-similarity-babbage-001","r50k_base"],["text-similarity-ada-001","r50k_base"],["text-search-davinci-doc-001","r50k_base"],["text-search-curie-doc-001","r50k_base"],["text-search-babbage-doc-001","r50k_base"],["text-search-ada-doc-001","r50k_base"],["code-search-babbage-code-001","r50k_base"],["code-search-ada-code-001","r50k_base"],["gpt2","gpt2"]]);var z="<|endoftext|>",Ie="<|fim_prefix|>",we="<|fim_middle|>",ke="<|fim_suffix|>",Ee="<|endofprompt|>",M="'s|'t|'re|'ve|'m|'ll|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+",Se="(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)|[^\\r\\n\\p{L}\\p{N}]?\\p{L}+|\\p{N}{1,3}| ?[^\\s\\p{L}\\p{N}]+[\\r\\n]*|\\s*[\\r\\n]+|\\s+(?!\\S)|\\s+",xt=[`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]*[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]+(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]+[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]*(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,"\\p{N}{1,3}"," ?[^\\s\\p{L}\\p{N}]+[\\r\\n/]*","\\s*[\\r\\n]+","\\s+(?!\\S)","\\s+"],Re=xt.join("|");function le(n){let e="";if(T.MODEL_TO_ENCODING.has(n))e=T.MODEL_TO_ENCODING.get(n);else for(let[t,r]of gt)if(n.startsWith(t)){e=r;break}return e}async function vt(n,e){let t=require("fs"),r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch file from ${n}. Status code: ${r.status}`);let i=await r.text();t.writeFileSync(e,i)}function ue(n){let e=new Map([[z,50256]]);switch(n){case"o200k_base":e=new Map([[z,199999],[Ee,200018]]);break;case"cl100k_base":e=new Map([[z,100257],[Ie,100258],[we,100259],[ke,100260],[Ee,100276]]);break;case"p50k_edit":e=new Map([[z,50256],[Ie,50281],[we,50282],[ke,50283]]);break;default:break}return e}T.getSpecialTokensByEncoder=ue;function _t(n){let e=le(n);return ue(e)}T.getSpecialTokensByModel=_t;function De(n){switch(n){case"o200k_base":return Re;case"cl100k_base":return Se;default:break}return M}T.getRegexByEncoder=De;function It(n){let e=le(n);return De(e)}T.getRegexByModel=It;async function wt(n,e=null){return Ae(le(n),e)}T.createByModelName=wt;async function Ae(n,e=null){let t,r,i=ue(n);switch(n){case"o200k_base":t=Re,r="https://openaipublic.blob.core.windows.net/encodings/o200k_base.tiktoken";break;case"cl100k_base":t=Se,r="https://openaipublic.blob.core.windows.net/encodings/cl100k_base.tiktoken";break;case"p50k_base":t=M,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"p50k_edit":t=M,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"r50k_base":t=M,r="https://openaipublic.blob.core.windows.net/encodings/r50k_base.tiktoken";break;case"gpt2":t=M,r="https://raw.githubusercontent.com/microsoft/Tokenizer/main/model/gpt2.tiktoken";break;default:throw new Error(`Doesn't support this encoder [${n}]`)}e!==null&&(i=new Map([...i,...e]));let s=require("fs"),o=require("path"),l=o.basename(r),a=o.resolve(__dirname,"..","model");s.existsSync(a)||s.mkdirSync(a,{recursive:!0});let d=o.resolve(a,l);return s.existsSync(d)||(console.log(`Downloading file from ${r}`),await vt(r,d),console.log(`Saved file to ${d}`)),Me(d,i,t)}T.createByEncoderName=Ae;function Me(n,e,t,r=8192){return new yt.TikTokenizer(n,e,t,r)}T.createTokenizer=Me});var Ve=D(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.createTokenizer=m.createByEncoderName=m.createByModelName=m.getSpecialTokensByModel=m.getSpecialTokensByEncoder=m.getRegexByModel=m.getRegexByEncoder=m.MODEL_TO_ENCODING=m.TikTokenizer=void 0;var kt=ae();Object.defineProperty(m,"TikTokenizer",{enumerable:!0,get:function(){return kt.TikTokenizer}});var E=Be();Object.defineProperty(m,"MODEL_TO_ENCODING",{enumerable:!0,get:function(){return E.MODEL_TO_ENCODING}});Object.defineProperty(m,"getRegexByEncoder",{enumerable:!0,get:function(){return E.getRegexByEncoder}});Object.defineProperty(m,"getRegexByModel",{enumerable:!0,get:function(){return E.getRegexByModel}});Object.defineProperty(m,"getSpecialTokensByEncoder",{enumerable:!0,get:function(){return E.getSpecialTokensByEncoder}});Object.defineProperty(m,"getSpecialTokensByModel",{enumerable:!0,get:function(){return E.getSpecialTokensByModel}});Object.defineProperty(m,"createByModelName",{enumerable:!0,get:function(){return E.createByModelName}});Object.defineProperty(m,"createByEncoderName",{enumerable:!0,get:function(){return E.createByEncoderName}});Object.defineProperty(m,"createTokenizer",{enumerable:!0,get:function(){return E.createTokenizer}})});var rt=require("worker_threads");var A=dt(Ve());var de=class{constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?W.isErrorNoTelemetry(e)?new W(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}},Et=new de;function q(n){St(n)||Et.onUnexpectedError(n)}var ce="Canceled";function St(n){return n instanceof $?!0:n instanceof Error&&n.name===ce&&n.message===ce}var $=class extends Error{constructor(){super(ce),this.name=this.message}},Le=class n extends Error{static{this._name="PendingMigrationError"}static is(e){return e instanceof n||e instanceof Error&&e.name===n._name}constructor(e){super(e),this.name=n._name}};var W=class n extends Error{constructor(e){super(e),this.name="CodeExpectedError"}static fromError(e){if(e instanceof n)return e;let t=new n;return t.message=e.message,t.stack=e.stack,t}static isErrorNoTelemetry(e){return e.name==="CodeExpectedError"}},B=class n extends Error{constructor(e){super(e||"An unexpected bug occurred."),Object.setPrototypeOf(this,n.prototype)}};var R=class{constructor(){this._n=1;this._val=0}update(e){return this._val=this._val+(e-this._val)/this._n,this._n+=1,this._val}get value(){return this._val}};var Dt=globalThis.performance.now.bind(globalThis.performance),G=class n{static create(e){return new n(e)}constructor(e){this._now=e===!1?Date.now:Dt,this._startTime=this._now(),this._stopTime=-1}stop(){this._stopTime=this._now()}reset(){this._startTime=this._now(),this._stopTime=-1}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}};var et=require("fs");var H=class{constructor(e){this.executor=e;this._state=0}get hasValue(){return this._state===2}get value(){if(this._state===0){this._state=1;try{this._value=this.executor()}catch(e){this._error=e}finally{this._state=2}}else if(this._state===1)throw new Error("Cannot read the value of a lazy that is being initialized");if(this._error)throw this._error;return this._value}get rawValue(){return this._value}};function At(n,e,t=0,r=n.length){let i=t,s=r;for(;i<s;){let o=Math.floor((i+s)/2);e(n[o])?i=o+1:s=o}return i-1}var Ke=class n{constructor(e){this._array=e;this._findLastMonotonousLastIdx=0}static{this.assertInvariants=!1}findLastMonotonous(e){if(n.assertInvariants){if(this._prevFindLastPredicate){for(let r of this._array)if(this._prevFindLastPredicate(r)&&!e(r))throw new Error("MonotonousArray: current predicate must be weaker than (or equal to) the previous predicate.")}this._prevFindLastPredicate=e}let t=At(this._array,e,this._findLastMonotonousLastIdx);return this._findLastMonotonousLastIdx=t+1,t===-1?void 0:this._array[t]}};var Ne;(l=>{function n(a){return a<0}l.isLessThan=n;function e(a){return a<=0}l.isLessThanOrEqual=e;function t(a){return a>0}l.isGreaterThan=t;function r(a){return a===0}l.isNeitherLessOrGreaterThan=r,l.greaterThan=1,l.lessThan=-1,l.neitherLessOrGreaterThan=0})(Ne||={});function Ue(n,e){return(t,r)=>e(n(t),n(r))}var Oe=(n,e)=>n-e;var Pe=class n{constructor(e){this.iterate=e}static{this.empty=new n(e=>{})}forEach(e){this.iterate(t=>(e(t),!0))}toArray(){let e=[];return this.iterate(t=>(e.push(t),!0)),e}filter(e){return new n(t=>this.iterate(r=>e(r)?t(r):!0))}map(e){return new n(t=>this.iterate(r=>t(e(r))))}some(e){let t=!1;return this.iterate(r=>(t=e(r),!t)),t}findFirst(e){let t;return this.iterate(r=>e(r)?(t=r,!1):!0),t}findLast(e){let t;return this.iterate(r=>(e(r)&&(t=r),!0)),t}findLastMaxBy(e){let t,r=!0;return this.iterate(i=>((r||Ne.isGreaterThan(e(i,t)))&&(r=!1,t=i),!0)),t}};function ze(n,e){let t=Object.create(null);for(let r of n){let i=e(r),s=t[i];s||(s=t[i]=[]),s.push(r)}return t}var Ce,je,Fe=class{constructor(e,t){this.toKey=t;this._map=new Map;this[Ce]="SetWithKey";for(let r of e)this.add(r)}get size(){return this._map.size}add(e){let t=this.toKey(e);return this._map.set(t,e),this}delete(e){return this._map.delete(this.toKey(e))}has(e){return this._map.has(this.toKey(e))}*entries(){for(let e of this._map.values())yield[e,e]}keys(){return this.values()}*values(){for(let e of this._map.values())yield e}clear(){this._map.clear()}forEach(e,t){this._map.forEach(r=>e.call(t,r,r,this))}[(je=Symbol.iterator,Ce=Symbol.toStringTag,je)](){return this.values()}};var fe=class{constructor(e,t){this.uri=e;this.value=t}};function Mt(n){return Array.isArray(n)}var qe,X=class n{constructor(e,t){this[qe]="ResourceMap";if(e instanceof n)this.map=new Map(e.map),this.toKey=t??n.defaultToKey;else if(Mt(e)){this.map=new Map,this.toKey=t??n.defaultToKey;for(let[r,i]of e)this.set(r,i)}else this.map=new Map,this.toKey=e??n.defaultToKey}static{this.defaultToKey=e=>e.toString()}set(e,t){return this.map.set(this.toKey(e),new fe(e,t)),this}get(e){return this.map.get(this.toKey(e))?.value}has(e){return this.map.has(this.toKey(e))}get size(){return this.map.size}clear(){this.map.clear()}delete(e){return this.map.delete(this.toKey(e))}forEach(e,t){typeof t<"u"&&(e=e.bind(t));for(let[r,i]of this.map)e(i.value,i.uri,this)}*values(){for(let e of this.map.values())yield e.value}*keys(){for(let e of this.map.values())yield e.uri}*entries(){for(let e of this.map.values())yield[e.uri,e.value]}*[(qe=Symbol.toStringTag,Symbol.iterator)](){for(let[,e]of this.map)yield[e.uri,e.value]}},Ge,$e=class{constructor(e,t){this[Ge]="ResourceSet";!e||typeof e=="function"?this._map=new X(e):(this._map=new X(t),e.forEach(this.add,this))}get size(){return this._map.size}add(e){return this._map.set(e,e),this}clear(){this._map.clear()}delete(e){return this._map.delete(e)}forEach(e,t){this._map.forEach((r,i)=>e.call(t,i,i,this))}has(e){return this._map.has(e)}entries(){return this._map.entries()}keys(){return this._map.keys()}values(){return this._map.keys()}[(Ge=Symbol.toStringTag,Symbol.iterator)](){return this.keys()}};var He,We=class{constructor(){this[He]="LinkedMap";this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){return this._head?.value}get last(){return this._tail?.value}has(e){return this._map.has(e)}get(e,t=0){let r=this._map.get(e);if(r)return t!==0&&this.touch(r,t),r.value}set(e,t,r=0){let i=this._map.get(e);if(i)i.value=t,r!==0&&this.touch(i,r);else{switch(i={key:e,value:t,next:void 0,previous:void 0},r){case 0:this.addItemLast(i);break;case 1:this.addItemFirst(i);break;case 2:this.addItemLast(i);break;default:this.addItemLast(i);break}this._map.set(e,i),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let t=this._map.get(e);if(t)return this._map.delete(e),this.removeItem(t),this._size--,t.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,t){let r=this._state,i=this._head;for(;i;){if(t?e.bind(t)(i.value,i.key,this):e(i.value,i.key,this),this._state!==r)throw new Error("LinkedMap got modified during iteration.");i=i.next}}keys(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:r.key,done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}values(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:r.value,done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}entries(){let e=this,t=this._state,r=this._head,i={[Symbol.iterator](){return i},next(){if(e._state!==t)throw new Error("LinkedMap got modified during iteration.");if(r){let s={value:[r.key,r.value],done:!1};return r=r.next,s}else return{value:void 0,done:!0}}};return i}[(He=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._head,r=this.size;for(;t&&r>e;)this._map.delete(t.key),t=t.next,r--;this._head=t,this._size=r,t&&(t.previous=void 0),this._state++}trimNew(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._tail,r=this.size;for(;t&&r>e;)this._map.delete(t.key),t=t.previous,r--;this._tail=t,this._size=r,t&&(t.next=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let t=e.next,r=e.previous;if(!t||!r)throw new Error("Invalid list");t.previous=r,r.next=t}e.next=void 0,e.previous=void 0,this._state++}touch(e,t){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(t!==1&&t!==2)){if(t===1){if(e===this._head)return;let r=e.next,i=e.previous;e===this._tail?(i.next=void 0,this._tail=i):(r.previous=i,i.next=r),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(t===2){if(e===this._tail)return;let r=e.next,i=e.previous;e===this._head?(r.previous=void 0,this._head=r):(r.previous=i,i.next=r),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((t,r)=>{e.push([r,t])}),e}fromJSON(e){this.clear();for(let[t,r]of e)this.set(t,r)}};var J=class{constructor(){this.map=new Map}add(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}delete(e,t){let r=this.map.get(e);r&&(r.delete(t),r.size===0&&this.map.delete(e))}forEach(e,t){let r=this.map.get(e);r&&r.forEach(t)}get(e){let t=this.map.get(e);return t||new Set}};function Xe(n){return!!n&&typeof n[Symbol.iterator]=="function"}var pe;(nt=>{function n(u){return!!u&&typeof u=="object"&&typeof u[Symbol.iterator]=="function"}nt.is=n;let e=Object.freeze([]);function t(){return e}nt.empty=t;function*r(u){yield u}nt.single=r;function i(u){return n(u)?u:r(u)}nt.wrap=i;function s(u){return u||e}nt.from=s;function*o(u){for(let c=u.length-1;c>=0;c--)yield u[c]}nt.reverse=o;function l(u){return!u||u[Symbol.iterator]().next().done===!0}nt.isEmpty=l;function a(u){return u[Symbol.iterator]().next().value}nt.first=a;function d(u,c){let h=0;for(let v of u)if(c(v,h++))return!0;return!1}nt.some=d;function p(u,c){let h=0;for(let v of u)if(!c(v,h++))return!1;return!0}nt.every=p;function f(u,c){for(let h of u)if(c(h))return h}nt.find=f;function*b(u,c){for(let h of u)c(h)&&(yield h)}nt.filter=b;function*y(u,c){let h=0;for(let v of u)yield c(v,h++)}nt.map=y;function*_(u,c){let h=0;for(let v of u)yield*c(v,h++)}nt.flatMap=_;function*I(...u){for(let c of u)Xe(c)?yield*c:yield c}nt.concat=I;function g(u,c,h){let v=h;for(let U of u)v=c(v,U);return v}nt.reduce=g;function S(u){let c=0;for(let h of u)c++;return c}nt.length=S;function*ee(u,c,h=u.length){for(c<-u.length&&(c=0),c<0&&(c+=u.length),h<0?h+=u.length:h>u.length&&(h=u.length);c<h;c++)yield u[c]}nt.slice=ee;function P(u,c=Number.POSITIVE_INFINITY){let h=[];if(c===0)return[h,u];let v=u[Symbol.iterator]();for(let U=0;U<c;U++){let ye=v.next();if(ye.done)return[h,nt.empty()];h.push(ye.value)}return[h,{[Symbol.iterator](){return v}}]}nt.consume=P;async function N(u){let c=[];for await(let h of u)c.push(h);return c}nt.asyncToArray=N;async function me(u){let c=[];for await(let h of u)c=c.concat(h);return c}nt.asyncToArrayFlat=me})(pe||={});var Bt=!1,Y=null;var Je=class n{constructor(){this.livingDisposables=new Map}static{this.idx=0}getDisposableData(e){let t=this.livingDisposables.get(e);return t||(t={parent:null,source:null,isSingleton:!1,value:e,idx:n.idx++},this.livingDisposables.set(e,t)),t}trackDisposable(e){let t=this.getDisposableData(e);t.source||(t.source=new Error().stack)}setParent(e,t){let r=this.getDisposableData(e);r.parent=t}markAsDisposed(e){this.livingDisposables.delete(e)}markAsSingleton(e){this.getDisposableData(e).isSingleton=!0}getRootParent(e,t){let r=t.get(e);if(r)return r;let i=e.parent?this.getRootParent(this.getDisposableData(e.parent),t):e;return t.set(e,i),i}getTrackedDisposables(){let e=new Map;return[...this.livingDisposables.entries()].filter(([,r])=>r.source!==null&&!this.getRootParent(r,e).isSingleton).flatMap(([r])=>r)}computeLeakingDisposables(e=10,t){let r;if(t)r=t;else{let a=new Map,d=[...this.livingDisposables.values()].filter(f=>f.source!==null&&!this.getRootParent(f,a).isSingleton);if(d.length===0)return;let p=new Set(d.map(f=>f.value));if(r=d.filter(f=>!(f.parent&&p.has(f.parent))),r.length===0)throw new Error("There are cyclic diposable chains!")}if(!r)return;function i(a){function d(f,b){for(;f.length>0&&b.some(y=>typeof y=="string"?y===f[0]:f[0].match(y));)f.shift()}let p=a.source.split(`
`).map(f=>f.trim().replace("at ","")).filter(f=>f!=="");return d(p,["Error",/^trackDisposable \(.*\)$/,/^DisposableTracker.trackDisposable \(.*\)$/]),p.reverse()}let s=new J;for(let a of r){let d=i(a);for(let p=0;p<=d.length;p++)s.add(d.slice(0,p).join(`
`),a)}r.sort(Ue(a=>a.idx,Oe));let o="",l=0;for(let a of r.slice(0,e)){l++;let d=i(a),p=[];for(let f=0;f<d.length;f++){let b=d[f];b=`(shared with ${s.get(d.slice(0,f+1).join(`
`)).size}/${r.length} leaks) at ${b}`;let _=s.get(d.slice(0,f).join(`
`)),I=ze([..._].map(g=>i(g)[f]),g=>g);delete I[d[f]];for(let[g,S]of Object.entries(I))S&&p.unshift(`    - stacktraces of ${S.length} other leaks continue with ${g}`);p.unshift(b)}o+=`


==================== Leaking disposable ${l}/${r.length}: ${a.value.constructor.name} ====================
${p.join(`
`)}
============================================================

`}return r.length>e&&(o+=`


... and ${r.length-e} more leaking disposables

`),{leaks:r,details:o}}};function Vt(n){Y=n}if(Bt){let n="__is_disposable_tracked__";Vt(new class{trackDisposable(e){let t=new Error("Potentially leaked disposable").stack;setTimeout(()=>{e[n]||console.log(t)},3e3)}setParent(e,t){if(e&&e!==V.None)try{e[n]=!0}catch{}}markAsDisposed(e){if(e&&e!==V.None)try{e[n]=!0}catch{}}markAsSingleton(e){}})}function Qe(n){return Y?.trackDisposable(n),n}function Ye(n){Y?.markAsDisposed(n)}function he(n,e){Y?.setParent(n,e)}function Lt(n){if(pe.is(n)){let e=[];for(let t of n)if(t)try{t.dispose()}catch(r){e.push(r)}if(e.length===1)throw e[0];if(e.length>1)throw new AggregateError(e,"Encountered errors while disposing of store");return Array.isArray(n)?[]:n}else if(n)return n.dispose(),n}var Q=class n{constructor(){this._toDispose=new Set;this._isDisposed=!1;Qe(this)}static{this.DISABLE_DISPOSED_WARNING=!1}dispose(){this._isDisposed||(Ye(this),this._isDisposed=!0,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{Lt(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e||e===V.None)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return he(e,this),this._isDisposed?n.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}delete(e){if(e){if(e===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(e),e.dispose()}}deleteAndLeak(e){e&&this._toDispose.has(e)&&(this._toDispose.delete(e),he(e,null))}assertNotDisposed(){this._isDisposed&&q(new B("Object disposed"))}},V=class{constructor(){this._store=new Q;Qe(this),he(this._store,this)}static{this.None=Object.freeze({dispose(){}})}dispose(){Ye(this),this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};var L=typeof Buffer<"u",Pt=new H(()=>new Uint8Array(256)),be,Te,K=class n{static alloc(e){return L?new n(Buffer.allocUnsafe(e)):new n(new Uint8Array(e))}static wrap(e){return L&&!Buffer.isBuffer(e)&&(e=Buffer.from(e.buffer,e.byteOffset,e.byteLength)),new n(e)}static fromString(e,t){return!(t?.dontUseNodeBuffer||!1)&&L?new n(Buffer.from(e)):(be||(be=new TextEncoder),new n(be.encode(e)))}static fromByteArray(e){let t=n.alloc(e.length);for(let r=0,i=e.length;r<i;r++)t.buffer[r]=e[r];return t}static concat(e,t){if(typeof t>"u"){t=0;for(let s=0,o=e.length;s<o;s++)t+=e[s].byteLength}let r=n.alloc(t),i=0;for(let s=0,o=e.length;s<o;s++){let l=e[s];r.set(l,i),i+=l.byteLength}return r}static isNativeBuffer(e){return L&&Buffer.isBuffer(e)}constructor(e){this.buffer=e,this.byteLength=this.buffer.byteLength}clone(){let e=n.alloc(this.byteLength);return e.set(this),e}toString(){return L?this.buffer.toString():(Te||(Te=new TextDecoder),Te.decode(this.buffer))}slice(e,t){return new n(this.buffer.subarray(e,t))}set(e,t){if(e instanceof n)this.buffer.set(e.buffer,t);else if(e instanceof Uint8Array)this.buffer.set(e,t);else if(e instanceof ArrayBuffer)this.buffer.set(new Uint8Array(e),t);else if(ArrayBuffer.isView(e))this.buffer.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),t);else throw new Error("Unknown argument 'array'")}readUInt32BE(e){return Ut(this.buffer,e)}writeUInt32BE(e,t){Ot(this.buffer,e,t)}readUInt32LE(e){return Ft(this.buffer,e)}writeUInt32LE(e,t){Ct(this.buffer,e,t)}readUInt8(e){return jt(this.buffer,e)}writeUInt8(e,t){zt(this.buffer,e,t)}indexOf(e,t=0){return Nt(this.buffer,e instanceof n?e.buffer:e,t)}equals(e){return this===e?!0:this.byteLength!==e.byteLength?!1:this.buffer.every((t,r)=>t===e.buffer[r])}};function Nt(n,e,t=0){let r=e.byteLength,i=n.byteLength;if(r===0)return 0;if(r===1)return n.indexOf(e[0]);if(r>i-t)return-1;let s=Pt.value;s.fill(e.length);for(let d=0;d<e.length;d++)s[e[d]]=e.length-d-1;let o=t+e.length-1,l=o,a=-1;for(;o<i;)if(n[o]===e[l]){if(l===0){a=o;break}o--,l--}else o+=Math.max(e.length-l,s[n[o]]),l=e.length-1;return a}function Ut(n,e){return n[e]*2**24+n[e+1]*2**16+n[e+2]*2**8+n[e+3]}function Ot(n,e,t){n[t+3]=e,e=e>>>8,n[t+2]=e,e=e>>>8,n[t+1]=e,e=e>>>8,n[t]=e}function Ft(n,e){return n[e+0]<<0>>>0|n[e+1]<<8>>>0|n[e+2]<<16>>>0|n[e+3]<<24>>>0}function Ct(n,e,t){n[t+0]=e&255,e=e>>>8,n[t+1]=e&255,e=e>>>8,n[t+2]=e&255,e=e>>>8,n[t+3]=e&255}function jt(n,e){return n[e]}function zt(n,e,t){n[t]=e}function Ze(n,e){let t=0,r=0,i;do i=n.readUInt8(e+r),t|=(i&127)<<r*7,r++;while(i&128);return{value:t,consumed:r}}var tt=n=>{let e=(0,et.readFileSync)(n),t=new Map;for(let r=0;r<e.length;){let i=Ze(K.wrap(e),r);r+=i.consumed,t.set(e.subarray(r,r+i.value),t.size),r+=i.value}return t};var Z=class n{constructor(){this._values=[];this._stats={encodeDuration:new R,textLength:new R,callCount:0}}static get instance(){return this._instance||(this._instance=new n),this._instance}init(e,t,r){let i=this._values.length,s=r?tt:o=>o;return this._values.push((0,A.createTokenizer)(s(e),(0,A.getSpecialTokensByEncoder)(t),(0,A.getRegexByEncoder)(t),64e3)),i}encode(e,t,r){let i=G.create(!0),s=this._values[e].encode(t,r);return this._stats.callCount+=1,this._stats.encodeDuration.update(i.elapsed()),this._stats.textLength.update(t.length),s}destroy(e){this._values[e]=void 0}resetStats(){let e=this._stats,t={callCount:e.callCount,encodeDuration:e.encodeDuration.value,textLength:e.textLength.value};return this._stats.encodeDuration=new R,this._stats.textLength=new R,this._stats.callCount=0,t}};function $t(){let n=rt.parentPort;if(!n)throw new Error("This module should only be used in a worker thread.");n.on("message",async e=>{try{let t=await Z.instance[e.fn](...e.args);n.postMessage({id:e.id,res:t})}catch(t){n.postMessage({id:e.id,err:t})}})}$t();
//!!! DO NOT modify, this file was COPIED from 'microsoft/vscode'
