"use strict";exports.id=593,exports.ids=[593],exports.modules={1362:(e,s,o)=>{o.d(s,{fromSSO:()=>I});var t=o(68),n=o(70),r=o(1364),i=o(74),a=o(73),c=o(72);const l=e=>Object.entries(e).filter((([e])=>e.startsWith(a.I.SSO_SESSION+c.Q))).reduce(((e,[s,o])=>({...e,[s.substring(s.indexOf(c.Q)+1)]:o})),{});var f=o(76),g=o(77);const w=()=>({}),h=async(e={})=>(0,g.$H)(e.configFilepath??(0,i.g)()).then(f.A).then(l).catch(w);var d=o(43),p=o(69);class u extends p.m{name="TokenProviderError";constructor(e,s=!0){super(e,s),Object.setPrototypeOf(this,u.prototype)}}var S=o(1365);const C="To refresh this SSO session run 'aws sso login' with the corresponding profile.",y=async(e,s,t={})=>{const{CreateTokenCommand:n}=await o.e(364).then(o.bind(o,1375)),r=await(async(e,s={})=>{const{SSOOIDCClient:t}=await o.e(364).then(o.bind(o,1375));return new t(Object.assign({},s.clientConfig??{},{region:e??s.clientConfig?.region,logger:s.clientConfig?.logger??s.parentClientConfig?.logger}))})(s,t);return r.send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},k=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new u(`Token is expired. ${C}`,!1)},_=(e,s,o=!1)=>{if(void 0===s)throw new u(`Value not present for '${e}' in SSO Token${o?". Cannot refresh":""}. ${C}`,!1)};var m=o(1363),O=o(10);const{writeFile:x}=O.promises,T=new Date(0),N=(e={})=>async({callerClientConfig:s}={})=>{const o={...e,parentClientConfig:{...s,...e.parentClientConfig}};o.logger?.debug("@aws-sdk/token-providers - fromSso");const t=await(0,r.Y)(o),i=(0,n.Bz)({profile:o.profile??s?.profile}),a=t[i];if(!a)throw new u(`Profile '${i}' could not be found in shared credentials file.`,!1);if(!a.sso_session)throw new u(`Profile '${i}' is missing required property 'sso_session'.`);const c=a.sso_session,l=(await h(o))[c];if(!l)throw new u(`Sso session '${c}' could not be found in shared credentials file.`,!1);for(const e of["sso_start_url","sso_region"])if(!l[e])throw new u(`Sso session '${c}' is missing required property '${e}'.`,!1);l.sso_start_url;const f=l.sso_region;let g;try{g=await(0,S.v)(c)}catch(e){throw new u(`The SSO session token associated with profile=${i} was not found or is invalid. ${C}`,!1)}_("accessToken",g.accessToken),_("expiresAt",g.expiresAt);const{accessToken:w,expiresAt:d}=g,p={token:w,expiration:new Date(d)};if(p.expiration.getTime()-Date.now()>3e5)return p;if(Date.now()-T.getTime()<3e4)return k(p),p;_("clientId",g.clientId,!0),_("clientSecret",g.clientSecret,!0),_("refreshToken",g.refreshToken,!0);try{T.setTime(Date.now());const e=await y(g,f,o);_("accessToken",e.accessToken),_("expiresIn",e.expiresIn);const s=new Date(Date.now()+1e3*e.expiresIn);try{await((e,s)=>{const o=(0,m.C)(e),t=JSON.stringify(s,null,2);return x(o,t)})(c,{...g,accessToken:e.accessToken,expiresAt:s.toISOString(),refreshToken:e.refreshToken})}catch(e){}return{token:e.accessToken,expiration:s}}catch(e){return k(p),p}},$=!1,v=async({ssoStartUrl:e,ssoSession:s,ssoAccountId:n,ssoRegion:r,ssoRoleName:i,ssoClient:a,clientConfig:c,parentClientConfig:l,profile:f,filepath:g,configFilepath:w,ignoreCache:h,logger:p})=>{let u;const C="To refresh this SSO session run aws sso login with the corresponding profile.";if(s)try{const e=await N({profile:f,filepath:g,configFilepath:w,ignoreCache:h})();u={accessToken:e.token,expiresAt:new Date(e.expiration).toISOString()}}catch(e){throw new t.C(e.message,{tryNextLink:$,logger:p})}else try{u=await(0,S.v)(e)}catch(e){throw new t.C(`The SSO session associated with this profile is invalid. ${C}`,{tryNextLink:$,logger:p})}if(new Date(u.expiresAt).getTime()-Date.now()<=0)throw new t.C(`The SSO session associated with this profile has expired. ${C}`,{tryNextLink:$,logger:p});const{accessToken:y}=u,{SSOClient:k,GetRoleCredentialsCommand:_}=await o.e(616).then(o.bind(o,1371)),m=a||new k(Object.assign({},c??{},{logger:c?.logger??l?.logger,region:c?.region??r}));let O;try{O=await m.send(new _({accountId:n,roleName:i,accessToken:y}))}catch(e){throw new t.C(e,{tryNextLink:$,logger:p})}const{roleCredentials:{accessKeyId:x,secretAccessKey:T,sessionToken:v,expiration:I,credentialScope:D,accountId:R}={}}=O;if(!(x&&T&&v&&I))throw new t.C("SSO returns an invalid temporary credential.",{tryNextLink:$,logger:p});const A={accessKeyId:x,secretAccessKey:T,sessionToken:v,expiration:new Date(I),...D&&{credentialScope:D},...R&&{accountId:R}};return s?(0,d.g)(A,"CREDENTIALS_SSO","s"):(0,d.g)(A,"CREDENTIALS_SSO_LEGACY","u"),A},I=(e={})=>async({callerClientConfig:s}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:o,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoSession:l}=e,{ssoClient:f}=e,g=(0,n.Bz)({profile:e.profile??s?.profile});if(o||i||a||c||l){if(o&&i&&a&&c)return v({ssoStartUrl:o,ssoSession:l,ssoAccountId:i,ssoRegion:a,ssoRoleName:c,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger});throw new t.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger})}{const s=(await(0,r.Y)(e))[g];if(!s)throw new t.C(`Profile ${g} was not found.`,{logger:e.logger});if(!(w=s)||"string"!=typeof w.sso_start_url&&"string"!=typeof w.sso_account_id&&"string"!=typeof w.sso_session&&"string"!=typeof w.sso_region&&"string"!=typeof w.sso_role_name)throw new t.C(`Profile ${g} is not configured with SSO credentials.`,{logger:e.logger});if(s?.sso_session){const n=(await h(e))[s.sso_session],r=` configurations in profile ${g} and sso-session ${s.sso_session}`;if(a&&a!==n.sso_region)throw new t.C("Conflicting SSO region"+r,{tryNextLink:!1,logger:e.logger});if(o&&o!==n.sso_start_url)throw new t.C("Conflicting SSO start_url"+r,{tryNextLink:!1,logger:e.logger});s.sso_region=n.sso_region,s.sso_start_url=n.sso_start_url}const{sso_start_url:n,sso_account_id:i,sso_region:c,sso_role_name:l,sso_session:d}=((e,s)=>{const{sso_start_url:o,sso_account_id:n,sso_region:r,sso_role_name:i}=e;if(!(o&&n&&r&&i))throw new t.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}\nReference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:s});return e})(s,e.logger);return v({ssoStartUrl:n,ssoSession:d,ssoAccountId:i,ssoRegion:c,ssoRoleName:l,ssoClient:f,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}var w}},1363:(e,s,o)=>{o.d(s,{C:()=>i});var t=o(9),n=o(5),r=o(75);const i=e=>{const s=(0,t.createHash)("sha1").update(e).digest("hex");return(0,n.join)((0,r.R)(),".aws","sso","cache",`${s}.json`)}},1365:(e,s,o)=>{o.d(s,{a:()=>i,v:()=>a});var t=o(10),n=o(1363);const{readFile:r}=t.promises,i={},a=async e=>{if(i[e])return i[e];const s=(0,n.C)(e),o=await r(s,"utf8");return JSON.parse(o)}}};